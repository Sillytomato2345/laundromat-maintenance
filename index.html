<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maintenance Pro - Sprint 3 Complete</title>
  <style>
    .horizontal-scroll { overflow-x: auto; overflow-y: hidden; scroll-behavior: smooth; }
    .horizontal-scroll::-webkit-scrollbar { height: 8px; }
    .horizontal-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
    .horizontal-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 4px; }
    .horizontal-scroll::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.5); }
    @media print { .no-print { display: none !important; } }
  </style>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    // PDF.js worker configuration
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
  </script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useRef } = React;

// ========== PASTE YOUR CREDENTIALS HERE ==========
const CLIENT_ID = '591405706276-krboirruc2l2kest5eegk61ljt1gjnam.apps.googleusercontent.com';  // Should look like: 123456789-abc123.apps.googleusercontent.com
const API_KEY = 'AIzaSyB2hlF42e4PTsRk1f8egPUcL4MGwYSZgxs';      // Should look like: AIzaSyD...
// ==================================================

const DISCOVERY_DOCS = ['https://sheets.googleapis.com/$discovery/rest?version=v4', 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.appdata https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/userinfo.email';
const CONFIG_FILE_NAME = 'laundromat_pro_config.json';

// ========== USER ROLES CONFIGURATION - SPRINT 5 ==========
// Add your team members' emails and their roles here
const USER_ROLES = {
  'varneys.python@gmail.com': 'owner',  // ‚Üê PUT YOUR REAL EMAIL HERE
  // Example: 'yourname@gmail.com': 'owner',
  // Example: 'manager@company.com': 'manager',
  // Example: 'tech1@company.com': 'technician',
  // Example: 'accountant@cpa.com': 'viewer',
};

// Role definitions
const ROLES = {
  owner: {
    name: 'Owner',
    canView: true,
    canEdit: true,
    canDelete: true,
    canSeeCosts: true,
    canManageBackups: true,
    canExport: true,
    canSubmitRequests: true,
    canMarkOutOfOrder: true,
    canManageTeam: true,
    canAccessSettings: true,
    canAccessAllTabs: true,
    canViewRequests: true,
  },
  manager: {
    name: 'Manager',
    canView: true,
    canEdit: true,
    canDelete: false,
    canSeeCosts: true,
    canManageBackups: false,
    canExport: true,
    canSubmitRequests: true,
    canMarkOutOfOrder: true,
    canManageTeam: false,
    canAccessSettings: true,
    canAccessAllTabs: true,
    canViewRequests: true,
  },
  technician: {
    name: 'Technician',
    canView: true,
    canEdit: false,
    canDelete: false,
    canSeeCosts: false,
    canManageBackups: false,
    canExport: false,
    canSubmitRequests: true,
    canMarkOutOfOrder: true,
    canManageTeam: false,
    canAccessSettings: false,
    canAccessAllTabs: true,
    canViewRequests: true,
  },
  attendant: {
    name: 'Attendant',
    canView: true,
    canEdit: false,
    canDelete: false,
    canSeeCosts: false,
    canManageBackups: false,
    canExport: false,
    canSubmitRequests: true,
    canMarkOutOfOrder: false,
    canManageTeam: false,
    canAccessSettings: false,
    canAccessAllTabs: false,
    canViewRequests: true,
    dashboardOnly: true,
  },
  viewer: {
    name: 'Viewer',
    canView: true,
    canEdit: false,
    canDelete: false,
    canSeeCosts: true,
    canManageBackups: false,
    canExport: true,
    canSubmitRequests: false,
    canMarkOutOfOrder: false,
    canManageTeam: false,
    canAccessSettings: false,
    canAccessAllTabs: true,
    canViewRequests: true,
  },
};

// Team management configuration
const TEAM_CONFIG_FILE = 'MaintenanceApp_TeamConfig.json';

// Removal security configuration
const REMOVAL_CONFIG = {
  requireEmailVerification: true,
  waitingPeriodHours: 24,
  minimumOwners: 1,
};

// Maintenance request form settings
const DEFAULT_REQUEST_SETTINGS = {
  machineTypes: ['Washer', 'Dryer', 'Other'],
  problemTypes: [
    'Won\'t Start',
    'Not Heating',
    'Leaking Water',
    'Making Loud Noise',
    'Door Won\'t Close',
    'Not Spinning',
    'Error Code Displayed',
    'Out of Balance',
    'Not Draining',
    'Other'
  ],
  dryerLocations: ['Top', 'Bottom', 'Both'],
  notificationEmail: 'jonathan@varneyslaundercenter.com'
};

// ========================================================

// Icons
const Icon = ({ name, size = 20, className = '' }) => {
  const paths = {
    dashboard: "M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z",
    plus: "M12 5v14m-7-7h14", wrench: "M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z",
    calendar: "M3 4h18M3 4v16h18V4M16 2v4M8 2v4M3 10h18", search: "M11 19a8 8 0 1 0 0-16 8 8 0 0 0 0 16zM21 21l-4.35-4.35",
    edit: "M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z", trash: "M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",
    save: "M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z", x: "M18 6L6 18M6 6l12 12",
    refresh: "M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15",
    chart: "M18 20V10M12 20V4M6 20v-6", home: "M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z",
    alert: "M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0zM12 9v4M12 17h.01",
    image: "M3 3h18v18H3zM8.5 8.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zM21 15l-5-5-11 11",
    file: "M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9zM13 2v7h7",
    users: "M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M9 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75",
    package: "M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z",
    download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3",
    archive: "M21 8v13H3V8M1 3h22v5H1zM10 12h4",
    lock: "M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2zM7 11V7a5 5 0 0 1 10 0v4",
    unlock: "M19 11H5a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2zM7 11V7a5 5 0 0 1 9.9-1",
    shield: "M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z",
    clock: "M12 6v6l4 2M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z",
    check: "M20 6L9 17l-5-5",
    'chevron-right': "M9 18l6-6-6-6",
    'chevron-down': "M6 9l6 6 6-6",
    circle: "M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z",
    'check-circle': "M22 11.08V12a10 10 0 1 1-5.93-9.14M22 4L12 14.01l-3-3",
    layers: "M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5",
    'file-text': "M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8zM14 2v6h6M16 13H8M16 17H8M10 9H8",
    settings: "M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z",
    database: "M12 2C8 2 4 3 4 5v14c0 2 4 3 8 3s8-1 8-3V5c0-2-4-3-8-3zM4 9c0 2 4 3 8 3s8-1 8-3M4 14c0 2 4 3 8 3s8-1 8-3",
    info: "M12 16v-4M12 8h.01M22 12c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2s10 4.477 10 10z",
    'trash-2': "M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6",
  };
  return <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d={paths[name]} /></svg>;
};

// Utilities
// Format date for display (avoids timezone issues)
const formatDate = (dateString) => {
  if (!dateString) return '';
  // Don't use Date constructor - it causes timezone shifts
  // Input: "2026-01-09" Output: "2026-01-09"
  return dateString;
};

// Format date with slashes for display
const formatDateSlash = (dateString) => {
  if (!dateString) return '';
  const [year, month, day] = dateString.split('-');
  return `${month}/${day}/${year}`;
};

const getTodayLocal = () => {
  const today = new Date();
  const year = today.getFullYear();
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

const calculateAge = (purchaseDate) => {
  if (!purchaseDate) return null;
  return (new Date() - new Date(purchaseDate)) / (1000 * 60 * 60 * 24 * 365);
};

/* Validation helpers - Simplified in Sprint 4.1
const validateDate = (date, maxDate = new Date()) => {
  const d = new Date(date);
  if (isNaN(d.getTime())) return { valid: false, error: 'Invalid date' };
  if (d > maxDate) return { valid: false, error: 'Date cannot be in the future' };
  return { valid: true };
};

const validateNumber = (value, min = 0, max = Infinity, fieldName = 'Value') => {
  // Allow empty string (optional field)
  if (value === '' || value === null || value === undefined) {
    return { valid: true };
  }
  const num = parseFloat(value);
  if (isNaN(num)) return { valid: false, error: `${fieldName} must be a number` };
  if (num < min) return { valid: false, error: `${fieldName} must be at least ${min}` };
  if (num > max) return { valid: false, error: `${fieldName} cannot exceed ${max}` };
  return { valid: true };
};

const validateRequired = (value, fieldName = 'Field') => {
  if (!value || value.toString().trim() === '') {
    return { valid: false, error: `${fieldName} is required` };
  }
  return { valid: true };
};

const validateWarrantyDates = (startDate, endDate) => {
  const start = new Date(startDate);
  const end = new Date(endDate);
  if (end <= start) {
    return { valid: false, error: 'End date must be after start date' };
  }
  return { valid: true };
};

const getWarningIfHigh = (value, threshold, message) => {
  const num = parseFloat(value);
  if (!isNaN(num) && num > threshold) {
    return { warning: true, message };
  }
  return { warning: false };
};
*/

const calculateROI = (machine, logs) => {
  const age = calculateAge(machine.purchaseDate);
  if (!age) return null;
  
  const machineLogs = logs.filter(l => l.machineId === machine.id && !l.warranty);
  const totalCost = machineLogs.reduce((s, l) => s + parseFloat(l.cost || 0), 0);
  
  // For very young machines (< 1 year), use actual age or minimum 1 year to avoid inflated numbers
  const yearsForCalculation = Math.max(age, 1);
  const annualCost = totalCost / yearsForCalculation;
  
  // Use actual purchase price if available, otherwise estimated replacement cost
  const replacementCost = machine.purchasePrice ? parseFloat(machine.purchasePrice) : (machine.type === 'Dryer' ? 1200 : 1500);
  
  // Recommendation logic:
  // Replace if: (annual repair cost > 30% of replacement cost) OR (total repairs > 50% of replacement cost AND age > 5 years)
  const shouldReplace = (annualCost > replacementCost * 0.3) || (totalCost > replacementCost * 0.5 && age > 5);
  
  return { 
    totalCost, 
    annualCost, 
    age, 
    replacementCost,
    recommendation: shouldReplace ? 'REPLACE' : 'MAINTAIN'
  };
};

const exportToCSV = (data, filename) => {
  if (data.length === 0) return;
  const headers = Object.keys(data[0]);
  const csv = [headers.join(','), ...data.map(row => headers.map(h => JSON.stringify(row[h] || '')).join(','))].join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
};

// PDF Receipt Parser - FIXED FOR ACTUAL FORMAT
const parseReceiptText = (text) => {
  const items = [];
  const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
  
  console.log('Parser processing', lines.length, 'lines');
  console.log('First 30 lines:');
  lines.slice(0, 30).forEach((l, i) => console.log(`  ${i}: "${l}"`));
  console.log('\nLines 30-50 (item section):');
  lines.slice(30, 50).forEach((l, i) => console.log(`  ${i+30}: "${l}"`));
  console.log(''); // blank line
  
  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];
    
    // Skip header lines
    if (line.includes('ORDER INVOICE') || line.includes('Sold to') || 
        line.includes('Ship to') || line.includes('Payment Method') || 
        line.includes('Qty Product Price Tax') || line.includes('Customer Service') ||
        line.includes('Subtotal') || line.includes('Tax') || line.includes('Total')) {
      continue;
    }
    
    // Pattern 0: Multi-line format (check FIRST before others)
    // Line i-1: "Hose Washers" (name)
    // Line i: "SKU : GSW300"
    // Line i+1: "1 $8.95"
    if (line.match(/^SKU\s*:\s*([A-Z0-9-]+)$/i) && i > 0 && i + 1 < lines.length) {
      console.log(`üîç Pattern 0 triggered at line ${i}: "${line}"`);
      
      const skuMatch = line.match(/^SKU\s*:\s*([A-Z0-9-]+)$/i);
      const sku = skuMatch[1];
      const prevLine = lines[i - 1].trim();
      const nextLine = lines[i + 1];
      
      console.log(`  Prev line (line ${i-1}): "${prevLine}"`);
      console.log(`  SKU: "${sku}"`);
      console.log(`  Next line (line ${i+1}): "${nextLine}"`);
      
      // Pattern 0.5: Name + Qty + Price on PREVIOUS line
      // "Hose Washers 1  $8.95"
      // BUT: Previous line must NOT start with a SKU (avoid duplicate with Pattern 1)
      const prevLineMatch = prevLine.match(/^(.+?)\s+(\d+)\s+\$\s*(\d+\.?\d*)$/);
      
      // Check if previous line starts with a SKU pattern (alphanumeric-dash combo)
      const prevLineStartsWithSKU = prevLine.match(/^[A-Z0-9][A-Z0-9-]{3,}\s/);
      
      if (prevLineMatch && !prevLineStartsWithSKU) {
        const name = prevLineMatch[1].trim();
        const qty = parseInt(prevLineMatch[2]);
        const price = parseFloat(prevLineMatch[3]);
        
        console.log(`  ‚úì Pattern 0.5: Name+Qty+Price on prev line (name-only format): name="${name}", qty=${qty}, price=${price}`);
        
        // Check if SKU already found
        if (items.some(item => item.sku === sku)) {
          console.log(`  ‚úó Pattern 0.5: SKU ${sku} already found, skipping duplicate`);
        } else if (name && name.length > 2 && price > 0 && !name.match(/^(Order|Payment|Shipping|Items|Thank)/i)) {
          items.push({ sku, name, qty, price });
          console.log('‚úì‚úì Pattern 0.5 match (name-only with qty+price):', { sku, name, qty, price });
          continue;
        } else {
          console.log(`  ‚úó Pattern 0.5 rejected: name.length=${name.length}, price=${price}, filter=${!!name.match(/^(Order|Payment|Shipping|Items|Thank)/i)}`);
        }
      } else if (prevLineMatch && prevLineStartsWithSKU) {
        console.log(`  ‚úó Pattern 0.5: Prev line starts with SKU, skipping (will be caught by Pattern 1)`);
      }
      
      // Pattern 0: Qty + Price on NEXT line
      const qtyPriceMatch = nextLine.match(/^(\d+)\s+\$\s*(\d+\.?\d*)$/);
      
      if (qtyPriceMatch) {
        const name = prevLine;
        console.log(`  ‚úì Qty/Price matched on next line: qty=${qtyPriceMatch[1]}, price=${qtyPriceMatch[2]}`);
        
        // Check if SKU already found
        if (items.some(item => item.sku === sku)) {
          console.log(`  ‚úó Pattern 0: SKU ${sku} already found, skipping duplicate`);
        } else if (name && name.length > 2) {
          const qty = parseInt(qtyPriceMatch[1]);
          const price = parseFloat(qtyPriceMatch[2]);
          
          console.log(`  Checking: price=${price}, name.length=${name.length}`);
          console.log(`  Name filter test:`, name.match(/^(Order|Payment|Shipping|Items|Thank)/i));
          
          if (price > 0 && !name.match(/^(Order|Payment|Shipping|Items|Thank)/i)) {
            items.push({ sku, name, qty, price });
            console.log('‚úì Pattern 0 match (multi-line):', { sku, name, qty, price });
            i += 1; // Skip next line since we processed it
            continue;
          } else {
            console.log(`  ‚úó Rejected: price=${price}, filter matched=${!!name.match(/^(Order|Payment|Shipping|Items|Thank)/i)}`);
          }
        } else {
          console.log(`  ‚úó Name too short or empty: length=${name.length}`);
        }
      } else {
        console.log(`  ‚úó Next line didn't match qty/price pattern`);
      }
    }
    
    // Pattern 1: Gold Coin - Most flexible
    // SKU can be: 9576-203-002, 123456, AB-1234, etc.
    // Format: "SKU Description Qty $Price"
    const pattern1 = line.match(/^([A-Z0-9][A-Z0-9-]{3,})\s+(.+?)\s+(\d+)\s+\$\s*(\d+(?:\.\d{2})?)(?:\s+\$\s*\d+(?:\.\d{2})?)?$/);
    
    if (pattern1) {
      const sku = pattern1[1];
      const name = pattern1[2].trim();
      const qty = parseInt(pattern1[3]);
      const price = parseFloat(pattern1[4]);
      
      if (items.some(item => item.sku === sku)) {
        // SKU already found, skip
        continue;
      }
      
      if (name && price > 0 && name.length > 3 && !name.match(/^(Total|Tax|Subtotal)/i)) {
        items.push({ sku, name, qty, price });
        console.log('‚úì Pattern 1 match:', { sku, name, qty, price });
        continue;
      }
    }
    
    // Pattern 2: Laundry Owners - Qty first, then SKU
    // Format: "1 9376-331-001 Description $485.12 $0.00"
    // More flexible - SKU can be various formats
    const pattern2 = line.match(/^(\d+)\s+([A-Z0-9][A-Z0-9-]{3,})\s+(.+?)\s+\$\s*(\d+(?:\.\d{2})?)(?:\s+\$\s*\d+(?:\.\d{2})?)?$/);
    
    if (pattern2) {
      const qty = parseInt(pattern2[1]);
      const sku = pattern2[2];
      let name = pattern2[3].trim();
      const price = parseFloat(pattern2[4]);
      
      if (items.some(item => item.sku === sku)) {
        continue; // SKU already found
      }
      
      // Clean name - remove duplicate SKU if present
      name = name.replace(new RegExp(`^${sku}\\s*-?\\s*`), '').trim();
      // Remove "Replaces Part" notes
      name = name.replace(/\s*\|\s*Replaces Part.+$/, '').trim();
      
      if (name && price > 0 && name.length > 3 && !name.match(/^(Total|Tax|Subtotal)/i)) {
        items.push({ sku, name, qty, price });
        console.log('‚úì Pattern 2 match:', { sku, name, qty, price });
        continue;
      }
    }
    
    // Pattern 3: Catch items with just numbers as SKU
    // Some parts might be "1234567 Description 2 $10.00"
    const pattern3 = line.match(/^(\d{4,10})\s+(.+?)\s+(\d+)\s+\$?\s*(\d+\.\d{2})$/);
    
    if (pattern3) {
      const sku = pattern3[1];
      const name = pattern3[2].trim();
      const qty = parseInt(pattern3[3]);
      const price = parseFloat(pattern3[4]);
      
      if (items.some(item => item.sku === sku)) {
        continue; // SKU already found
      }
      
      if (name && price > 0 && name.length > 3 && !name.match(/^(Total|Tax|Subtotal)/i)) {
        items.push({ sku, name, qty, price });
        console.log('‚úì Pattern 3 match:', { sku, name, qty, price });
        continue;
      }
    }
    
    // Pattern 4: Qty first with numeric SKU
    // "1 12345678 Description $100.00"
    const pattern4 = line.match(/^(\d+)\s+(\d{5,10})\s+(.+?)\s+\$\s*(\d+(?:\.\d{2})?)$/);
    
    if (pattern4) {
      const qty = parseInt(pattern4[1]);
      const sku = pattern4[2];
      let name = pattern4[3].trim();
      const price = parseFloat(pattern4[4]);
      
      if (items.some(item => item.sku === sku)) {
        continue; // SKU already found
      }
      
      name = name.replace(/\s*\|\s*Replaces Part.+$/, '').trim();
      
      if (name && price > 0 && name.length > 3) {
        items.push({ sku, name, qty, price });
        console.log('‚úì Pattern 4 match:', { sku, name, qty, price });
        continue;
      }
    }
    
    // Pattern 5: Laundry Owners with duplicate SKU
    // "9376-331-001 9376-331-001 - Motor St30 Mara - Dexter | $485.12 $0.00"
    // Format: SKU SKU - Description | $Price $Tax
    const pattern5 = line.match(/^([A-Z0-9][A-Z0-9-]{3,})\s+\1\s+-\s+(.+?)\s+\|\s+\$\s*(\d+(?:\.\d{2})?)(?:\s+\$\s*\d+(?:\.\d{2})?)?$/);
    
    if (pattern5) {
      const sku = pattern5[1];
      let name = pattern5[2].trim();
      const price = parseFloat(pattern5[3]);
      const qty = 1; // Default to 1 if not specified
      
      if (items.some(item => item.sku === sku)) {
        continue; // SKU already found
      }
      
      // Clean name - remove any remaining SKU references
      name = name.replace(new RegExp(sku, 'g'), '').trim();
      name = name.replace(/^-\s*/, '').trim();
      
      if (name && price > 0 && name.length > 3) {
        items.push({ sku, name, qty, price });
        console.log('‚úì Pattern 5 match (Laundry Owners duplicate SKU):', { sku, name, qty, price });
        continue;
      }
    }
    
    // Pattern 6: Laundry Owners with quantity prefix
    // "1 9376-331-001 9376-331-001 - Motor St30 Mara - Dexter | $485.12 $0.00"
    const pattern6 = line.match(/^(\d+)\s+([A-Z0-9][A-Z0-9-]{3,})\s+\2\s+-\s+(.+?)\s+\|\s+\$\s*(\d+(?:\.\d{2})?)(?:\s+\$\s*\d+(?:\.\d{2})?)?$/);
    
    if (pattern6) {
      const qty = parseInt(pattern6[1]);
      const sku = pattern6[2];
      let name = pattern6[3].trim();
      const price = parseFloat(pattern6[4]);
      
      if (items.some(item => item.sku === sku)) {
        continue; // SKU already found
      }
      
      // Clean name
      name = name.replace(new RegExp(sku, 'g'), '').trim();
      name = name.replace(/^-\s*/, '').trim();
      
      if (name && price > 0 && name.length > 3) {
        items.push({ sku, name, qty, price });
        console.log('‚úì Pattern 6 match (Laundry Owners with qty):', { sku, name, qty, price });
        continue;
      }
    }
    
    // Pattern 7: Very flexible - any line with SKU-like string, description, and price
    // Catches oddly formatted lines
    const pattern7 = line.match(/([A-Z0-9-]{4,})\s+(.+?)\s+(\d+)\s*\$?\s*(\d+\.?\d*)$/);
    
    if (pattern7 && !items.some(item => item.sku === pattern7[1])) { // Avoid duplicates
      const sku = pattern7[1];
      const name = pattern7[2].trim();
      const qty = parseInt(pattern7[3]);
      const price = parseFloat(pattern7[4]);
      
      if (name && price > 0 && name.length > 3 && !name.match(/^(Total|Tax|Subtotal|Customer|Service|Payment|Order)/i)) {
        items.push({ sku, name, qty, price });
        console.log('‚úì Pattern 7 match (flexible):', { sku, name, qty, price });
        continue;
      }
    }
    
    // Log lines that might be items but didn't match
    if (line.match(/[A-Z0-9-]{4,}/) && line.match(/\$\s*\d+/) && line.length < 150 && line.length > 10) {
      console.log('‚ö† Possible item but no match:', line);
    }
  }
  
  console.log('Parser found', items.length, 'total items');
  return items;
};

// Fuzzy match part names
const fuzzyMatch = (search, target) => {
  search = search.toLowerCase().replace(/[^a-z0-9]/g, '');
  target = target.toLowerCase().replace(/[^a-z0-9]/g, '');
  
  // Exact match
  if (search === target) return 100;
  
  // Contains match
  if (target.includes(search)) return 80;
  if (search.includes(target)) return 80;
  
  // SKU match
  const searchTokens = search.split(/[-\s]+/);
  const targetTokens = target.split(/[-\s]+/);
  let matches = 0;
  searchTokens.forEach(st => {
    if (targetTokens.some(tt => tt.includes(st) || st.includes(tt))) {
      matches++;
    }
  });
  return (matches / Math.max(searchTokens.length, targetTokens.length)) * 60;
};

// ============================================================================
// TEAM MANAGEMENT & ENHANCED REQUEST SYSTEM FUNCTIONS
// ============================================================================

// === SHARED CONFIG MANAGEMENT ===

const createInitialTeamConfig = (ownerEmail) => {
  return {
    version: '1.0',
    foundingOwner: ownerEmail,
    foundingDate: new Date().toISOString(),
    sharedSpreadsheetId: null,
    teamMembers: [
      {
        email: ownerEmail,
        role: 'owner',
        isFounder: true,
        addedDate: new Date().toISOString(),
        addedBy: ownerEmail
      }
    ],
    requestSettings: {
      machineTypes: DEFAULT_REQUEST_SETTINGS.machineTypes,
      problemTypes: DEFAULT_REQUEST_SETTINGS.problemTypes,
      dryerLocations: DEFAULT_REQUEST_SETTINGS.dryerLocations,
      notificationEmail: DEFAULT_REQUEST_SETTINGS.notificationEmail
    },
    pendingRemovals: [],
    removalLog: [],
    lastUpdated: new Date().toISOString(),
    updatedBy: ownerEmail
  };
};

// Helper function to get spreadsheet ID from URL or localStorage
const getSpreadsheetIdFromUrl = () => {
  // 1. Check global variable (set by loadAllData)
  if (window.currentSpreadsheetId) {
    console.log('‚úì Spreadsheet ID from global variable:', window.currentSpreadsheetId);
    return window.currentSpreadsheetId;
  }
  
  // 2. Try to get from URL
  const url = window.location.href;
  const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  if (match) {
    console.log('‚úì Spreadsheet ID from URL:', match[1]);
    window.currentSpreadsheetId = match[1];
    return match[1];
  }
  
  // 3. Try to get from localStorage
  const stored = localStorage.getItem('spreadsheetId');
  if (stored) {
    console.log('‚úì Spreadsheet ID from localStorage:', stored);
    window.currentSpreadsheetId = stored;
    return stored;
  }
  
  // 4. No spreadsheet ID found
  console.log('‚ö†Ô∏è No spreadsheet ID found');
  return null;
};

// SPREADSHEET-BASED CONFIG - Saves to hidden sheets in the main spreadsheet
const saveSharedConfig = async (config) => {
  try {
    const spreadsheetId = config.sharedSpreadsheetId || getSpreadsheetIdFromUrl();
    if (!spreadsheetId) {
      console.error('‚ùå No spreadsheet ID available');
      return false;
    }
    
    // This is a wrapper function that delegates to specific save functions
    // The actual saving is done by the component-specific functions below
    console.log('‚úÖ Config save initiated (delegated to specific functions)');
    return true;
  } catch (err) {
    console.error('‚ùå Error in saveSharedConfig:', err);
    return false;
  }
};

// SPREADSHEET-BASED CONFIG - Loads from hidden sheets in the main spreadsheet
const loadSharedConfig = async (providedSpreadsheetId = null) => {
  try {
    const spreadsheetId = providedSpreadsheetId || getSpreadsheetIdFromUrl();
    if (!spreadsheetId) {
      console.log('‚ÑπÔ∏è No spreadsheet loaded yet');
      return null;
    }
    
    console.log('üìä Loading team config from spreadsheet:', spreadsheetId);
    
    // Load team members from _TeamConfig sheet
    let teamMembers = [];
    try {
      const teamResponse = await window.gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId,
        range: '_TeamConfig!A2:E100',
      });
      
      const teamRows = teamResponse.result.values || [];
      teamMembers = teamRows.map(row => ({
        email: row[0],
        role: row[1],
        addedDate: row[2],
        addedBy: row[3],
        isFounder: row[4] === 'TRUE'
      })).filter(m => m.email);
    } catch (err) {
      console.log('‚ÑπÔ∏è _TeamConfig sheet not found or empty');
    }
    
    // Load request settings from _RequestSettings sheet
    let requestSettings = {
      machineTypes: ['Washer', 'Dryer', 'Other'],
      problemTypes: ['Won\'t Start', 'Not Heating', 'Leaking Water', 'Making Loud Noise', 'Door Won\'t Close', 'Not Spinning', 'Error Code Displayed', 'Out of Balance', 'Not Draining', 'Other'],
      dryerLocations: ['Top', 'Bottom', 'Both'],
      notificationEmail: 'jonathan@varneyslaundercenter.com'
    };
    
    try {
      const settingsResponse = await window.gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId,
        range: '_RequestSettings!A2:B100',
      });
      
      const settingsRows = settingsResponse.result.values || [];
      requestSettings.machineTypes = [];
      requestSettings.problemTypes = [];
      
      settingsRows.forEach(row => {
        const type = row[0];
        const value = row[1];
        
        if (type === 'machineType') requestSettings.machineTypes.push(value);
        else if (type === 'problemType') requestSettings.problemTypes.push(value);
        else if (type === 'notificationEmail') requestSettings.notificationEmail = value;
      });
    } catch (err) {
      console.log('‚ÑπÔ∏è _RequestSettings sheet not found, using defaults');
    }
    
    // Load general config
    let foundingOwner = null;
    let foundingDate = null;
    
    try {
      const configResponse = await window.gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId,
        range: '_Config!A2:B10',
      });
      
      const configRows = configResponse.result.values || [];
      configRows.forEach(row => {
        if (row[0] === 'foundingOwner') foundingOwner = row[1];
        if (row[0] === 'foundingDate') foundingDate = row[1];
      });
    } catch (err) {
      console.log('‚ÑπÔ∏è _Config sheet not found');
    }
    
    if (teamMembers.length === 0) {
      console.log('‚ÑπÔ∏è No team config found in spreadsheet');
      return null;
    }
    
    console.log('‚úÖ Team config loaded from spreadsheet');
    console.log('   Team members:', teamMembers.length);
    
    return {
      version: '2.0',
      source: 'spreadsheet',
      foundingOwner,
      foundingDate,
      sharedSpreadsheetId: spreadsheetId,
      teamMembers,
      requestSettings,
      pendingRemovals: [],
      removalLog: []
    };
    
  } catch (err) {
    console.error('‚ùå Error loading config from spreadsheet:', err);
    return null;
  }
};

// === SPREADSHEET HELPER FUNCTIONS ===

const initializeConfigSheets = async (spreadsheetId, foundingOwner) => {
  try {
    console.log('üîß Initializing config sheets...');
    
    const spreadsheet = await window.gapi.client.sheets.spreadsheets.get({ spreadsheetId });
    const existingSheets = spreadsheet.result.sheets.map(s => s.properties.title);
    const requests = [];
    
    // Create sheets if they don't exist
    if (!existingSheets.includes('_TeamConfig')) {
      requests.push({
        addSheet: {
          properties: { title: '_TeamConfig', hidden: true, gridProperties: { frozenRowCount: 1 } }
        }
      });
    }
    
    if (!existingSheets.includes('_RequestSettings')) {
      requests.push({
        addSheet: {
          properties: { title: '_RequestSettings', hidden: true, gridProperties: { frozenRowCount: 1 } }
        }
      });
    }
    
    if (!existingSheets.includes('_Config')) {
      requests.push({
        addSheet: {
          properties: { title: '_Config', hidden: true, gridProperties: { frozenRowCount: 1 } }
        }
      });
    }
    
    if (requests.length > 0) {
      await window.gapi.client.sheets.spreadsheets.batchUpdate({
        spreadsheetId,
        resource: { requests }
      });
    }
    
    // Initialize data
    const updates = [];
    
    // Team Config
    updates.push({
      range: '_TeamConfig!A1:E1',
      values: [['email', 'role', 'addedDate', 'addedBy', 'isFounder']]
    });
    updates.push({
      range: '_TeamConfig!A2:E2',
      values: [[foundingOwner, 'owner', new Date().toISOString().split('T')[0], 'system', 'TRUE']]
    });
    
    // Request Settings
    updates.push({
      range: '_RequestSettings!A1:B1',
      values: [['type', 'value']]
    });
    updates.push({
      range: '_RequestSettings!A2:B15',
      values: [
        ['machineType', 'Washer'], ['machineType', 'Dryer'], ['machineType', 'Other'],
        ['problemType', 'Won\'t Start'], ['problemType', 'Not Heating'], ['problemType', 'Leaking Water'],
        ['problemType', 'Making Loud Noise'], ['problemType', 'Door Won\'t Close'], ['problemType', 'Not Spinning'],
        ['problemType', 'Error Code Displayed'], ['problemType', 'Out of Balance'], ['problemType', 'Not Draining'],
        ['problemType', 'Other'], ['notificationEmail', 'jonathan@varneyslaundercenter.com']
      ]
    });
    
    // Config
    updates.push({
      range: '_Config!A1:B1',
      values: [['key', 'value']]
    });
    updates.push({
      range: '_Config!A2:B3',
      values: [['foundingOwner', foundingOwner], ['foundingDate', new Date().toISOString().split('T')[0]]]
    });
    
    await window.gapi.client.sheets.spreadsheets.values.batchUpdate({
      spreadsheetId,
      resource: { valueInputOption: 'USER_ENTERED', data: updates }
    });
    
    console.log('‚úÖ Config sheets initialized');
    return true;
  } catch (err) {
    console.error('‚ùå Error initializing config sheets:', err);
    return false;
  }
};

const saveTeamMemberToSheet = async (spreadsheetId, member) => {
  try {
    await window.gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId,
      range: '_TeamConfig!A:E',
      valueInputOption: 'USER_ENTERED',
      resource: {
        values: [[member.email, member.role, member.addedDate, member.addedBy, member.isFounder ? 'TRUE' : 'FALSE']]
      }
    });
    console.log('‚úÖ Team member saved');
    return true;
  } catch (err) {
    console.error('‚ùå Error saving team member:', err);
    return false;
  }
};

const updateTeamMemberRole = async (spreadsheetId, email, newRole) => {
  try {
    const response = await window.gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId,
      range: '_TeamConfig!A2:E100',
    });
    
    const rows = response.result.values || [];
    const rowIndex = rows.findIndex(row => row[0] === email);
    
    if (rowIndex === -1) return false;
    
    const actualRow = rowIndex + 2;
    await window.gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId,
      range: `_TeamConfig!B${actualRow}`,
      valueInputOption: 'USER_ENTERED',
      resource: { values: [[newRole]] }
    });
    
    console.log('‚úÖ Role updated');
    return true;
  } catch (err) {
    console.error('‚ùå Error updating role:', err);
    return false;
  }
};

const removeTeamMemberFromSheet = async (spreadsheetId, email) => {
  try {
    const response = await window.gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId,
      range: '_TeamConfig!A2:E100',
    });
    
    const rows = response.result.values || [];
    const rowIndex = rows.findIndex(row => row[0] === email);
    
    if (rowIndex === -1) return false;
    
    const actualRow = rowIndex + 2;
    await window.gapi.client.sheets.spreadsheets.values.clear({
      spreadsheetId,
      range: `_TeamConfig!A${actualRow}:E${actualRow}`,
    });
    
    console.log('‚úÖ Team member removed');
    return true;
  } catch (err) {
    console.error('‚ùå Error removing team member:', err);
    return false;
  }
};

const saveRequestSettingsToSheet = async (spreadsheetId, settings) => {
  try {
    await window.gapi.client.sheets.spreadsheets.values.clear({
      spreadsheetId,
      range: '_RequestSettings!A2:B100',
    });
    
    const values = [];
    settings.machineTypes.forEach(type => values.push(['machineType', type]));
    settings.problemTypes.forEach(type => values.push(['problemType', type]));
    values.push(['notificationEmail', settings.notificationEmail]);
    
    await window.gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId,
      range: '_RequestSettings!A2:B',
      valueInputOption: 'USER_ENTERED',
      resource: { values }
    });
    
    console.log('‚úÖ Settings saved');
    return true;
  } catch (err) {
    console.error('‚ùå Error saving settings:', err);
    return false;
  }
};

// === EMAIL VERIFICATION SYSTEM ===

const sendVerificationCode = async (email, purpose) => {
  const code = Math.floor(100000 + Math.random() * 900000);
  const expires = Date.now() + (10 * 60 * 1000);
  
  const verification = {
    email,
    code,
    expires,
    purpose,
    created: Date.now()
  };
  
  localStorage.setItem(`verification_${email}`, JSON.stringify(verification));
  
  console.log('üìß VERIFICATION CODE:', code);
  console.log('üìß Send this to:', email);
  
  alert(
    `üìß VERIFICATION CODE (Development Mode)\n\n` +
    `In production, this would be emailed to:\n${email}\n\n` +
    `Your code is: ${code}\n\n` +
    `Code expires in 10 minutes.`
  );
  
  return true;
};

const verifyCode = async (email, enteredCode) => {
  const stored = localStorage.getItem(`verification_${email}`);
  
  if (!stored) {
    return { valid: false, message: 'No verification found. Please request a new code.' };
  }
  
  const verification = JSON.parse(stored);
  
  if (Date.now() > verification.expires) {
    localStorage.removeItem(`verification_${email}`);
    return { valid: false, message: 'Code expired. Please request a new code.' };
  }
  
  if (parseInt(enteredCode) !== verification.code) {
    return { valid: false, message: 'Incorrect code. Please try again.' };
  }
  
  localStorage.removeItem(`verification_${email}`);
  return { valid: true, message: 'Code verified successfully' };
};

// === WAITING PERIOD SYSTEM ===

const startRemovalWaitingPeriod = async (config, email, initiatedBy) => {
  const waitingPeriod = {
    targetEmail: email,
    initiatedBy: initiatedBy,
    initiatedAt: Date.now(),
    expiresAt: Date.now() + (REMOVAL_CONFIG.waitingPeriodHours * 60 * 60 * 1000),
    status: 'pending',
    canCancelUntil: Date.now() + (REMOVAL_CONFIG.waitingPeriodHours * 60 * 60 * 1000)
  };
  
  config.pendingRemovals = config.pendingRemovals || [];
  config.pendingRemovals.push(waitingPeriod);
  
  await saveSharedConfig(config);
  
  return waitingPeriod;
};

const cancelRemovalWaitingPeriod = async (config, email) => {
  config.pendingRemovals = config.pendingRemovals.filter(p => p.targetEmail !== email);
  await saveSharedConfig(config);
};

const checkWaitingPeriodExpired = (pendingRemoval) => {
  return Date.now() >= pendingRemoval.expiresAt;
};

const getTimeRemaining = (pendingRemoval) => {
  const remaining = pendingRemoval.expiresAt - Date.now();
  if (remaining <= 0) return 'Expired';
  
  const hours = Math.floor(remaining / (1000 * 60 * 60));
  const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
  
  return `${hours}h ${minutes}m`;
};

// === OWNER REMOVAL FUNCTIONS ===

const canRemoveOwner = (config, email) => {
  const ownerCount = config.teamMembers.filter(m => m.role === 'owner').length;
  
  if (ownerCount <= REMOVAL_CONFIG.minimumOwners) {
    return {
      allowed: false,
      reason: `Cannot remove the only owner. Add another owner first.`
    };
  }
  
  return { allowed: true };
};

const removeRegularMember = async (config, email, currentUser) => {
  const member = config.teamMembers.find(m => m.email === email);
  
  const confirmed = confirm(
    `Remove ${email}?\n\n` +
    `Role: ${member.role}\n\n` +
    `This will:\n` +
    `‚Ä¢ Remove them from the app\n` +
    `‚Ä¢ They will lose their assigned role\n` +
    `‚Ä¢ They can still access spreadsheet in Google Drive\n\n` +
    `Continue?`
  );
  
  if (!confirmed) return false;
  
  config.teamMembers = config.teamMembers.filter(m => m.email !== email);
  
  config.removalLog = config.removalLog || [];
  config.removalLog.push({
    removedEmail: email,
    removedRole: member.role,
    removedBy: currentUser,
    removedAt: new Date().toISOString(),
    type: 'regular'
  });
  
  await saveSharedConfig(config);
  
  alert(
    `‚úÖ ${email} removed\n\n` +
    `‚ö†Ô∏è Remember to also:\n` +
    `1. Unshare the spreadsheet in Google Drive\n` +
    `2. Remove them from any other shared resources`
  );
  
  return true;
};

const removeFoundingOwner = async (config, email, currentUser) => {
  const canRemove = canRemoveOwner(config, email);
  if (!canRemove.allowed) {
    alert(`‚ùå ${canRemove.reason}`);
    return false;
  }
  
  const existing = config.pendingRemovals?.find(p => p.targetEmail === email && p.status === 'pending');
  
  if (existing) {
    if (checkWaitingPeriodExpired(existing)) {
      return await completeFoundingOwnerRemoval(config, email, currentUser);
    } else {
      const remaining = getTimeRemaining(existing);
      const cancel = confirm(
        `‚è≥ REMOVAL IN PROGRESS\n\n` +
        `${email} removal is in the 24-hour waiting period.\n\n` +
        `Time remaining: ${remaining}\n\n` +
        `Do you want to CANCEL the removal?`
      );
      
      if (cancel) {
        await cancelRemovalWaitingPeriod(config, email);
        alert('‚úÖ Removal cancelled');
      }
      return false;
    }
  }
  
  const proceed = confirm(
    `‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è REMOVING FOUNDING OWNER ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è\n\n` +
    `You are about to remove: ${email}\n` +
    `This is the FOUNDING OWNER who created this app.\n\n` +
    `This process requires:\n` +
    `‚úì Email confirmation\n` +
    `‚úì Email verification code\n` +
    `‚úì Confirmation phrase\n` +
    `‚úì 24-hour waiting period\n\n` +
    `Current owners: ${config.teamMembers.filter(m => m.role === 'owner').length}\n` +
    `Will remain: ${config.teamMembers.filter(m => m.role === 'owner').length - 1}\n\n` +
    `Proceed to verification?`
  );
  
  if (!proceed) return false;
  
  const typedEmail = prompt(
    `üîê STEP 1: EMAIL CONFIRMATION\n\n` +
    `Type the founding owner's email exactly:\n\n` +
    `${email}`
  );
  
  if (typedEmail !== email) {
    alert('‚ùå Email does not match. Removal cancelled.');
    return false;
  }
  
  if (REMOVAL_CONFIG.requireEmailVerification) {
    await sendVerificationCode(email, 'remove_founding_owner');
    
    const code = prompt(
      `üîê STEP 2: EMAIL VERIFICATION\n\n` +
      `A 6-digit code has been sent to:\n${email}\n\n` +
      `Enter the code (expires in 10 minutes):`
    );
    
    if (!code) {
      alert('‚ùå Verification cancelled.');
      return false;
    }
    
    const verification = await verifyCode(email, code);
    if (!verification.valid) {
      alert(`‚ùå ${verification.message}`);
      return false;
    }
  }
  
  const phrase = prompt(
    `üîê STEP 3: CONFIRMATION PHRASE\n\n` +
    `Type this phrase exactly (case-sensitive):\n\n` +
    `REMOVE FOUNDER`
  );
  
  if (phrase !== 'REMOVE FOUNDER') {
    alert('‚ùå Incorrect phrase. Removal cancelled.');
    return false;
  }
  
  const finalConfirm = confirm(
    `üîê FINAL CONFIRMATION\n\n` +
    `All verification steps completed.\n\n` +
    `Starting 24-hour waiting period for:\n${email}\n\n` +
    `During this time:\n` +
    `‚Ä¢ The user will still have access\n` +
    `‚Ä¢ You can cancel the removal\n` +
    `‚Ä¢ After 24 hours, removal will be ready to complete\n\n` +
    `Start waiting period?`
  );
  
  if (!finalConfirm) {
    alert('‚ùå Removal cancelled.');
    return false;
  }
  
  const waitingPeriod = await startRemovalWaitingPeriod(config, email, currentUser);
  
  alert(
    `‚è≥ WAITING PERIOD STARTED\n\n` +
    `${email} removal is now in a 24-hour waiting period.\n\n` +
    `Expires: ${new Date(waitingPeriod.expiresAt).toLocaleString()}\n\n` +
    `You can cancel this removal anytime before expiration.\n` +
    `After 24 hours, return here to complete the removal.`
  );
  
  return false;
};

const completeFoundingOwnerRemoval = async (config, email, currentUser) => {
  const finalConfirm = confirm(
    `‚úÖ WAITING PERIOD COMPLETE\n\n` +
    `The 24-hour waiting period has expired.\n\n` +
    `Complete removal of:\n${email}\n\n` +
    `This action CANNOT be undone.\n\n` +
    `Complete removal now?`
  );
  
  if (!finalConfirm) return false;
  
  const member = config.teamMembers.find(m => m.email === email);
  
  config.teamMembers = config.teamMembers.filter(m => m.email !== email);
  config.pendingRemovals = config.pendingRemovals.filter(p => p.targetEmail !== email);
  
  config.removalLog = config.removalLog || [];
  config.removalLog.push({
    removedEmail: email,
    removedRole: member.role,
    isFounder: true,
    removedBy: currentUser,
    removedAt: new Date().toISOString(),
    waitingPeriodStarted: config.pendingRemovals.find(p => p.targetEmail === email)?.initiatedAt,
    type: 'founding_owner'
  });
  
  await saveSharedConfig(config);
  
  alert(
    `‚úÖ FOUNDING OWNER REMOVED\n\n` +
    `${email} has been permanently removed.\n\n` +
    `‚ö†Ô∏è IMPORTANT:\n` +
    `Also unshare the spreadsheet in Google Drive!`
  );
  
  return true;
};

// === EMAIL NOTIFICATION FOR MAINTENANCE REQUESTS ===

const sendMaintenanceRequestEmail = async (request, machineName) => {
  const config = await loadSharedConfig();
  const notificationEmail = config?.requestSettings?.notificationEmail || DEFAULT_REQUEST_SETTINGS.notificationEmail;
  
  const emailBody = `
NEW MAINTENANCE REQUEST

Machine: ${machineName}
Machine Type: ${request.machineType || 'Not specified'}
${request.machineType === 'Dryer' && request.dryerLocation ? `Location: ${request.dryerLocation}` : ''}
Problem Type: ${request.problemType || 'Not specified'}
Issue Details: ${request.issue}
Urgency: ${request.urgency}
Submitted By: ${request.submittedBy}
Date: ${new Date(request.submittedDate).toLocaleString()}
  `.trim();
  
  console.log('üìß EMAIL NOTIFICATION:');
  console.log('To:', notificationEmail);
  console.log('Subject: New Maintenance Request');
  console.log('Body:', emailBody);
  
  alert(
    `üìß EMAIL SENT (Development Mode)\n\n` +
    `In production, this would be emailed to:\n${notificationEmail}\n\n` +
    `Subject: New Maintenance Request\n\n` +
    `${emailBody}`
  );
  
  return true;
};

// ============================================================================
// END OF TEAM MANAGEMENT & ENHANCED REQUEST FUNCTIONS
// ============================================================================

// Main App
const App = () => {
  const [isSignedIn, setIsSignedIn] = useState(false);
  const [isInitializing, setIsInitializing] = useState(true);
  const [currentUser, setCurrentUser] = useState(null); // Sprint 5: User email
  const [userRole, setUserRole] = useState('viewer'); // Sprint 5: User role (default to viewer)
  const [roleLoading, setRoleLoading] = useState(true); // Sprint 5: Track if role is being detected
  const [spreadsheetId, setSpreadsheetId] = useState(null);
  const [folderId, setFolderId] = useState(null);
  const [folderStructure, setFolderStructure] = useState(null); // Stores subfolder IDs
  
  const [locations, setLocations] = useState([]);
  const [machines, setMachines] = useState([]);
  const [equipmentLogs, setEquipmentLogs] = useState([]);
  const [buildingLogs, setBuildingLogs] = useState([]);
  const [vendors, setVendors] = useState([]);
  const [parts, setParts] = useState([]);
  const [partsUsage, setPartsUsage] = useState([]);
  const [scheduledTasks, setScheduledTasks] = useState([]);
  const [maintenanceHistory, setMaintenanceHistory] = useState([]);
  const [warranties, setWarranties] = useState([]);
  const [machineNotes, setMachineNotes] = useState([]);
  const [maintenanceRequests, setMaintenanceRequests] = useState([]); // Sprint 5
  
  const [year, setYear] = useState(new Date().getFullYear());
  const [activeTab, setActiveTab] = useState('dashboard');
  const [selectedLocation, setSelectedLocation] = useState('all');
  const [showArchived, setShowArchived] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [syncStatus, setSyncStatus] = useState('');
  const [alerts, setAlerts] = useState([]);
  const [modal, setModal] = useState(null);
  const [backups, setBackups] = useState([]);
  const [lastBackupTime, setLastBackupTime] = useState(null);
  const [backupStatus, setBackupStatus] = useState('');
  
  const tabScrollRef = useRef(null);

  useEffect(() => {
    const script = document.createElement('script');
    script.src = 'https://apis.google.com/js/api.js';
    script.onload = () => window.gapi.load('client', initGapi);
    document.body.appendChild(script);

    const gisScript = document.createElement('script');
    gisScript.src = 'https://accounts.google.com/gsi/client';
    gisScript.onload = () => {
      window.tokenClient = window.google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (response) => {
          console.log('üîê OAuth callback fired');
          
          if (response.error) {
            console.error('‚ùå OAuth error:', response.error);
            return;
          }
          
          try {
            console.log('‚úÖ OAuth success, setting up...');
            
            // Set the access token so gapi.client can use it
            if (response.access_token) {
              window.gapi.client.setToken({
                access_token: response.access_token
              });
              console.log('‚úÖ Access token set');
            } else {
              console.warn('‚ö†Ô∏è No access token in response');
            }
            
            setIsSignedIn(true);
            console.log('‚úÖ isSignedIn set to true');
            
            // Detect user role
            console.log('üîç Detecting user role...');
            await detectUserRole();
            console.log('‚úÖ User role detected');
            
            // Load data from cloud
            console.log('üìÇ Calling loadFromCloud...');
            await loadFromCloud();
            console.log('‚úÖ loadFromCloud completed');
            
          } catch (err) {
            console.error('‚ùå Error in OAuth callback:', err);
            setError('Failed to load data: ' + err.message);
          }
        },
      });
    };
    document.body.appendChild(gisScript);
  }, []);
  
  useEffect(() => {
    const scrollContainer = tabScrollRef.current;
    if (!scrollContainer) return;
    const handleWheel = (e) => {
      if (e.deltaY !== 0) {
        e.preventDefault();
        scrollContainer.scrollLeft += e.deltaY;
      }
    };
    scrollContainer.addEventListener('wheel', handleWheel, { passive: false });
    return () => scrollContainer.removeEventListener('wheel', handleWheel);
  }, [isSignedIn]);

  const initGapi = async () => {
    await window.gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
    setIsInitializing(false);
  };

  // Sprint 5: Detect current user and their role
  const detectUserRole = async () => {
    try {
      const token = window.gapi.client.getToken();
      if (!token || !token.access_token) {
        console.log('‚ö†Ô∏è No access token available');
        setUserRole('viewer');
        setRoleLoading(false);
        return 'viewer';
      }
      
      const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
        headers: { 'Authorization': `Bearer ${token.access_token}` }
      });
      
      if (!response.ok) {
        console.error('‚ùå Failed to get user info');
        setUserRole('viewer');
        setRoleLoading(false);
        return 'viewer';
      }
      
      const userInfo = await response.json();
      const email = userInfo.email;
      setCurrentUser(email);
      
      // Try to load role from shared config first
      console.log('üîç Loading role from team config...');
      const teamConfig = await loadSharedConfig();
      
      let role = 'viewer'; // Default
      
      if (teamConfig) {
        const member = teamConfig.teamMembers.find(m => m.email === email);
        if (member) {
          role = member.role;
          console.log('‚úÖ Role loaded from team config:', role);
        } else {
          console.log('‚ö†Ô∏è Email not found in team config, checking fallback');
          // Fall back to hardcoded USER_ROLES
          role = USER_ROLES[email] || 'viewer';
          console.log('‚úÖ Using fallback role:', role);
        }
      } else {
        // Fall back to hardcoded USER_ROLES
        role = USER_ROLES[email] || 'viewer';
        console.log('‚ö†Ô∏è Team config not found, using hardcoded role:', role);
      }
      
      setUserRole(role);
      console.log('‚úÖ User authenticated:', email, '| Role:', ROLES[role].name);
      
      setRoleLoading(false); // Role detection complete
      return role;
    } catch (err) {
      console.error('‚ùå Error in detectUserRole:', err);
      setUserRole('viewer');
      setRoleLoading(false); // Role detection complete (with error)
      return 'viewer';
    }
  };

  // Sprint 5: Get permissions for current user
  const permissions = ROLES[userRole] || ROLES.viewer;

  // Enforce dashboard-only for attendants
  React.useEffect(() => {
    if (userRole === 'attendant' && activeTab !== 'dashboard') {
      console.log('‚ö†Ô∏è Attendant attempted to access', activeTab, '- redirecting to dashboard');
      setActiveTab('dashboard');
    }
  }, [userRole, activeTab]);

  const loadFromCloud = async () => {
    console.log('üìÇ loadFromCloud: Starting...');
    setSyncStatus('Loading...');
    try {
      // SPRINT 5 FIX: For technicians, use hardcoded shared spreadsheet
      // Check email directly from OAuth instead of relying on userRole state (timing issue)
      let userEmail = null;
      let userRoleForEmail = null;
      
      try {
        const token = window.gapi.client.getToken();
        if (token && token.access_token) {
          console.log('üìÇ loadFromCloud: Fetching user email from OAuth...');
          const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
            headers: { 'Authorization': `Bearer ${token.access_token}` }
          });
          if (response.ok) {
            const userInfo = await response.json();
            userEmail = userInfo.email;
            userRoleForEmail = USER_ROLES[userEmail] || null;
            console.log('üìÇ loadFromCloud: User email:', userEmail);
            console.log('üìÇ loadFromCloud: Role for email:', userRoleForEmail);
          }
        }
      } catch (e) {
        console.log('üìÇ loadFromCloud: Could not get user email, falling back to state check');
        console.error('üìÇ loadFromCloud: Email fetch error:', e);
      }
      
      // Check role from email (reliable) or fall back to state (unreliable due to timing)
      const effectiveRole = userRoleForEmail || userRole;
      console.log('üìÇ loadFromCloud: Effective role:', effectiveRole);
      
      // All non-owners (technicians, managers, viewers) use hardcoded shared spreadsheet
      // Only owner uses config flow to create/manage their own spreadsheet
      if (effectiveRole !== 'owner') {
        const SHARED_SPREADSHEET_ID = '1_fUC0hWS8ZmqXkd6_-fMUKwDoW2pB7nYlKZVkBwy7zM';
        console.log('üë• Team member detected (role:', effectiveRole, ') - using shared spreadsheet');
        console.log('üìã Shared spreadsheet ID:', SHARED_SPREADSHEET_ID);
        
        setSpreadsheetId(SHARED_SPREADSHEET_ID);
        console.log('üìä loadFromCloud: Loading shared spreadsheet data...');
        await loadAllData(SHARED_SPREADSHEET_ID);
        console.log('‚úÖ loadFromCloud: Shared spreadsheet loaded');
        
        setSyncStatus('‚úÖ Connected to shared spreadsheet');
        setTimeout(() => setSyncStatus(''), 3000);
        setSyncStatus('');
        console.log('üìÇ loadFromCloud: Complete');
        return;
      }
      
      // Only owner gets here - uses config flow
      console.log('üëë Owner detected - using config flow');
      console.log('üìÇ loadFromCloud: Checking for existing config...');
      const response = await window.gapi.client.drive.files.list({
        spaces: 'appDataFolder',
        q: `name='${CONFIG_FILE_NAME}'`,
        fields: 'files(id)',
      });
      console.log('üìÇ loadFromCloud: Config search result:', response.result.files?.length || 0, 'files');

      if (response.result.files?.length > 0) {
        // Found config - load existing spreadsheet
        console.log('‚úÖ loadFromCloud: Found existing config');
        const fileId = response.result.files[0].id;
        const configResponse = await window.gapi.client.drive.files.get({ fileId, alt: 'media' });
        const config = JSON.parse(configResponse.body);
        console.log('‚úÖ loadFromCloud: Config loaded, spreadsheet ID:', config.spreadsheetId);
        
        setSpreadsheetId(config.spreadsheetId);
        setFolderId(config.folderId || null);
        
        // Initialize folder structure if folder exists
        if (config.folderId) {
          await setupFolderStructure(config.folderId);
        }
        
        console.log('üìä loadFromCloud: Loading spreadsheet data...');
        await loadAllData(config.spreadsheetId);
        console.log('‚úÖ loadFromCloud: Data loaded successfully');
        
        // Load backup config and check if auto-backup needed
        await loadBackupConfig();
      } else {
        // No config found - create new spreadsheet (owners only)
        console.log('‚ùå loadFromCloud: No config found');
        console.log('üÜï loadFromCloud: Creating new spreadsheet...');
        await createSpreadsheet();
      }
    } catch (err) {
      console.error('‚ùå loadFromCloud: Error:', err);
      console.error('‚ùå loadFromCloud: Error message:', err.message);
      console.error('‚ùå loadFromCloud: Error stack:', err.stack);
      setError('Cloud sync failed: ' + err.message);
    }
    setSyncStatus('');
    console.log('üìÇ loadFromCloud: Complete');
  };

  const saveToCloud = async (sheetId, folder) => {
    const config = { spreadsheetId: sheetId, folderId: folder, lastUpdated: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(config)], { type: 'application/json' });
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify({ name: CONFIG_FILE_NAME, parents: ['appDataFolder'] })], { type: 'application/json' }));
    form.append('file', blob);

    const searchResponse = await window.gapi.client.drive.files.list({ spaces: 'appDataFolder', q: `name='${CONFIG_FILE_NAME}'`, fields: 'files(id)' });

    if (searchResponse.result.files?.length > 0) {
      await fetch(`https://www.googleapis.com/upload/drive/v3/files/${searchResponse.result.files[0].id}?uploadType=multipart`, {
        method: 'PATCH',
        headers: new Headers({ Authorization: 'Bearer ' + window.gapi.client.getToken().access_token }),
        body: form,
      });
    } else {
      await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: new Headers({ Authorization: 'Bearer ' + window.gapi.client.getToken().access_token }),
        body: form,
      });
    }
  };

  const getOrCreateFolder = async () => {
    const response = await window.gapi.client.drive.files.list({ q: "name='Laundromat Maintenance Files' and mimeType='application/vnd.google-apps.folder' and trashed=false", fields: 'files(id)' });
    if (response.result.files?.length > 0) return response.result.files[0].id;
    const createResponse = await window.gapi.client.drive.files.create({ resource: { name: 'Laundromat Maintenance Files', mimeType: 'application/vnd.google-apps.folder' }, fields: 'id' });
    return createResponse.result.id;
  };

  const createSpreadsheet = async () => {
    setSyncStatus('Creating spreadsheet...');
    const response = await window.gapi.client.sheets.spreadsheets.create({
      resource: {
        properties: { title: 'Laundromat Maintenance Pro' },
        sheets: [
          { properties: { title: 'Locations' } },
          { properties: { title: 'Machines' } },
          { properties: { title: 'Equipment Logs' } },
          { properties: { title: 'Building Logs' } },
          { properties: { title: 'Vendors' } },
          { properties: { title: 'Parts Inventory' } },
          { properties: { title: 'Parts Usage' } },
          { properties: { title: 'Scheduled Maintenance' } },
          { properties: { title: 'Warranties' } },
          { properties: { title: 'Machine Notes' } },
          { properties: { title: 'Maintenance Requests' } },
        ],
      },
    });
    
    const id = response.result.spreadsheetId;
    const folder = await getOrCreateFolder();
    setSpreadsheetId(id);
    setFolderId(folder);
    
    // Setup folder structure (Equipment Repairs, Building Maintenance, Parts Receipts)
    await setupFolderStructure(folder);
    
    await saveToCloud(id, folder);
    
    await window.gapi.client.sheets.spreadsheets.values.batchUpdate({
      spreadsheetId: id,
      resource: {
        valueInputOption: 'RAW',
        data: [
          { range: 'Locations!A1', values: [['ID', 'Name', 'Address']] },
          { range: 'Machines!A1', values: [['ID', 'LocationID', 'Name', 'Model', 'Serial', 'Type', 'PurchaseDate', 'Archived', 'PurchasePrice', 'Status', 'OutOfOrderReason']] },
          { range: 'Equipment Logs!A1', values: [['ID', 'LocationID', 'MachineID', 'Date', 'Issue', 'Tech', 'Cost', 'Hours', 'PartsUsed', 'Notes', 'Files', 'Locked', 'Warranty']] },
          { range: 'Building Logs!A1', values: [['ID', 'LocationID', 'Date', 'Category', 'Issue', 'Tech', 'Cost', 'Hours', 'Notes', 'Files', 'Locked', 'Warranty']] },
          { range: 'Vendors!A1', values: [['ID', 'Name', 'Contact', 'Phone', 'Email', 'Specialties', 'Rate', 'Notes']] },
          { range: 'Parts Inventory!A1', values: [['ID', 'Name', 'SKU', 'Stock', 'MinStock', 'Cost', 'VendorID', 'LocationID', 'Notes', 'Snoozed', 'BinLocation']] },
          { range: 'Parts Usage!A1', values: [['ID', 'LogID', 'PartID', 'Qty', 'Cost', 'Date']] },
          { range: 'Scheduled Maintenance!A1', values: [['ID', 'MachineID', 'Task', 'Frequency', 'LastCompleted', 'NextDue', 'Notes', 'Active', 'Type', 'Location', 'Children', 'EquipmentType']] },
          { range: 'Warranties!A1', values: [['ID', 'MachineID', 'StartDate', 'EndDate', 'Provider', 'Coverage', 'Notes']] },
          { range: 'Machine Notes!A1', values: [['ID', 'MachineID', 'Date', 'Note', 'User']] },
          { range: 'Maintenance Requests!A1', values: [['ID', 'MachineID', 'SubmittedBy', 'SubmittedDate', 'Issue', 'Urgency', 'Status', 'AssignedTo', 'Notes', 'ResolvedDate']] },
        ],
      },
    });

    await window.gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId: id,
      range: 'Locations!A:C',
      valueInputOption: 'RAW',
      resource: { values: [['LOC001', 'Main Location', '']] },
    });

    await loadAllData(id);
  };

  const loadAllData = async (id) => {
    console.log('üìä loadAllData: Starting with spreadsheet ID:', id);
    
    // Store spreadsheet ID globally for other functions to use
    window.currentSpreadsheetId = id;
    localStorage.setItem('spreadsheetId', id);
    console.log('‚úÖ Spreadsheet ID stored:', id);
    
    setLoading(true);
    try {
      console.log('üìä loadAllData: Calling batchGet...');
      const response = await window.gapi.client.sheets.spreadsheets.values.batchGet({
        spreadsheetId: id,
        ranges: ['Locations!A2:C', 'Machines!A2:K', 'Equipment Logs!A2:M', 'Building Logs!A2:L', 'Vendors!A2:H', 'Parts Inventory!A2:K', 'Parts Usage!A2:F', 'Scheduled Maintenance!A2:L', 'Warranties!A2:G'],
      });
      
      console.log('üìä loadAllData: batchGet response received');
      console.log('üìä loadAllData: Number of ranges:', response.result.valueRanges?.length);
      
      const [loc, mach, eqLog, bldLog, vend, part, usage, sched, warr] = response.result.valueRanges.map(r => r.values || []);
      
      console.log('üìä loadAllData: Parsed data:');
      console.log('  - Locations:', loc?.length || 0);
      console.log('  - Machines:', mach?.length || 0);
      console.log('  - Equipment Logs:', eqLog?.length || 0);
      console.log('  - Building Logs:', bldLog?.length || 0);
      console.log('  - Vendors:', vend?.length || 0);
      console.log('  - Parts:', part?.length || 0);
      console.log('  - Usage:', usage?.length || 0);
      console.log('  - Scheduled:', sched?.length || 0);
      console.log('  - Warranties:', warr?.length || 0);
      
      // Try to load Machine Notes (may not exist in older spreadsheets)
      let notes = [];
      try {
        const notesResponse = await window.gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: id,
          range: 'Machine Notes!A2:E',
        });
        notes = notesResponse.result.values || [];
        console.log('üìä loadAllData: Machine Notes:', notes.length);
      } catch (notesErr) {
        console.log('üìä loadAllData: Machine Notes sheet not found (OK for older spreadsheets)');
      }
      
      // Try to load Maintenance Requests (Sprint 5 - may not exist in older spreadsheets)
      let requests = [];
      try {
        const requestsResponse = await window.gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: id,
          range: 'Maintenance Requests!A2:J',
        });
        requests = requestsResponse.result.values || [];
        console.log('üìä loadAllData: Maintenance Requests:', requests.length);
      } catch (requestsErr) {
        console.log('üìä loadAllData: Maintenance Requests sheet not found (OK for older spreadsheets)');
      }
      
      console.log('üìä loadAllData: Setting state...');
      setLocations(loc.map(r => ({ id: r[0], name: r[1], address: r[2] || '' })));
      setMachines(mach.map(r => ({ 
        id: r[0], 
        locationId: r[1], 
        name: r[2], 
        model: r[3], 
        serial: r[4], 
        type: r[5], 
        purchaseDate: r[6] || '', 
        archived: r[7] === 'true',
        purchasePrice: r[8] || '',
        status: r[9] || 'In Service', // Sprint 5: Default to 'In Service'
        outOfOrderReason: r[10] || '' // Sprint 5
      })));
      setEquipmentLogs(eqLog.map(r => ({ id: r[0], locationId: r[1], machineId: r[2], date: r[3], issue: r[4], tech: r[5], cost: r[6], hours: r[7] || '0', partsUsed: r[8] || '', notes: r[9] || '', files: r[10] || '', locked: r[11] === 'true', warranty: r[12] === 'true' })));
      setBuildingLogs(bldLog.map(r => ({ id: r[0], locationId: r[1], date: r[2], category: r[3], issue: r[4], tech: r[5], cost: r[6], hours: r[7] || '0', notes: r[8] || '', files: r[9] || '', locked: r[10] === 'true', warranty: r[11] === 'true' })));
      setVendors(vend.map(r => ({ id: r[0], name: r[1], contact: r[2], phone: r[3], email: r[4], specialties: r[5], rate: r[6], notes: r[7] || '' })));
      setParts(part.map(r => ({ id: r[0], name: r[1], sku: r[2], stock: r[3], minStock: r[4], cost: r[5], vendorId: r[6], locationId: r[7], notes: r[8] || '', snoozed: r[9] === 'true', binLocation: r[10] || '' })));
      setPartsUsage(usage.map(r => ({ id: r[0], logId: r[1], partId: r[2], qty: r[3], cost: r[4], date: r[5] })));
      setScheduledTasks(sched.map(r => {
        let frequency = r[3];
        let customValue = null;
        let customUnit = null;
        
        // Decode custom frequency
        if (frequency && frequency.startsWith('Custom:')) {
          const parts = frequency.split(':');
          frequency = 'Custom';
          customValue = parts[1];
          customUnit = parts[2] || 'days';
        }
        
        // Parse children with error handling
        let children = [];
        if (r[10]) {
          try {
            children = JSON.parse(r[10]);
          } catch (e) {
            console.error('Failed to parse children for task', r[0], ':', r[10], e);
            children = [];
          }
        }
        
        return { 
          id: r[0], 
          machineId: r[1] || '', 
          task: r[2], 
          frequency, 
          customValue,
          customUnit,
          lastCompleted: r[4] || '', 
          nextDue: r[5], 
          notes: r[6] || '', 
          active: r[7] !== 'false',
          type: r[8] || 'Equipment',
          location: r[9] || '',
          children,
          equipmentType: r[11] || '' // Add equipmentType from column L
        };
      }));
      setWarranties(warr.map(r => ({ id: r[0], machineId: r[1], startDate: r[2], endDate: r[3], provider: r[4], coverage: r[5] || '', notes: r[6] || '' })));
      setMachineNotes(notes.map(r => ({ id: r[0], machineId: r[1], date: r[2], note: r[3], user: r[4] || 'User' })));
      setMaintenanceRequests(requests.map(r => ({ 
        id: r[0], 
        machineId: r[1], 
        submittedBy: r[2], 
        submittedDate: r[3], 
        issue: r[4], 
        urgency: r[5] || 'Medium', 
        status: r[6] || 'Pending', 
        assignedTo: r[7] || '', 
        notes: r[8] || '', 
        resolvedDate: r[9] || '' 
      })));

      console.log('üìä loadAllData: State set successfully');
      console.log('üìä loadAllData: Generating alerts...');
      generateAlerts(part, sched, warr);
      console.log('‚úÖ loadAllData: Completed successfully!');
    } catch (err) {
      console.error('‚ùå loadAllData: ERROR:', err);
      console.error('‚ùå loadAllData: Error message:', err.message);
      console.error('‚ùå loadAllData: Error stack:', err.stack);
      setError('Failed to load: ' + (err.message || err.toString() || 'Unknown error'));
    }
    setLoading(false);
    console.log('üìä loadAllData: Function complete, loading set to false');
  };

  const generateAlerts = (partData, schedData = [], warrantyData = []) => {
    const newAlerts = [];
    
    // Low stock alerts (skip snoozed parts)
    // Use parts state if available (for real-time updates), otherwise use partData parameter
    const partsToCheck = parts.length > 0 ? parts : partData.map(r => ({ 
      id: r[0], name: r[1], sku: r[2], stock: r[3], minStock: r[4], 
      cost: r[5], vendorId: r[6], locationId: r[7], notes: r[8] || '', 
      snoozed: r[9] === 'true' 
    }));
    
    partsToCheck.forEach(part => {
      if (part.snoozed) return; // Skip snoozed parts
      
      const stock = parseInt(part.stock || 0);
      const minStock = parseInt(part.minStock || 0);
      if (stock <= minStock) {
        newAlerts.push({
          type: stock === 0 ? 'error' : 'warning',
          message: stock === 0 ? `OUT OF STOCK: ${part.name}` : `Low Stock: ${part.name} (${stock} left)`,
          action: 'inventory',
          partId: part.id, // Add part ID for snooze functionality
          partName: part.name
        });
      }
    });
    
    // Overdue maintenance alerts
    const today = new Date();
    schedData.forEach(task => {
      if (task.active && task.nextDue) {
        const dueDate = new Date(task.nextDue);
        if (dueDate < today) {
          newAlerts.push({
            type: 'error',
            message: `OVERDUE MAINTENANCE: ${task.task}`,
            action: 'scheduled'
          });
        } else if ((dueDate - today) / (1000 * 60 * 60 * 24) <= 14) {
          newAlerts.push({
            type: 'warning',
            message: `Upcoming Maintenance: ${task.task} (Due ${task.nextDue})`,
            action: 'scheduled'
          });
        }
      }
    });
    
    // Warranty expiration alerts
    warrantyData.forEach(warranty => {
      const endDate = new Date(warranty.endDate);
      const daysUntilExpiry = (endDate - today) / (1000 * 60 * 60 * 24);
      if (daysUntilExpiry > 0 && daysUntilExpiry <= 30) {
        newAlerts.push({
          type: 'warning',
          message: `Warranty Expiring: ${machines.find(m => m.id === warranty.machineId)?.name || 'Machine'} (${Math.floor(daysUntilExpiry)} days)`,
          action: 'warranties'
        });
      }
    });
    
    setAlerts(newAlerts.slice(0, 15));
  };

  // Helper: Create a folder in Google Drive
  const createDriveFolder = async (name, parentId) => {
    try {
      const response = await window.gapi.client.drive.files.create({
        resource: {
          name: name,
          mimeType: 'application/vnd.google-apps.folder',
          parents: [parentId]
        },
        fields: 'id,name'
      });
      return response.result;
    } catch (err) {
      console.error('Failed to create folder:', name, err);
      throw err;
    }
  };

  // Helper: Find a folder by name in parent
  const findDriveFolder = async (name, parentId) => {
    try {
      const response = await window.gapi.client.drive.files.list({
        q: `name='${name}' and '${parentId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
        fields: 'files(id,name)',
        spaces: 'drive'
      });
      return response.result.files.length > 0 ? response.result.files[0] : null;
    } catch (err) {
      console.error('Failed to find folder:', name, err);
      return null;
    }
  };

  // Helper: Get or create folder (find first, create if not exists)
  const getOrCreateDriveFolder = async (name, parentId) => {
    let folder = await findDriveFolder(name, parentId);
    if (!folder) {
      folder = await createDriveFolder(name, parentId);
    }
    return folder;
  };

  // Setup folder structure: Equipment Repairs, Building Maintenance, Parts Receipts
  const setupFolderStructure = async (mainFolderId) => {
    try {
      const repairsFolder = await getOrCreateDriveFolder('Equipment Repairs', mainFolderId);
      const buildingFolder = await getOrCreateDriveFolder('Building Maintenance', mainFolderId);
      const receiptsFolder = await getOrCreateDriveFolder('Parts Receipts', mainFolderId);
      
      const structure = {
        repairs: repairsFolder.id,
        building: buildingFolder.id,
        receipts: receiptsFolder.id,
        monthCache: {} // Cache year/month folder IDs to avoid repeated searches
      };
      
      setFolderStructure(structure);
      return structure;
    } catch (err) {
      console.error('Failed to setup folder structure:', err);
      throw err;
    }
  };

  // Get target folder for a date (creates year/month subfolders as needed)
  const getTargetFolder = async (baseFolder, date, folderType) => {
    if (!folderStructure) {
      console.error('Folder structure not initialized');
      return baseFolder; // Fallback to base folder
    }

    const year = date.getFullYear().toString();
    const monthNum = String(date.getMonth() + 1).padStart(2, '0');
    const monthName = date.toLocaleString('en', { month: 'long' });
    const monthFolder = `${monthNum}-${monthName}`;
    
    const cacheKey = `${folderType}-${year}-${monthNum}`;
    
    // Check cache first
    if (folderStructure.monthCache[cacheKey]) {
      return folderStructure.monthCache[cacheKey];
    }
    
    try {
      // Get or create year folder
      const yearFolder = await getOrCreateDriveFolder(year, baseFolder);
      
      // Get or create month folder
      const monthFolderObj = await getOrCreateDriveFolder(monthFolder, yearFolder.id);
      
      // Cache the result
      folderStructure.monthCache[cacheKey] = monthFolderObj.id;
      
      return monthFolderObj.id;
    } catch (err) {
      console.error('Failed to get target folder:', err);
      return baseFolder; // Fallback to base folder
    }
  };

  const uploadFile = async (file, targetFolderId = null, customName = null) => {
    // Use provided folder, or fall back to main folder
    const uploadFolderId = targetFolderId || folderId;
    
    if (!uploadFolderId) {
      const folder = await getOrCreateFolder();
      setFolderId(folder);
      return uploadFile(file, folder, customName);
    }

    // Use custom name if provided, otherwise timestamp + original name
    const fileName = customName || `${Date.now()}-${file.name}`;

    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify({ name: fileName, parents: [uploadFolderId] })], { type: 'application/json' }));
    form.append('file', file);

    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,mimeType', {
      method: 'POST',
      headers: new Headers({ Authorization: 'Bearer ' + window.gapi.client.getToken().access_token }),
      body: form,
    });

    const result = await response.json();
    await window.gapi.client.drive.permissions.create({ fileId: result.id, resource: { role: 'reader', type: 'anyone' } });
    return { id: result.id, name: result.name, type: result.mimeType };
  };

  // CRUD Operations
  const addMachine = async (machine) => {
    const newMachine = { 
      id: Date.now().toString(), 
      locationId: selectedLocation === 'all' ? locations[0]?.id : selectedLocation, 
      ...machine, 
      archived: false,
      status: 'In Service', // Sprint 5: Default status
      outOfOrderReason: '' // Sprint 5
    };
    try {
      await window.gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId,
        range: 'Machines!A:K',
        valueInputOption: 'RAW',
        resource: { values: [[newMachine.id, newMachine.locationId, newMachine.name, newMachine.model, newMachine.serial, newMachine.type, newMachine.purchaseDate, 'false', newMachine.purchasePrice || '', newMachine.status, newMachine.outOfOrderReason]] },
      });
      setMachines([...machines, newMachine]);
      setModal(null);
    } catch (err) {
      setError('Failed to add machine');
    }
  };

  const updateMachine = async (id, updates) => {
    try {
      const index = machines.findIndex(m => m.id === id);
      const updated = { ...machines[index], ...updates };
      const rowNum = index + 2;
      
      await window.gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId,
        range: `Machines!A${rowNum}:K${rowNum}`,
        valueInputOption: 'RAW',
        resource: { values: [[updated.id, updated.locationId, updated.name, updated.model, updated.serial, updated.type, updated.purchaseDate, updated.archived ? 'true' : 'false', updated.purchasePrice || '', updated.status || 'In Service', updated.outOfOrderReason || '']] },
      });
      
      setMachines(machines.map(m => m.id === id ? updated : m));
      setModal(null);
    } catch (err) {
      setError('Failed to update machine');
    }
  };

  const archiveMachine = async (id) => {
    if (!window.confirm('Archive this machine? History will be preserved but it will be hidden from active equipment.')) return;
    await updateMachine(id, { archived: true });
  };

  const unarchiveMachine = async (id) => {
    await updateMachine(id, { archived: false });
  };

  const deleteMachine = async (id) => {
    if (!window.confirm('DELETE this machine permanently? This cannot be undone.')) return;
    try {
      const index = machines.findIndex(m => m.id === id);
      const rowNum = index + 2;
      
      // Clear the row data instead of deleting the dimension
      await window.gapi.client.sheets.spreadsheets.values.clear({
        spreadsheetId,
        range: `Machines!A${rowNum}:I${rowNum}`,
      });
      
      setMachines(machines.filter(m => m.id !== id));
    } catch (err) {
      console.error('Delete machine error:', err);
      setError('Failed to delete machine');
    }
  };

  const addEquipmentLog = async (log, selectedParts, photoFiles) => {
    setSyncStatus('Saving...');
    let fileIds = '';
    if (photoFiles?.length > 0 && folderStructure) {
      const repairDate = new Date(log.date);
      const machine = machines.find(m => m.id === log.machineId);
      const machineName = machine?.name.replace(/[^a-z0-9]/gi, '').toLowerCase() || 'unknown';
      const issueShort = log.issue.substring(0, 20).replace(/[^a-z0-9]/gi, '').toLowerCase();
      const dateStr = repairDate.toISOString().split('T')[0].replace(/-/g, '');
      
      const targetFolder = await getTargetFolder(folderStructure.repairs, repairDate, 'repairs');
      
      const uploads = await Promise.all(photoFiles.map((f, i) => {
        const fileNum = String(i + 1).padStart(3, '0');
        const extension = f.name.split('.').pop();
        const smartName = `${dateStr}_${machineName}_${issueShort}_${fileNum}.${extension}`;
        return uploadFile(f, targetFolder, smartName);
      }));
      fileIds = uploads.map(u => u.id).join(',');
    }

    const partsCost = selectedParts.reduce((sum, p) => sum + (parseFloat(p.qty) * parseFloat(p.cost)), 0);
    const laborCost = parseFloat(log.laborCost || 0);
    const totalCost = partsCost + laborCost;

    const newLog = {
      id: Date.now().toString(),
      locationId: selectedLocation === 'all' ? locations[0]?.id : selectedLocation,
      machineId: log.machineId,
      date: log.date,
      issue: log.issue,
      tech: log.tech,
      cost: totalCost.toString(),
      hours: log.hours,
      partsUsed: selectedParts.map(p => `${p.id}:${p.qty}`).join(','),
      notes: log.notes || '',
      files: fileIds,
      locked: false,
      warranty: log.warranty || false
    };

    try {
      await window.gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId,
        range: 'Equipment Logs!A:M',
        valueInputOption: 'RAW',
        resource: { values: [[newLog.id, newLog.locationId, newLog.machineId, newLog.date, newLog.issue, newLog.tech, newLog.cost, newLog.hours, newLog.partsUsed, newLog.notes, newLog.files, 'false', newLog.warranty ? 'true' : 'false']] },
      });

      for (const part of selectedParts) {
        const partIndex = parts.findIndex(p => p.id === part.id);
        if (partIndex >= 0) {
          const currentStock = parseInt(parts[partIndex].stock);
          const newStock = Math.max(0, currentStock - parseInt(part.qty));
          
          await window.gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId,
            range: `Parts Inventory!D${partIndex + 2}`,
            valueInputOption: 'RAW',
            resource: { values: [[newStock.toString()]] },
          });

          await window.gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId,
            range: 'Parts Usage!A:F',
            valueInputOption: 'RAW',
            resource: { values: [[Date.now().toString(), newLog.id, part.id, part.qty, (parseFloat(part.qty) * parseFloat(part.cost)).toString(), newLog.date]] },
          });

          parts[partIndex].stock = newStock.toString();
        }
      }

      setParts([...parts]);
      setEquipmentLogs([...equipmentLogs, newLog]);
      setModal(null);
      generateAlerts(parts.map(p => [p.id, p.name, p.sku, p.stock, p.minStock, p.cost, p.vendorId, p.locationId, p.notes]));
    } catch (err) {
      setError('Failed to add log: ' + err.message);
    }
    setSyncStatus('');
  };

  const addBuildingLog = async (log, photoFiles) => {
    setSyncStatus('Saving...');
    let fileIds = '';
    if (photoFiles?.length > 0 && folderStructure) {
      const buildingDate = new Date(log.date);
      const categoryShort = log.category.substring(0, 20).replace(/[^a-z0-9]/gi, '').toLowerCase();
      const issueShort = log.issue.substring(0, 20).replace(/[^a-z0-9]/gi, '').toLowerCase();
      const dateStr = buildingDate.toISOString().split('T')[0].replace(/-/g, '');
      
      const targetFolder = await getTargetFolder(folderStructure.building, buildingDate, 'building');
      
      const uploads = await Promise.all(photoFiles.map((f, i) => {
        const fileNum = String(i + 1).padStart(3, '0');
        const extension = f.name.split('.').pop();
        const smartName = `${dateStr}_${categoryShort}_${issueShort}_${fileNum}.${extension}`;
        return uploadFile(f, targetFolder, smartName);
      }));
      fileIds = uploads.map(u => u.id).join(',');
    }

    const newLog = {
      id: Date.now().toString(),
      locationId: selectedLocation === 'all' ? locations[0]?.id : selectedLocation,
      date: log.date,
      category: log.category,
      issue: log.issue,
      tech: log.tech,
      cost: log.cost,
      hours: log.hours,
      notes: log.notes || '',
      files: fileIds,
      locked: false,
      warranty: log.warranty || false
    };

    try {
      await window.gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId,
        range: 'Building Logs!A:L',
        valueInputOption: 'RAW',
        resource: { values: [[newLog.id, newLog.locationId, newLog.date, newLog.category, newLog.issue, newLog.tech, newLog.cost, newLog.hours, newLog.notes, newLog.files, 'false', newLog.warranty ? 'true' : 'false']] },
      });
      setBuildingLogs([...buildingLogs, newLog]);
      setModal(null);
    } catch (err) {
      setError('Failed to add building log');
    }
    setSyncStatus('');
  };

  // Parts CRUD
  const addPart = async (part) => {
    const newPart = { id: Date.now().toString(), locationId: selectedLocation === 'all' ? locations[0]?.id : selectedLocation, snoozed: false, ...part };
    try {
      await window.gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId,
        range: 'Parts Inventory!A:K',
        valueInputOption: 'RAW',
        resource: { values: [[newPart.id, newPart.name, newPart.sku, newPart.stock, newPart.minStock, newPart.cost, newPart.vendorId || '', newPart.locationId, newPart.notes || '', 'false', newPart.binLocation || '']] },
      });
      setParts([...parts, newPart]);
      setModal(null);
      generateAlerts([...parts, newPart].map(p => [p.id, p.name, p.sku, p.stock, p.minStock, p.cost, p.vendorId, p.locationId, p.notes]));
    } catch (err) {
      setError('Failed to add part');
    }
  };

  const updatePart = async (id, updates) => {
    try {
      const index = parts.findIndex(p => p.id === id);
      const updated = { ...parts[index], ...updates };
      const rowNum = index + 2;
      
      await window.gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId,
        range: `Parts Inventory!A${rowNum}:K${rowNum}`,
        valueInputOption: 'RAW',
        resource: { values: [[updated.id, updated.name, updated.sku, updated.stock, updated.minStock, updated.cost, updated.vendorId || '', updated.locationId, updated.notes || '', updated.snoozed ? 'true' : 'false', updated.binLocation || '']] },
      });
      
      const newParts = parts.map(p => p.id === id ? updated : p);
      setParts(newParts);
      setModal(null);
      generateAlerts(newParts.map(p => [p.id, p.name, p.sku, p.stock, p.minStock, p.cost, p.vendorId, p.locationId, p.notes]));
    } catch (err) {
      setError('Failed to update part');
    }
  };

  const deletePart = async (id) => {
    if (!window.confirm('Delete this part?')) return;
    try {
      const index = parts.findIndex(p => p.id === id);
      const rowNum = index + 2; // +2 because row 1 is header, and array is 0-indexed
      
      // Clear the row data instead of deleting the dimension
      await window.gapi.client.sheets.spreadsheets.values.clear({
        spreadsheetId,
        range: `Parts Inventory!A${rowNum}:K${rowNum}`,
      });
      
      const newParts = parts.filter(p => p.id !== id);
      setParts(newParts);
      generateAlerts(newParts.map(p => [p.id, p.name, p.sku, p.stock, p.minStock, p.cost, p.vendorId, p.locationId, p.notes]));
    } catch (err) {
      console.error('Delete part error:', err);
      setError('Failed to delete part');
    }
  };

  const snoozePart = async (partId) => {
    try {
      const index = parts.findIndex(p => p.id === partId);
      if (index === -1) return;
      
      const part = parts[index];
      const newSnoozed = !part.snoozed;
      const rowNum = index + 2;
      
      // Update snoozed status in column J
      await window.gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId,
        range: `Parts Inventory!J${rowNum}`,
        valueInputOption: 'RAW',
        resource: { values: [[newSnoozed ? 'true' : 'false']] },
      });
      
      // Update local state
      const updatedParts = parts.map(p => 
        p.id === partId ? { ...p, snoozed: newSnoozed } : p
      );
      setParts(updatedParts);
      
      // Regenerate alerts
      generateAlerts([], scheduledTasks, warranties);
      
    } catch (err) {
      console.error('Snooze part error:', err);
      setError('Failed to update alert');
    }
  };

  // Expose snoozePart globally for dashboard alerts
  useEffect(() => {
    window.snoozePart = snoozePart;
    return () => { delete window.snoozePart; };
  }, [parts, scheduledTasks, warranties]);

  // Vendors CRUD
  const addVendor = async (vendor) => {
    const newVendor = { id: Date.now().toString(), ...vendor };
    try {
      await window.gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId,
        range: 'Vendors!A:H',
        valueInputOption: 'RAW',
        resource: { values: [[newVendor.id, newVendor.name, newVendor.contact, newVendor.phone, newVendor.email, newVendor.specialties, newVendor.rate, newVendor.notes || '']] },
      });
      setVendors([...vendors, newVendor]);
      setModal(null);
    } catch (err) {
      setError('Failed to add vendor');
    }
  };

  const updateVendor = async (id, updates) => {
    try {
      const index = vendors.findIndex(v => v.id === id);
      const updated = { ...vendors[index], ...updates };
      const rowNum = index + 2;
      
      await window.gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId,
        range: `Vendors!A${rowNum}:H${rowNum}`,
        valueInputOption: 'RAW',
        resource: { values: [[updated.id, updated.name, updated.contact, updated.phone, updated.email, updated.specialties, updated.rate, updated.notes || '']] },
      });
      
      setVendors(vendors.map(v => v.id === id ? updated : v));
      setModal(null);
    } catch (err) {
      setError('Failed to update vendor');
    }
  };

  const deleteVendor = async (id) => {
    if (!window.confirm('Delete this vendor?')) return;
    try {
      const index = vendors.findIndex(v => v.id === id);
      const rowNum = index + 2;
      
      // Clear the row data instead of deleting the dimension
      await window.gapi.client.sheets.spreadsheets.values.clear({
        spreadsheetId,
        range: `Vendors!A${rowNum}:H${rowNum}`,
      });
      
      setVendors(vendors.filter(v => v.id !== id));
    } catch (err) {
      console.error('Delete vendor error:', err);
      setError('Failed to delete vendor');
    }
  };

  // Edit Equipment Log
  const updateEquipmentLog = async (id, updates) => {
    try {
      const index = equipmentLogs.findIndex(l => l.id === id);
      const updated = { ...equipmentLogs[index], ...updates };
      const rowNum = index + 2;
      
      await window.gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId,
        range: `Equipment Logs!A${rowNum}:M${rowNum}`,
        valueInputOption: 'RAW',
        resource: { values: [[updated.id, updated.locationId, updated.machineId, updated.date, updated.issue, updated.tech, updated.cost, updated.hours, updated.partsUsed, updated.notes, updated.files, updated.locked ? 'true' : 'false', updated.warranty ? 'true' : 'false']] },
      });
      
      setEquipmentLogs(equipmentLogs.map(l => l.id === id ? updated : l));
      setModal(null);
    } catch (err) {
      setError('Failed to update log');
    }
  };

  // Add Parts to Existing Repair
  const addPartsToRepair = async (log, selectedParts) => {
    setSyncStatus('Adding parts...');
    try {
      // Calculate new parts cost
      const newPartsCost = selectedParts.reduce((sum, p) => sum + (parseFloat(p.cost) * parseInt(p.qty)), 0);
      const currentCost = parseFloat(log.cost || 0);
      const updatedCost = (currentCost + newPartsCost).toString();
      
      // Update parts used string
      const existingParts = log.partsUsed ? log.partsUsed.split(',').filter(Boolean) : [];
      const newPartsString = selectedParts.map(p => `${p.id}:${p.qty}`).join(',');
      const updatedPartsUsed = [...existingParts, newPartsString].join(',');
      
      // Add to Parts Usage table
      const usageDate = getTodayLocal();
      for (const part of selectedParts) {
        const usageEntry = {
          id: Date.now().toString() + Math.random(),
          logId: log.id,
          partId: part.id,
          qty: part.qty,
          cost: (parseFloat(part.cost) * parseInt(part.qty)).toFixed(2),
          date: usageDate
        };
        
        await window.gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId,
          range: 'Parts Usage!A:F',
          valueInputOption: 'RAW',
          resource: { values: [[usageEntry.id, usageEntry.logId, usageEntry.partId, usageEntry.qty, usageEntry.cost, usageEntry.date]] },
        });
      }
      
      // Deduct from inventory
      for (const part of selectedParts) {
        const partIndex = parts.findIndex(p => p.id === part.id);
        if (partIndex >= 0) {
          const currentStock = parseInt(parts[partIndex].stock);
          const newStock = Math.max(0, currentStock - parseInt(part.qty));
          
          await window.gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId,
            range: `Parts Inventory!D${partIndex + 2}`,
            valueInputOption: 'RAW',
            resource: { values: [[newStock.toString()]] },
          });
          
          parts[partIndex].stock = newStock.toString();
        }
      }
      
      // Update repair log
      const logIndex = equipmentLogs.findIndex(l => l.id === log.id);
      const updated = { ...equipmentLogs[logIndex], cost: updatedCost, partsUsed: updatedPartsUsed };
      const rowNum = logIndex + 2;
      
      await window.gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId,
        range: `Equipment Logs!A${rowNum}:L${rowNum}`,
        valueInputOption: 'RAW',
        resource: { values: [[updated.id, updated.locationId, updated.machineId, updated.date, updated.issue, updated.tech, updated.cost, updated.hours, updated.partsUsed, updated.notes, updated.files, updated.locked ? 'true' : 'false']] },
      });
      
      setEquipmentLogs(equipmentLogs.map(l => l.id === log.id ? updated : l));
      setParts([...parts]);
      await loadAllData(spreadsheetId); // Reload to get updated parts usage
      setModal(null);
      setSyncStatus('');
    } catch (err) {
      setError('Failed to add parts: ' + err.message);
      setSyncStatus('');
    }
  };

  // Edit Building Log
  const updateBuildingLog = async (id, updates) => {
    try {
      const index = buildingLogs.findIndex(l => l.id === id);
      const updated = { ...buildingLogs[index], ...updates };
      const rowNum = index + 2;
      
      await window.gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId,
        range: `Building Logs!A${rowNum}:L${rowNum}`,
        valueInputOption: 'RAW',
        resource: { values: [[updated.id, updated.locationId, updated.date, updated.category, updated.issue, updated.tech, updated.cost, updated.hours, updated.notes, updated.files, updated.locked ? 'true' : 'false', updated.warranty ? 'true' : 'false']] },
      });
      
      setBuildingLogs(buildingLogs.map(l => l.id === id ? updated : l));
      setModal(null);
    } catch (err) {
      setError('Failed to update log');
    }
  };

  // Scheduled Maintenance CRUD
  const addScheduledTask = async (task) => {
    const newTask = { id: Date.now().toString(), ...task, active: true };
    
    // Encode custom frequency if needed
    let frequencyValue = newTask.frequency;
    if (newTask.frequency === 'Custom' && newTask.customValue && newTask.customUnit) {
      frequencyValue = `Custom:${newTask.customValue}:${newTask.customUnit}`;
    }
    
    try {
      await window.gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId,
        range: 'Scheduled Maintenance!A:L',
        valueInputOption: 'RAW',
        resource: { values: [[
          newTask.id,                                 // A
          newTask.machineId || '',                    // B
          newTask.task,                               // C
          frequencyValue,                             // D
          newTask.lastCompleted || '',                // E
          newTask.nextDue,                            // F
          newTask.notes || '',                        // G
          'true',                                     // H
          newTask.type || 'Equipment',                // I
          newTask.location || '',                     // J
          JSON.stringify(newTask.children || []),     // K
          newTask.equipmentType || ''                 // L
        ]] },
      });
      const newTasks = [...scheduledTasks, newTask];
      setScheduledTasks(newTasks);
      setModal(null);
      generateAlerts(parts.map(p => [p.id, p.name, p.sku, p.stock, p.minStock, p.cost, p.vendorId, p.locationId, p.notes]), newTasks, warranties);
    } catch (err) {
      setError('Failed to add task');
    }
  };

  const updateScheduledTask = async (id, updates) => {
    try {
      const index = scheduledTasks.findIndex(t => t.id === id);
      const updated = { ...scheduledTasks[index], ...updates };
      const rowNum = index + 2;
      
      await window.gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId,
        range: `Scheduled Maintenance!A${rowNum}:L${rowNum}`,
        valueInputOption: 'RAW',
        resource: { values: [[
          updated.id,                                  // A
          updated.machineId || '',                     // B
          updated.task,                                // C
          updated.frequency,                           // D
          updated.lastCompleted || '',                 // E
          updated.nextDue,                             // F
          updated.notes || '',                         // G
          updated.active ? 'true' : 'false',          // H
          updated.type || 'Equipment',                 // I
          updated.location || '',                      // J
          JSON.stringify(updated.children || []),      // K
          updated.equipmentType || ''                  // L
        ]] },
      });
      
      const newTasks = scheduledTasks.map(t => t.id === id ? updated : t);
      setScheduledTasks(newTasks);
      setModal(null);
      generateAlerts(parts.map(p => [p.id, p.name, p.sku, p.stock, p.minStock, p.cost, p.vendorId, p.locationId, p.notes]), newTasks, warranties);
    } catch (err) {
      setError('Failed to update task');
    }
  };

  const calculateNextDue = (date, frequency, customValue, customUnit) => {
    const d = new Date(date);
    switch(frequency) {
      case 'Weekly': d.setDate(d.getDate() + 7); break;
      case 'Monthly': d.setMonth(d.getMonth() + 1); break;
      case 'Quarterly': d.setMonth(d.getMonth() + 3); break;
      case 'Semi-Annual': d.setMonth(d.getMonth() + 6); break;
      case 'Annual': case 'Annually': d.setFullYear(d.getFullYear() + 1); break;
      case 'Custom':
        if (customValue && customUnit) {
          const value = parseInt(customValue);
          if (customUnit === 'weeks') {
            d.setDate(d.getDate() + (value * 7));
          } else { // days
            d.setDate(d.getDate() + value);
          }
        }
        break;
    }
    return d.toISOString().split('T')[0];
  };

  const completeScheduledTask = async (taskId, childId = null) => {
    const task = scheduledTasks.find(t => t.id === taskId);
    if (!task) return;
    
    const today = getTodayLocal();
    
    try {
      if (task.type === 'Bulk' && childId) {
        // Complete individual child task
        const childIndex = task.children.findIndex(c => c.id === childId);
        if (childIndex >= 0) {
          task.children[childIndex].completed = true;
          task.children[childIndex].completedDate = today;
          
          // Log to history
          const historyEntry = {
            id: Date.now().toString() + Math.random(),
            taskId: task.id,
            taskName: task.task,
            machineId: task.children[childIndex].machineId,
            machineName: task.children[childIndex].machineName,
            completedDate: today,
            type: 'Equipment'
          };
          
          const newHistory = [...maintenanceHistory, historyEntry];
          setMaintenanceHistory(newHistory);
          
          // Update task with completed child
          await updateScheduledTask(taskId, { children: task.children });
          
          // Check if all children complete
          const allComplete = task.children.every(c => c.completed);
          if (allComplete) {
            const nextDue = calculateNextDue(today, task.frequency, task.customValue, task.customUnit);
            // Reset all children
            const resetChildren = task.children.map(c => ({ ...c, completed: false, completedDate: null }));
            await updateScheduledTask(taskId, { 
              lastCompleted: today, 
              nextDue,
              children: resetChildren
            });
          }
        }
      } else {
        // Complete regular task or all bulk tasks
        const nextDue = calculateNextDue(today, task.frequency, task.customValue, task.customUnit);
        
        // Log to history
        const historyEntry = {
          id: Date.now().toString() + Math.random(),
          taskId: task.id,
          taskName: task.task,
          machineId: task.type === 'Equipment' ? task.machineId : null,
          machineName: task.type === 'Equipment' && task.machineId ? machines.find(m => m.id === task.machineId)?.name : null,
          location: task.type === 'Building' ? task.location : null,
          completedDate: today,
          type: task.type || 'Equipment'
        };
        
        const newHistory = [...maintenanceHistory, historyEntry];
        setMaintenanceHistory(newHistory);
        
        // If bulk task, reset all children
        if (task.type === 'Bulk') {
          const resetChildren = task.children.map(c => ({ ...c, completed: false, completedDate: null }));
          await updateScheduledTask(taskId, { 
            lastCompleted: today, 
            nextDue,
            children: resetChildren
          });
        } else {
          await updateScheduledTask(taskId, { lastCompleted: today, nextDue });
        }
      }
    } catch (err) {
      setError('Failed to complete task: ' + err.message);
    }
  };

  const deleteScheduledTask = async (id) => {
    if (!window.confirm('Delete this scheduled task?')) return;
    try {
      const index = scheduledTasks.findIndex(t => t.id === id);
      const rowNum = index + 2;
      
      // Clear the row data instead of deleting the dimension
      await window.gapi.client.sheets.spreadsheets.values.clear({
        spreadsheetId,
        range: `Scheduled Maintenance!A${rowNum}:L${rowNum}`,
      });
      
      const newTasks = scheduledTasks.filter(t => t.id !== id);
      setScheduledTasks(newTasks);
      generateAlerts(parts.map(p => [p.id, p.name, p.sku, p.stock, p.minStock, p.cost, p.vendorId, p.locationId, p.notes]), newTasks, warranties);
    } catch (err) {
      console.error('Delete task error:', err);
      setError('Failed to delete task');
    }
  };

  // Create Bulk Schedule - NEW IN SPRINT 3.1
  const createBulkSchedule = async (form, selectedMachines) => {
    try {
      const bulkTask = {
        id: Date.now().toString(),
        type: 'Bulk',
        task: form.task,
        equipmentType: form.equipmentType,
        frequency: form.frequency,
        customValue: form.customValue,
        customUnit: form.customUnit,
        nextDue: form.nextDue,
        lastCompleted: null,
        active: true,
        children: selectedMachines.map(m => ({
          id: Date.now().toString() + Math.random(),
          machineId: m.id,
          machineName: m.name,
          completed: false,
          completedDate: null
        }))
      };
      
      // Encode custom frequency if needed
      let frequencyValue = bulkTask.frequency;
      if (bulkTask.frequency === 'Custom' && bulkTask.customValue && bulkTask.customUnit) {
        frequencyValue = `Custom:${bulkTask.customValue}:${bulkTask.customUnit}`;
      }
      
      await window.gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId,
        range: 'Scheduled Maintenance!A:L',
        valueInputOption: 'RAW',
        resource: { values: [[
          bulkTask.id,                                    // A: ID
          '',                                             // B: MachineID (empty for bulk)
          bulkTask.task,                                  // C: Task
          frequencyValue,                                 // D: Frequency (encoded)
          bulkTask.lastCompleted || '',                   // E: LastCompleted
          bulkTask.nextDue,                               // F: NextDue
          '',                                             // G: Notes
          bulkTask.active ? 'true' : 'false',            // H: Active
          bulkTask.type || 'Bulk',                       // I: Type
          '',                                             // J: Location (empty for bulk)
          JSON.stringify(bulkTask.children || []),       // K: Children
          bulkTask.equipmentType || ''                    // L: EquipmentType
        ]] },
      });
      
      const newTasks = [...scheduledTasks, bulkTask];
      setScheduledTasks(newTasks);
      setModal(null);
      generateAlerts(parts.map(p => [p.id, p.name, p.sku, p.stock, p.minStock, p.cost, p.vendorId, p.locationId, p.notes]), newTasks, warranties);
    } catch (err) {
      setError('Failed to create bulk schedule: ' + err.message);
    }
  };

  // Export History - NEW IN SPRINT 3.1
  const exportHistory = () => {
    const data = maintenanceHistory.map(h => ({
      Date: h.completedDate,
      Task: h.taskName,
      Machine: h.machineName || h.location || 'Building-wide',
      Type: h.type || 'Equipment'
    }));
    exportToCSV(data, `maintenance-history-${getTodayLocal()}.csv`);
  };

  // Warranties CRUD
  const addWarranty = async (warranty) => {
    const newWarranty = { id: Date.now().toString(), ...warranty };
    try {
      await window.gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId,
        range: 'Warranties!A:G',
        valueInputOption: 'RAW',
        resource: { values: [[newWarranty.id, newWarranty.machineId, newWarranty.startDate, newWarranty.endDate, newWarranty.provider, newWarranty.coverage || '', newWarranty.notes || '']] },
      });
      const newWarranties = [...warranties, newWarranty];
      setWarranties(newWarranties);
      setModal(null);
      generateAlerts(parts.map(p => [p.id, p.name, p.sku, p.stock, p.minStock, p.cost, p.vendorId, p.locationId, p.notes]), scheduledTasks, newWarranties);
    } catch (err) {
      setError('Failed to add warranty');
    }
  };

  const updateWarranty = async (id, updates) => {
    try {
      const index = warranties.findIndex(w => w.id === id);
      const updated = { ...warranties[index], ...updates };
      const rowNum = index + 2;
      
      await window.gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId,
        range: `Warranties!A${rowNum}:G${rowNum}`,
        valueInputOption: 'RAW',
        resource: { values: [[updated.id, updated.machineId, updated.startDate, updated.endDate, updated.provider, updated.coverage || '', updated.notes || '']] },
      });
      
      const newWarranties = warranties.map(w => w.id === id ? updated : w);
      setWarranties(newWarranties);
      setModal(null);
      generateAlerts(parts.map(p => [p.id, p.name, p.sku, p.stock, p.minStock, p.cost, p.vendorId, p.locationId, p.notes]), scheduledTasks, newWarranties);
    } catch (err) {
      setError('Failed to update warranty');
    }
  };

  const deleteWarranty = async (id) => {
    if (!window.confirm('Delete this warranty?')) return;
    try {
      const index = warranties.findIndex(w => w.id === id);
      const rowNum = index + 2;
      
      // Clear the row data instead of deleting the dimension
      await window.gapi.client.sheets.spreadsheets.values.clear({
        spreadsheetId,
        range: `Warranties!A${rowNum}:G${rowNum}`,
      });
      
      const newWarranties = warranties.filter(w => w.id !== id);
      setWarranties(newWarranties);
      generateAlerts(parts.map(p => [p.id, p.name, p.sku, p.stock, p.minStock, p.cost, p.vendorId, p.locationId, p.notes]), scheduledTasks, newWarranties);
    } catch (err) {
      console.error('Delete warranty error:', err);
      setError('Failed to delete warranty');
    }
  };

  // Machine Notes CRUD - Sprint 4.1
  const addMachineNote = async (machineId, noteText) => {
    if (!noteText || noteText.trim() === '') return;
    
    const newNote = {
      id: Date.now().toString(),
      machineId,
      date: new Date().toISOString(),
      note: noteText.trim(),
      user: 'User'
    };

    try {
      // First, check if Machine Notes sheet exists, create if not
      try {
        await window.gapi.client.sheets.spreadsheets.get({
          spreadsheetId,
          ranges: ['Machine Notes!A1'],
          fields: 'sheets.properties'
        });
      } catch (sheetErr) {
        // Sheet doesn't exist, create it
        console.log('Machine Notes sheet not found, creating...');
        await window.gapi.client.sheets.spreadsheets.batchUpdate({
          spreadsheetId,
          resource: {
            requests: [{
              addSheet: {
                properties: { title: 'Machine Notes' }
              }
            }]
          }
        });
        
        // Add header row
        await window.gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId,
          range: 'Machine Notes!A1:E1',
          valueInputOption: 'RAW',
          resource: { values: [['ID', 'MachineID', 'Date', 'Note', 'User']] }
        });
      }
      
      // Now add the note
      await window.gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId,
        range: 'Machine Notes!A:E',
        valueInputOption: 'RAW',
        resource: { values: [[newNote.id, newNote.machineId, newNote.date, newNote.note, newNote.user]] },
      });
      
      setMachineNotes([...machineNotes, newNote]);
      return true;
    } catch (err) {
      console.error('Add note error:', err);
      setError('Failed to add note: ' + (err.message || err.toString()));
      return false;
    }
  };

  const deleteMachineNote = async (id) => {
    if (!window.confirm('Delete this note?')) return;
    
    try {
      const index = machineNotes.findIndex(n => n.id === id);
      if (index === -1) {
        console.error('Note not found');
        return;
      }
      const rowNum = index + 2;
      
      await window.gapi.client.sheets.spreadsheets.values.clear({
        spreadsheetId,
        range: `Machine Notes!A${rowNum}:E${rowNum}`,
      });
      
      setMachineNotes(machineNotes.filter(n => n.id !== id));
    } catch (err) {
      console.error('Delete note error:', err);
      setError('Failed to delete note: ' + (err.message || err.toString()));
    }
  };

  // Automatic Backup System - Sprint 4.1
  const BACKUP_CONFIG_FILE = 'backup_config.json';
  const MAX_BACKUPS = 30; // Keep last 30 days

  const createBackup = async () => {
    setBackupStatus('Creating backup...');
    try {
      // Create a copy of the current spreadsheet
      const timestamp = new Date().toISOString().replace(/:/g, '-').split('.')[0];
      const backupName = `Backup_${timestamp}`;
      
      const copyResponse = await window.gapi.client.drive.files.copy({
        fileId: spreadsheetId,
        resource: {
          name: backupName,
          parents: [folderId]
        }
      });
      
      const backupId = copyResponse.result.id;
      
      // Save backup info to config
      const newBackup = {
        id: backupId,
        name: backupName,
        timestamp: new Date().toISOString(),
        originalSpreadsheetId: spreadsheetId
      };
      
      const updatedBackups = [newBackup, ...backups].slice(0, MAX_BACKUPS);
      setBackups(updatedBackups);
      setLastBackupTime(new Date().toISOString());
      
      // Save to appDataFolder
      await saveBackupConfig(updatedBackups, new Date().toISOString());
      
      setBackupStatus('Backup created successfully!');
      setTimeout(() => setBackupStatus(''), 3000);
      return true;
    } catch (err) {
      console.error('Backup error:', err);
      setBackupStatus('Backup failed');
      setTimeout(() => setBackupStatus(''), 3000);
      return false;
    }
  };

  const saveBackupConfig = async (backupList, lastTime) => {
    const config = { backups: backupList, lastBackupTime: lastTime };
    const blob = new Blob([JSON.stringify(config)], { type: 'application/json' });
    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify({ name: BACKUP_CONFIG_FILE, parents: ['appDataFolder'] })], { type: 'application/json' }));
    form.append('file', blob);

    const searchResponse = await window.gapi.client.drive.files.list({ 
      spaces: 'appDataFolder', 
      q: `name='${BACKUP_CONFIG_FILE}'`, 
      fields: 'files(id)' 
    });

    if (searchResponse.result.files?.length > 0) {
      await fetch(`https://www.googleapis.com/upload/drive/v3/files/${searchResponse.result.files[0].id}?uploadType=multipart`, {
        method: 'PATCH',
        headers: new Headers({ Authorization: 'Bearer ' + window.gapi.client.getToken().access_token }),
        body: form,
      });
    } else {
      await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: new Headers({ Authorization: 'Bearer ' + window.gapi.client.getToken().access_token }),
        body: form,
      });
    }
  };

  const loadBackupConfig = async () => {
    try {
      const response = await window.gapi.client.drive.files.list({
        spaces: 'appDataFolder',
        q: `name='${BACKUP_CONFIG_FILE}'`,
        fields: 'files(id)',
      });

      if (response.result.files?.length > 0) {
        const fileId = response.result.files[0].id;
        const configResponse = await window.gapi.client.drive.files.get({ fileId, alt: 'media' });
        const config = JSON.parse(configResponse.body);
        setBackups(config.backups || []);
        setLastBackupTime(config.lastBackupTime || null);
        
        // Auto-backup if > 24 hours since last backup
        if (config.lastBackupTime) {
          const hoursSinceBackup = (new Date() - new Date(config.lastBackupTime)) / (1000 * 60 * 60);
          if (hoursSinceBackup >= 24) {
            console.log('Auto-backup: Last backup was', hoursSinceBackup.toFixed(1), 'hours ago');
            await createBackup();
          }
        } else {
          // First time - create initial backup
          await createBackup();
        }
      }
    } catch (err) {
      console.error('Load backup config error:', err);
    }
  };

  const restoreFromBackup = async (backupId, backupName) => {
    if (!window.confirm(`Restore from backup "${backupName}"?\n\nThis will create a new spreadsheet from this backup. Your current spreadsheet will not be affected.`)) {
      return;
    }
    
    setBackupStatus('Restoring from backup...');
    try {
      // Create a copy of the backup
      const copyResponse = await window.gapi.client.drive.files.copy({
        fileId: backupId,
        resource: {
          name: 'Laundromat Maintenance Pro (Restored)',
          parents: [folderId]
        }
      });
      
      const restoredId = copyResponse.result.id;
      
      // Update config to use restored spreadsheet
      setSpreadsheetId(restoredId);
      await saveToCloud(restoredId, folderId);
      
      // Reload data from restored spreadsheet
      await loadAllData(restoredId);
      
      setBackupStatus('Restored successfully! Please refresh the page.');
      alert('Backup restored! The page will refresh to load the restored data.');
      window.location.reload();
    } catch (err) {
      console.error('Restore error:', err);
      setBackupStatus('Restore failed');
      setTimeout(() => setBackupStatus(''), 3000);
    }
  };

  const deleteOldBackups = async () => {
    if (backups.length <= MAX_BACKUPS) return;
    
    const backupsToDelete = backups.slice(MAX_BACKUPS);
    for (const backup of backupsToDelete) {
      try {
        await window.gapi.client.drive.files.delete({ fileId: backup.id });
      } catch (err) {
        console.error('Delete backup error:', err);
      }
    }
    
    const remainingBackups = backups.slice(0, MAX_BACKUPS);
    setBackups(remainingBackups);
    await saveBackupConfig(remainingBackups, lastBackupTime);
  };

  // Maintenance Request Functions - Sprint 5 Step 3
  const submitMaintenanceRequest = async (requestForm) => {
    const newRequest = {
      id: Date.now().toString(),
      machineId: requestForm.machineId,
      submittedBy: currentUser || 'User',
      submittedDate: new Date().toISOString(),
      issue: requestForm.issue.trim(),
      urgency: requestForm.urgency,
      status: 'Pending',
      assignedTo: '',
      notes: (requestForm.notes || '').trim(), // Fixed: null-safe
      resolvedDate: ''
    };

    try {
      // Create sheet if it doesn't exist
      try {
        await window.gapi.client.sheets.spreadsheets.get({
          spreadsheetId,
          ranges: ['Maintenance Requests!A1'],
          fields: 'sheets.properties'
        });
      } catch (sheetErr) {
        console.log('Maintenance Requests sheet not found, creating...');
        await window.gapi.client.sheets.spreadsheets.batchUpdate({
          spreadsheetId,
          resource: {
            requests: [{
              addSheet: {
                properties: { title: 'Maintenance Requests' }
              }
            }]
          }
        });
        
        await window.gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId,
          range: 'Maintenance Requests!A1:J1',
          valueInputOption: 'RAW',
          resource: { values: [['ID', 'MachineID', 'SubmittedBy', 'SubmittedDate', 'Issue', 'Urgency', 'Status', 'AssignedTo', 'Notes', 'ResolvedDate']] }
        });
      }
      
      await window.gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId,
        range: 'Maintenance Requests!A:J',
        valueInputOption: 'RAW',
        resource: { values: [[
          newRequest.id,
          newRequest.machineId,
          newRequest.submittedBy,
          newRequest.submittedDate,
          newRequest.issue,
          newRequest.urgency,
          newRequest.status,
          newRequest.assignedTo,
          newRequest.notes,
          newRequest.resolvedDate
        ]] },
      });
      
      setMaintenanceRequests([...maintenanceRequests, newRequest]);
      setSyncStatus('Request submitted successfully!');
      setTimeout(() => setSyncStatus(''), 3000);
      return true;
    } catch (err) {
      console.error('Submit request error:', err);
      setError('Failed to submit request: ' + (err.message || err.toString()));
      return false;
    }
  };

  const updateMaintenanceRequest = async (id, updates) => {
    try {
      const index = maintenanceRequests.findIndex(r => r.id === id);
      if (index === -1) return false;
      
      const updated = { ...maintenanceRequests[index], ...updates };
      const rowNum = index + 2;
      
      await window.gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId,
        range: `Maintenance Requests!A${rowNum}:J${rowNum}`,
        valueInputOption: 'RAW',
        resource: { values: [[
          updated.id,
          updated.machineId,
          updated.submittedBy,
          updated.submittedDate,
          updated.issue,
          updated.urgency,
          updated.status,
          updated.assignedTo,
          updated.notes,
          updated.resolvedDate
        ]] },
      });
      
      setMaintenanceRequests(maintenanceRequests.map(r => r.id === id ? updated : r));
      return true;
    } catch (err) {
      console.error('Update request error:', err);
      setError('Failed to update request');
      return false;
    }
  };

  // Mark Machine Out of Order - Sprint 5 Step 4
  const markMachineOutOfOrder = async (machineId, reason, notes) => {
    try {
      const updates = {
        status: 'Out of Order',
        outOfOrderReason: reason + (notes ? `: ${notes}` : '')
      };
      
      await updateMachine(machineId, updates);
      setSyncStatus('Machine marked out of order');
      setTimeout(() => setSyncStatus(''), 3000);
      return true;
    } catch (err) {
      console.error('Mark out of order error:', err);
      setError('Failed to mark machine out of order');
      return false;
    }
  };

  const markMachineInService = async (machineId) => {
    try {
      const updates = {
        status: 'In Service',
        outOfOrderReason: ''
      };
      
      await updateMachine(machineId, updates);
      setSyncStatus('Machine marked back in service');
      setTimeout(() => setSyncStatus(''), 3000);
      return true;
    } catch (err) {
      console.error('Mark in service error:', err);
      setError('Failed to mark machine in service');
      return false;
    }
  };

  // Resolve Request - Sprint 5 Step 7
  const resolveMaintenanceRequest = async (requestId) => {
    const notes = prompt('Resolution notes (optional):');
    if (notes === null) return; // User cancelled
    
    const success = await updateMaintenanceRequest(requestId, {
      status: 'Resolved',
      resolvedDate: new Date().toISOString(),
      notes: notes || ''
    });
    
    if (success) {
      setSyncStatus('Request marked as resolved');
      setTimeout(() => setSyncStatus(''), 3000);
    }
  };

  // Convert Request to Repair - Sprint 5 Step 7
  const convertRequestToRepair = (request) => {
    const machine = machines.find(m => m.id === request.machineId);
    if (!machine) {
      alert('Machine not found');
      return;
    }
    
    // Update request status to In Progress
    updateMaintenanceRequest(request.id, { status: 'In Progress' });
    
    // Open repair modal with prefilled data
    setModal({
      type: 'addRepair',
      data: {
        prefill: {
          machineId: request.machineId,
          issue: request.issue,
          notes: `From request #${request.id} by ${request.submittedBy}\n${request.notes || ''}`
        }
      }
    });
  };

  // Import Parts from Receipt (PDF)
  const importPartsFromReceipt = async (items, pdfFile = null) => {
    setSyncStatus('Importing parts...');
    
    // Upload PDF receipt to Parts Receipts folder if provided
    let receiptFileId = null;
    if (pdfFile && folderStructure) {
      try {
        const today = new Date();
        const dateStr = today.toISOString().split('T')[0].replace(/-/g, '');
        const vendorName = items[0]?.vendor || 'receipt';
        const vendorShort = vendorName.substring(0, 20).replace(/[^a-z0-9]/gi, '').toLowerCase();
        const smartName = `${dateStr}_${vendorShort}_receipt.pdf`;
        
        const targetFolder = await getTargetFolder(folderStructure.receipts, today, 'receipts');
        const uploaded = await uploadFile(pdfFile, targetFolder, smartName);
        receiptFileId = uploaded.id;
      } catch (err) {
        console.error('Failed to upload receipt PDF:', err);
        // Continue with import even if PDF upload fails
      }
    }
    
    try {
      const newParts = [];
      const updatedParts = [];
      
      for (const item of items) {
        if (item.action === 'skip') continue;
        
        if (item.action === 'new' || !item.matchedPart) {
          // Create new part
          const newPart = {
            id: Date.now().toString() + Math.random(),
            name: item.name,
            sku: item.sku,
            stock: item.qty.toString(),
            minStock: Math.max(1, Math.floor(item.qty / 2)).toString(),
            cost: item.price.toString(),
            vendorId: vendors[0]?.id || '',
            locationId: selectedLocation === 'all' ? locations[0]?.id : selectedLocation,
            notes: 'Imported from receipt'
          };
          
          await window.gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId,
            range: 'Parts Inventory!A:K',
            valueInputOption: 'RAW',
            resource: { values: [[newPart.id, newPart.name, newPart.sku, newPart.stock, newPart.minStock, newPart.cost, newPart.vendorId, newPart.locationId, newPart.notes, 'false', '']] },
          });
          
          newParts.push(newPart);
        } else {
          // Update existing part
          const partIndex = parts.findIndex(p => p.id === item.matchedPart.id);
          if (partIndex >= 0) {
            const currentStock = parseInt(parts[partIndex].stock || 0);
            const newStock = (currentStock + item.qty).toString();
            const newCost = item.price.toString(); // Update to new price
            
            await window.gapi.client.sheets.spreadsheets.values.update({
              spreadsheetId,
              range: `Parts Inventory!D${partIndex + 2}:F${partIndex + 2}`,
              valueInputOption: 'RAW',
              resource: { values: [[newStock, parts[partIndex].minStock, newCost]] },
            });
            
            parts[partIndex].stock = newStock;
            parts[partIndex].cost = newCost;
            updatedParts.push(parts[partIndex]);
          }
        }
      }
      
      setParts([...parts, ...newParts]);
      await loadAllData(spreadsheetId);
      setModal(null);
      setSyncStatus('');
      alert(`Import complete!\n\nAdded: ${newParts.length} new parts\nUpdated: ${updatedParts.length} existing parts`);
    } catch (err) {
      setError('Failed to import: ' + err.message);
      setSyncStatus('');
    }
  };

  if (isInitializing) {
    return <div className="min-h-screen bg-zinc-900 flex items-center justify-center"><div className="text-teal-400 text-2xl font-black animate-pulse">MAINTENANCE PRO</div></div>;
  }

  if (!isSignedIn) {
    return (
      <div className="min-h-screen bg-zinc-900 flex items-center justify-center p-4">
        <div className="bg-zinc-800 border-4 border-teal-600 p-8 max-w-md">
          <h1 className="text-4xl font-black text-teal-400 mb-2">MAINTENANCE PRO</h1>
          <p className="text-zinc-400 mb-6 font-bold">Sprint 3 - Complete System</p>
          <div className="bg-zinc-900 border-2 border-zinc-700 p-4 mb-6 space-y-1 text-sm text-zinc-300">
            <p>‚úÖ Clickable Logs with Details</p>
            <p>‚úÖ Photo Slideshow Gallery</p>
            <p>‚úÖ Edit & Lock Repairs</p>
            <p>‚úÖ Scheduled Maintenance</p>
            <p>‚úÖ Warranty Tracking</p>
            <p>‚úÖ Full Professional System</p>
          </div>
          <button onClick={() => window.tokenClient.requestAccessToken()} className="w-full bg-teal-600 hover:bg-teal-500 text-white px-6 py-4 font-black border-2 border-teal-700">
            SIGN IN WITH GOOGLE
          </button>
        </div>
      </div>
    );
  }

  const activeMachines = machines.filter(m => !m.archived && (selectedLocation === 'all' || m.locationId === selectedLocation));
  const displayMachines = showArchived ? machines.filter(m => selectedLocation === 'all' || m.locationId === selectedLocation) : activeMachines;
  const currentLogs = selectedLocation === 'all' ? equipmentLogs : equipmentLogs.filter(l => l.locationId === selectedLocation);
  const currentBldg = selectedLocation === 'all' ? buildingLogs : buildingLogs.filter(l => l.locationId === selectedLocation);
  const equipTotal = currentLogs.filter(l => new Date(l.date).getFullYear() === year).reduce((s, l) => s + parseFloat(l.cost || 0), 0);
  const bldgTotal = currentBldg.filter(l => new Date(l.date).getFullYear() === year).reduce((s, l) => s + parseFloat(l.cost || 0), 0);
  const yearTotal = equipTotal + bldgTotal;
  
  const years = [...new Set([...currentLogs.map(l => new Date(l.date).getFullYear()), ...currentBldg.map(l => new Date(l.date).getFullYear())])].sort((a,b) => b-a);
  if (years.length === 0) years.push(year);

  return (
    <div className="min-h-screen bg-zinc-900 text-white">
      <header className="bg-gradient-to-r from-slate-700 to-slate-600 border-b-4 border-slate-800">
        <div className="max-w-7xl mx-auto px-4 py-6">
          <div className="flex justify-between items-center flex-wrap gap-4">
            <div>
              <h1 className="text-4xl font-black text-white">MAINTENANCE PRO</h1>
              <p className="text-slate-200 text-sm font-bold">Sprint 3 Complete</p>
            </div>
            
            <div className="flex gap-3 items-center flex-wrap">
              {syncStatus && <div className="bg-zinc-800 border-2 border-teal-500 px-3 py-2 text-teal-400 text-sm font-bold">{syncStatus}</div>}
              {locations.length > 1 && (
                <select value={selectedLocation} onChange={e => setSelectedLocation(e.target.value)} className="bg-zinc-800 border-2 border-teal-500 text-teal-400 px-3 py-2 font-bold text-sm">
                  <option value="all">All Locations</option>
                  {locations.map(l => <option key={l.id} value={l.id}>{l.name}</option>)}
                </select>
              )}
              <button onClick={() => loadAllData(spreadsheetId)} disabled={loading} className="bg-zinc-800 border-2 border-teal-500 text-teal-400 px-3 py-2 font-bold hover:bg-zinc-700 flex items-center gap-2 text-sm">
                <Icon name="refresh" size={16} />
                {loading ? 'SYNCING' : 'REFRESH'}
              </button>
              <select value={year} onChange={e => setYear(+e.target.value)} className="bg-zinc-800 border-2 border-teal-500 text-teal-400 px-3 py-2 font-bold text-sm">
                {years.map(y => <option key={y}>{y}</option>)}
              </select>
              <div className="bg-zinc-800 border-2 border-teal-500 px-4 py-2">
                <div className="text-xs text-teal-400 font-bold">ANNUAL</div>
                <div className="text-xl font-black text-white">${yearTotal.toFixed(2)}</div>
                <div className="text-xs text-zinc-400">E: ${equipTotal.toFixed(2)} | B: ${bldgTotal.toFixed(2)}</div>
              </div>
            </div>
          </div>
          
          <div ref={tabScrollRef} className="flex gap-2 mt-4 border-t-2 border-slate-500 pt-4 overflow-x-auto horizontal-scroll">
            {roleLoading ? (
              // Show loading skeleton while detecting role
              <div className="flex gap-2 animate-pulse">
                <div className="h-10 w-32 bg-zinc-700 border-2 border-zinc-600"></div>
                <div className="h-10 w-32 bg-zinc-700 border-2 border-zinc-600"></div>
                <div className="h-10 w-32 bg-zinc-700 border-2 border-zinc-600"></div>
              </div>
            ) : (
              // Show actual tabs after role is loaded
              [
                { id: 'dashboard', icon: 'dashboard', label: 'DASHBOARD', requiresPermission: null },
                { id: 'equipment', icon: 'wrench', label: 'EQUIPMENT', requiresPermission: 'canAccessAllTabs' },
                { id: 'repairs', icon: 'calendar', label: 'REPAIRS', requiresPermission: 'canAccessAllTabs' },
                { id: 'calendar', icon: 'calendar', label: 'CALENDAR', requiresPermission: 'canAccessAllTabs' },
                { id: 'building', icon: 'home', label: 'BUILDING', requiresPermission: 'canAccessAllTabs' },
                { id: 'vendors', icon: 'users', label: 'VENDORS', requiresPermission: 'canEdit' },
                { id: 'inventory', icon: 'package', label: 'INVENTORY', requiresPermission: 'canAccessAllTabs' },
                { id: 'scheduled', icon: 'clock', label: 'SCHEDULED', requiresPermission: 'canAccessAllTabs' },
                { id: 'warranties', icon: 'shield', label: 'WARRANTIES', requiresPermission: 'canAccessAllTabs' },
                { id: 'requests', icon: 'alert', label: 'REQUESTS', requiresPermission: 'canEdit' },
                { id: 'reports', icon: 'chart', label: 'REPORTS', requiresPermission: 'canAccessAllTabs' },
                { id: 'settings', icon: 'settings', label: 'SETTINGS', requiresPermission: 'canAccessSettings' },
              ].filter(tab => !tab.requiresPermission || permissions[tab.requiresPermission]).map(tab => (
                <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`px-4 py-2 font-black border-2 flex items-center gap-2 whitespace-nowrap text-sm ${activeTab === tab.id ? 'bg-teal-600 text-white border-teal-700' : 'bg-zinc-800 text-teal-400 border-zinc-700 hover:bg-zinc-700'}`}>
                  <Icon name={tab.icon} size={18} />
                  {tab.label}
                </button>
              ))
            )}
          </div>
          </div>
        </div>
      </header>

      {error && (
        <div className="max-w-7xl mx-auto px-4 py-3">
          <div className="bg-red-900 border-2 border-red-600 px-4 py-3 text-white font-bold flex justify-between">
            <span>{error}</span>
            <button onClick={() => setError(null)}>&times;</button>
          </div>
        </div>
      )}

      <main className="max-w-7xl mx-auto px-4 py-6">
        {activeTab === 'dashboard' && (
          <Dashboard
            alerts={alerts}
            machines={activeMachines}
            equipmentLogs={currentLogs.filter(l => new Date(l.date).getFullYear() === year)}
            buildingLogs={currentBldg.filter(l => new Date(l.date).getFullYear() === year)}
            parts={parts.filter(p => selectedLocation === 'all' || p.locationId === selectedLocation)}
            year={year}
            maintenanceRequests={maintenanceRequests}
            permissions={permissions}
            onSubmitRequest={() => setModal({ type: 'submitRequest' })}
            onViewRequest={(request) => setModal({ type: 'viewRequest', data: request })}
          />
        )}
        {activeTab === 'equipment' && (
          <EquipmentTab
            machines={displayMachines}
            logs={currentLogs}
            year={year}
            showArchived={showArchived}
            setShowArchived={setShowArchived}
            onAdd={() => setModal({ type: 'addMachine' })}
            onEdit={(machine) => setModal({ type: 'editMachine', data: machine })}
            onDelete={deleteMachine}
            onArchive={archiveMachine}
            onUnarchive={unarchiveMachine}
            machineNotes={machineNotes}
            onAddNote={addMachineNote}
            onDeleteNote={deleteMachineNote}
            permissions={permissions}
            onMarkOutOfOrder={(machine) => setModal({ type: 'outOfOrder', data: machine })}
          />
        )}
        {activeTab === 'repairs' && (
          <RepairsTab
            logs={currentLogs.filter(l => new Date(l.date).getFullYear() === year)}
            machines={machines.filter(m => selectedLocation === 'all' || m.locationId === selectedLocation)}
            parts={parts.filter(p => selectedLocation === 'all' || p.locationId === selectedLocation)}
            partsUsage={partsUsage}
            onAdd={() => setModal({ type: 'addRepair' })}
            onView={(log) => setModal({ type: 'viewRepair', data: log })}
            permissions={permissions}
          />
        )}
        {activeTab === 'calendar' && (
          <CalendarTab
            equipmentLogs={currentLogs}
            buildingLogs={currentBldg}
            scheduledTasks={scheduledTasks}
            machines={machines.filter(m => selectedLocation === 'all' || m.locationId === selectedLocation)}
            year={year}
            onViewRepair={(log) => setModal({ type: 'viewRepair', data: log })}
            onViewBuilding={(log) => setModal({ type: 'viewBuilding', data: log })}
            onViewTask={(task) => setModal({ type: 'viewTask', data: task })}
          />
        )}
        {activeTab === 'building' && (
          <BuildingTab
            logs={currentBldg.filter(l => new Date(l.date).getFullYear() === year)}
            onAdd={() => setModal({ type: 'addBuilding' })}
            onView={(log) => setModal({ type: 'viewBuilding', data: log })}
            permissions={permissions}
          />
        )}
        {activeTab === 'vendors' && (
          <VendorsTab
            vendors={vendors}
            equipmentLogs={currentLogs}
            buildingLogs={currentBldg}
            onAdd={() => setModal({ type: 'addVendor' })}
            onEdit={(vendor) => setModal({ type: 'editVendor', data: vendor })}
            onDelete={deleteVendor}
          />
        )}
        {activeTab === 'inventory' && (
          <InventoryTab
            parts={parts.filter(p => selectedLocation === 'all' || p.locationId === selectedLocation)}
            partsUsage={partsUsage}
            vendors={vendors}
            onAdd={() => setModal({ type: 'addPart' })}
            onEdit={(part) => setModal({ type: 'editPart', data: part })}
            onDelete={deletePart}
            onImport={() => setModal({ type: 'importReceipt' })}
            permissions={permissions}
          />
        )}
        {activeTab === 'requests' && (
          <RequestManagementTab
            requests={maintenanceRequests}
            machines={machines}
            onResolve={resolveMaintenanceRequest}
            onConvert={convertRequestToRepair}
            permissions={permissions}
          />
        )}
        {activeTab === 'reports' && (
          <ReportsTab
            machines={activeMachines}
            equipmentLogs={currentLogs}
            buildingLogs={currentBldg}
            parts={parts.filter(p => selectedLocation === 'all' || p.locationId === selectedLocation)}
            partsUsage={partsUsage}
            year={year}
          />
        )}
        {activeTab === 'scheduled' && (
          <ScheduledMaintenanceTab
            tasks={scheduledTasks}
            machines={machines.filter(m => selectedLocation === 'all' || m.locationId === selectedLocation)}
            onAdd={() => setModal({ type: 'addTask' })}
            onEdit={(task) => setModal({ type: 'editTask', data: task })}
            onComplete={completeScheduledTask}
            onDelete={deleteScheduledTask}
            onAddBulk={() => setModal({ type: 'bulkSchedule' })}
            onShowHistory={() => setModal({ type: 'maintenanceHistory' })}
          />
        )}
        {activeTab === 'warranties' && (
          <WarrantiesTab
            warranties={warranties.filter(w => {
              const machine = machines.find(m => m.id === w.machineId);
              return selectedLocation === 'all' || machine?.locationId === selectedLocation;
            })}
            machines={machines.filter(m => selectedLocation === 'all' || m.locationId === selectedLocation)}
            onAdd={() => setModal({ type: 'addWarranty' })}
            onEdit={(warranty) => setModal({ type: 'editWarranty', data: warranty })}
            onDelete={deleteWarranty}
          />
        )}
        {activeTab === 'settings' && (
            <SettingsTab
            currentUser={currentUser}
            userRole={userRole}
            backups={backups}
            lastBackupTime={lastBackupTime}
            backupStatus={backupStatus}
            onBackupNow={createBackup}
            onRestore={restoreFromBackup}
            spreadsheetId={spreadsheetId}
            machines={machines}
            equipmentLogs={equipmentLogs}
            buildingLogs={buildingLogs}
            parts={parts}
            partsUsage={partsUsage}
            scheduledTasks={scheduledTasks}
            warranties={warranties}
            year={year}
          />
        )}
      </main>

      {modal?.type === 'addMachine' && <MachineModal onClose={() => setModal(null)} onSave={addMachine} />}
      {modal?.type === 'editMachine' && <MachineModal machine={modal.data} onClose={() => setModal(null)} onSave={(updates) => updateMachine(modal.data.id, updates)} />}
      {modal?.type === 'addRepair' && <RepairModal machines={machines.filter(m => selectedLocation === 'all' || m.locationId === selectedLocation)} parts={parts.filter(p => selectedLocation === 'all' || p.locationId === selectedLocation)} onClose={() => setModal(null)} onSave={addEquipmentLog} prefill={modal.data?.prefill} />}
      {modal?.type === 'addBuilding' && <BuildingModal onClose={() => setModal(null)} onSave={addBuildingLog} />}
      {modal?.type === 'addVendor' && <VendorModal onClose={() => setModal(null)} onSave={addVendor} />}
      {modal?.type === 'editVendor' && <VendorModal vendor={modal.data} onClose={() => setModal(null)} onSave={(updates) => updateVendor(modal.data.id, updates)} />}
      {modal?.type === 'addPart' && <PartModal vendors={vendors} onClose={() => setModal(null)} onSave={addPart} />}
      {modal?.type === 'editPart' && <PartModal part={modal.data} vendors={vendors} onClose={() => setModal(null)} onSave={(updates) => updatePart(modal.data.id, updates)} />}
      {modal?.type === 'viewRepair' && <RepairDetailModal log={modal.data} machines={machines} parts={parts} onClose={() => setModal(null)} onEdit={(log) => setModal({ type: 'editRepair', data: log })} />}
      {modal?.type === 'editRepair' && !modal.data?.addParts && <EditRepairModal log={modal.data} machines={machines} onClose={() => setModal(null)} onSave={(updates) => updateEquipmentLog(modal.data.id, updates)} onAddParts={() => setModal({ type: 'editRepair', data: { ...modal.data, addParts: true } })} />}
      {modal?.type === 'editRepair' && modal.data?.addParts && <AddPartsToRepairModal log={modal.data} parts={parts.filter(p => selectedLocation === 'all' || p.locationId === selectedLocation)} partsUsage={partsUsage} onClose={() => setModal(null)} onSave={addPartsToRepair} />}
      {modal?.type === 'viewBuilding' && <BuildingDetailModal log={modal.data} onClose={() => setModal(null)} onEdit={(log) => setModal({ type: 'editBuilding', data: log })} />}
      {modal?.type === 'editBuilding' && <EditBuildingModal log={modal.data} onClose={() => setModal(null)} onSave={(updates) => updateBuildingLog(modal.data.id, updates)} />}
      {modal?.type === 'addTask' && <ScheduledTaskModal machines={machines.filter(m => !m.archived)} onClose={() => setModal(null)} onSave={addScheduledTask} />}
      {modal?.type === 'editTask' && <ScheduledTaskModal task={modal.data} machines={machines.filter(m => !m.archived)} onClose={() => setModal(null)} onSave={(updates) => updateScheduledTask(modal.data.id, updates)} />}
      {modal?.type === 'viewTask' && <ScheduledTaskDetailModal task={modal.data} machines={machines} onClose={() => setModal(null)} onEdit={(task) => setModal({ type: 'editTask', data: task })} />}
      {modal?.type === 'addWarranty' && <WarrantyModal machines={machines.filter(m => !m.archived)} onClose={() => setModal(null)} onSave={addWarranty} />}
      {modal?.type === 'editWarranty' && <WarrantyModal warranty={modal.data} machines={machines.filter(m => !m.archived)} onClose={() => setModal(null)} onSave={(updates) => updateWarranty(modal.data.id, updates)} />}
      {modal?.type === 'bulkSchedule' && <BulkScheduleModal machines={machines.filter(m => selectedLocation === 'all' || m.locationId === selectedLocation)} onClose={() => setModal(null)} onSave={createBulkSchedule} />}
      {/* {modal?.type === 'maintenanceHistory' && <MaintenanceHistoryModal history={maintenanceHistory} onClose={() => setModal(null)} onExport={exportHistory} />} */}
      {modal?.type === 'importReceipt' && <ImportReceiptModal parts={parts} vendors={vendors} onClose={() => setModal(null)} onImport={importPartsFromReceipt} />}
      {/* Sprint 5 Modals */}
      {modal?.type === 'submitRequest' && <MaintenanceRequestModal machines={machines} currentUser={currentUser} onClose={() => setModal(null)} onSubmit={submitMaintenanceRequest} />}
      {modal?.type === 'outOfOrder' && modal.data && <OutOfOrderModal machine={modal.data} onClose={() => setModal(null)} onSave={markMachineOutOfOrder} />}
    </div>
  );
};

// ============================================================================
// REQUEST SETTINGS COMPONENT
// ============================================================================

const RequestSettingsSection = ({ currentUser, userRole }) => {
  const [teamConfig, setTeamConfig] = useState(null);
  const [loading, setLoading] = useState(true);
  const [editingMachineTypes, setEditingMachineTypes] = useState(false);
  const [editingProblemTypes, setEditingProblemTypes] = useState(false);
  const [newMachineType, setNewMachineType] = useState('');
  const [newProblemType, setNewProblemType] = useState('');
  const [notificationEmail, setNotificationEmail] = useState('');
  
  useEffect(() => {
    loadConfig();
  }, []);
  
  const loadConfig = async () => {
    setLoading(true);
    let config = await loadSharedConfig();
    
    if (!config) {
      config = createInitialTeamConfig(currentUser);
      await saveSharedConfig(config);
    }
    
    if (!config.requestSettings) {
      config.requestSettings = {
        machineTypes: DEFAULT_REQUEST_SETTINGS.machineTypes,
        problemTypes: DEFAULT_REQUEST_SETTINGS.problemTypes,
        dryerLocations: DEFAULT_REQUEST_SETTINGS.dryerLocations,
        notificationEmail: DEFAULT_REQUEST_SETTINGS.notificationEmail
      };
      await saveSharedConfig(config);
    }
    
    setTeamConfig(config);
    setNotificationEmail(config.requestSettings.notificationEmail);
    setLoading(false);
  };
  
  const addMachineType = async () => {
    if (!newMachineType.trim()) return;
    
    if (teamConfig.requestSettings.machineTypes.includes(newMachineType.trim())) {
      alert('This machine type already exists');
      return;
    }
    
    teamConfig.requestSettings.machineTypes.push(newMachineType.trim());
    teamConfig.updatedBy = currentUser;
    
    const saved = await saveSharedConfig(teamConfig);
    if (saved) {
      setTeamConfig({...teamConfig});
      setNewMachineType('');
      alert('‚úÖ Machine type added');
    }
  };
  
  const removeMachineType = async (type) => {
    const confirmed = confirm(`Remove machine type: ${type}?`);
    if (!confirmed) return;
    
    teamConfig.requestSettings.machineTypes = teamConfig.requestSettings.machineTypes.filter(t => t !== type);
    teamConfig.updatedBy = currentUser;
    
    const saved = await saveSharedConfig(teamConfig);
    if (saved) {
      setTeamConfig({...teamConfig});
      alert('‚úÖ Machine type removed');
    }
  };
  
  const addProblemType = async () => {
    if (!newProblemType.trim()) return;
    
    if (teamConfig.requestSettings.problemTypes.includes(newProblemType.trim())) {
      alert('This problem type already exists');
      return;
    }
    
    teamConfig.requestSettings.problemTypes.push(newProblemType.trim());
    teamConfig.updatedBy = currentUser;
    
    const saved = await saveSharedConfig(teamConfig);
    if (saved) {
      setTeamConfig({...teamConfig});
      setNewProblemType('');
      alert('‚úÖ Problem type added');
    }
  };
  
  const removeProblemType = async (type) => {
    const confirmed = confirm(`Remove problem type: ${type}?`);
    if (!confirmed) return;
    
    teamConfig.requestSettings.problemTypes = teamConfig.requestSettings.problemTypes.filter(t => t !== type);
    teamConfig.updatedBy = currentUser;
    
    const saved = await saveSharedConfig(teamConfig);
    if (saved) {
      setTeamConfig({...teamConfig});
      alert('‚úÖ Problem type removed');
    }
  };
  
  const updateNotificationEmail = async () => {
    if (!notificationEmail.includes('@')) {
      alert('Please enter a valid email address');
      return;
    }
    
    teamConfig.requestSettings.notificationEmail = notificationEmail;
    teamConfig.updatedBy = currentUser;
    
    const saved = await saveSharedConfig(teamConfig);
    if (saved) {
      setTeamConfig({...teamConfig});
      alert('‚úÖ Notification email updated');
    }
  };
  
  if (userRole !== 'owner') {
    return null;
  }
  
  if (loading) {
    return (
      <div className="bg-zinc-900 border-2 border-zinc-700 p-6 mt-6">
        <h3 className="text-xl font-black text-teal-400 mb-4">üîß MAINTENANCE REQUEST SETTINGS</h3>
        <p className="text-zinc-400">Loading settings...</p>
      </div>
    );
  }
  
  return (
    <div className="bg-zinc-900 border-2 border-zinc-700 p-6 mt-6">
      <h3 className="text-xl font-black text-teal-400 mb-4">üîß MAINTENANCE REQUEST SETTINGS</h3>
      
      <div className="mb-6">
        <h4 className="text-lg font-bold text-zinc-300 mb-3">Email Notifications</h4>
        <div className="flex gap-3">
          <input
            type="email"
            value={notificationEmail}
            onChange={(e) => setNotificationEmail(e.target.value)}
            placeholder="email@example.com"
            className="flex-1 bg-zinc-800 border border-zinc-700 text-zinc-200 px-3 py-2"
          />
          <button
            onClick={updateNotificationEmail}
            className="bg-teal-600 hover:bg-teal-500 text-white px-4 py-2 font-bold"
          >
            üíæ SAVE
          </button>
        </div>
        <p className="text-xs text-zinc-500 mt-2">
          You'll receive an email when maintenance requests are submitted
        </p>
      </div>
      
      <div className="mb-6">
        <div className="flex items-center justify-between mb-3">
          <h4 className="text-lg font-bold text-zinc-300">Machine Types</h4>
          <button
            onClick={() => setEditingMachineTypes(!editingMachineTypes)}
            className="text-sm text-teal-400 hover:text-teal-300"
          >
            {editingMachineTypes ? '‚úì Done' : '‚úèÔ∏è Edit'}
          </button>
        </div>
        
        <div className="space-y-2">
          {teamConfig.requestSettings.machineTypes.map(type => (
            <div key={type} className="bg-zinc-800 border border-zinc-700 p-2 flex items-center justify-between">
              <span className="text-zinc-200">{type}</span>
              {editingMachineTypes && (
                <button
                  onClick={() => removeMachineType(type)}
                  className="text-red-400 hover:text-red-300 text-sm"
                >
                  ‚ùå Remove
                </button>
              )}
            </div>
          ))}
        </div>
        
        {editingMachineTypes && (
          <div className="mt-3 flex gap-2">
            <input
              type="text"
              value={newMachineType}
              onChange={(e) => setNewMachineType(e.target.value)}
              placeholder="New machine type"
              className="flex-1 bg-zinc-800 border border-zinc-700 text-zinc-200 px-3 py-2"
              onKeyPress={(e) => e.key === 'Enter' && addMachineType()}
            />
            <button
              onClick={addMachineType}
              className="bg-teal-600 hover:bg-teal-500 text-white px-4 py-2 font-bold"
            >
              ‚ûï ADD
            </button>
          </div>
        )}
      </div>
      
      <div>
        <div className="flex items-center justify-between mb-3">
          <h4 className="text-lg font-bold text-zinc-300">Problem Types</h4>
          <button
            onClick={() => setEditingProblemTypes(!editingProblemTypes)}
            className="text-sm text-teal-400 hover:text-teal-300"
          >
            {editingProblemTypes ? '‚úì Done' : '‚úèÔ∏è Edit'}
          </button>
        </div>
        
        <div className="grid grid-cols-2 gap-2">
          {teamConfig.requestSettings.problemTypes.map(type => (
            <div key={type} className="bg-zinc-800 border border-zinc-700 p-2 flex items-center justify-between">
              <span className="text-zinc-200 text-sm">{type}</span>
              {editingProblemTypes && (
                <button
                  onClick={() => removeProblemType(type)}
                  className="text-red-400 hover:text-red-300 text-xs ml-2"
                >
                  ‚ùå
                </button>
              )}
            </div>
          ))}
        </div>
        
        {editingProblemTypes && (
          <div className="mt-3 flex gap-2">
            <input
              type="text"
              value={newProblemType}
              onChange={(e) => setNewProblemType(e.target.value)}
              placeholder="New problem type"
              className="flex-1 bg-zinc-800 border border-zinc-700 text-zinc-200 px-3 py-2"
              onKeyPress={(e) => e.key === 'Enter' && addProblemType()}
            />
            <button
              onClick={addProblemType}
              className="bg-teal-600 hover:bg-teal-500 text-white px-4 py-2 font-bold"
            >
              ‚ûï ADD
            </button>
          </div>
        )}
      </div>
      
      <div className="mt-6 p-4 bg-zinc-800 border border-zinc-700">
        <div className="text-sm text-zinc-400">
          <div className="font-bold text-zinc-300 mb-2">‚ÑπÔ∏è About These Settings:</div>
          <div>‚Ä¢ Machine Types: Used to filter the machine dropdown in maintenance requests</div>
          <div>‚Ä¢ Problem Types: Quick-select options for common issues</div>
          <div>‚Ä¢ Dryer Location: Automatically shown when "Dryer" is selected</div>
          <div>‚Ä¢ All team members will see these options when submitting requests</div>
        </div>
      </div>
    </div>
  );
};

// ============================================================================
// TEAM MANAGEMENT COMPONENT
// ============================================================================

const TeamManagementSection = ({ currentUser, userRole }) => {
  const [teamConfig, setTeamConfig] = useState(null);
  const [loading, setLoading] = useState(true);
  const [newEmail, setNewEmail] = useState('');
  const [newRole, setNewRole] = useState('technician');
  const [spreadsheetId, setSpreadsheetIdLocal] = useState('');
  
  useEffect(() => {
    loadTeamConfig();
    const interval = setInterval(loadTeamConfig, 30000);
    return () => clearInterval(interval);
  }, []);
  
  const loadTeamConfig = async () => {
    setLoading(true);
    
    // Get spreadsheet ID
    const spreadsheetId = getSpreadsheetIdFromUrl();
    
    if (!spreadsheetId) {
      console.log('‚ö†Ô∏è No spreadsheet loaded yet, waiting...');
      setLoading(false);
      return;
    }
    
    console.log('üìä TeamManagement: Loading config from spreadsheet:', spreadsheetId);
    let config = await loadSharedConfig(spreadsheetId);
    
    if (!config) {
      console.log('‚ÑπÔ∏è No team config found - sheets may need initialization');
      setTeamConfig(null);
      setLoading(false);
      return;
    }
    
    setTeamConfig(config);
    setSpreadsheetIdLocal(config.sharedSpreadsheetId || spreadsheetId);
    setLoading(false);
  };
  
  const addTeamMember = async () => {
    if (!newEmail || !newEmail.includes('@')) {
      alert('Please enter a valid email address');
      return;
    }
    
    if (teamConfig.teamMembers.find(m => m.email === newEmail)) {
      alert('This email is already in the team');
      return;
    }
    
    const newMember = {
      email: newEmail,
      role: newRole,
      isFounder: false,
      addedDate: new Date().toISOString(),
      addedBy: currentUser
    };
    
    teamConfig.teamMembers.push(newMember);
    teamConfig.updatedBy = currentUser;
    
    const saved = await saveSharedConfig(teamConfig);
    
    if (saved) {
      setTeamConfig({...teamConfig});
      setNewEmail('');
      alert(
        `‚úÖ ${newEmail} added as ${newRole}\n\n` +
        `Next steps:\n` +
        `1. Share the spreadsheet with them in Google Drive\n` +
        `2. Set permission to "Editor"\n` +
        `3. They can now sign in to the app`
      );
    }
  };
  
  const changeRole = async (email, newRoleValue) => {
    const member = teamConfig.teamMembers.find(m => m.email === email);
    const oldRole = member.role;
    
    if (oldRole === 'owner' && newRoleValue !== 'owner') {
      const ownerCount = teamConfig.teamMembers.filter(m => m.role === 'owner').length;
      if (ownerCount <= REMOVAL_CONFIG.minimumOwners) {
        alert('Cannot change the only owner\'s role. Add another owner first.');
        return;
      }
    }
    
    const confirmed = confirm(
      `Change role for ${email}?\n\n` +
      `From: ${oldRole}\n` +
      `To: ${newRoleValue}\n\n` +
      `Continue?`
    );
    
    if (!confirmed) return;
    
    member.role = newRoleValue;
    teamConfig.updatedBy = currentUser;
    
    const saved = await saveSharedConfig(teamConfig);
    if (saved) {
      setTeamConfig({...teamConfig});
      alert(`‚úÖ Role updated. ${email} will see new permissions on next sign-in.`);
    }
  };
  
  const removeMember = async (email) => {
    const member = teamConfig.teamMembers.find(m => m.email === email);
    
    if (!member) return;
    
    if (email === currentUser) {
      alert('You cannot remove yourself. Ask another owner to remove you.');
      return;
    }
    
    let removed = false;
    
    if (member.isFounder && member.role === 'owner') {
      removed = await removeFoundingOwner(teamConfig, email, currentUser);
    } else if (member.role === 'owner') {
      const canRemove = canRemoveOwner(teamConfig, email);
      if (!canRemove.allowed) {
        alert(`‚ùå ${canRemove.reason}`);
        return;
      }
      removed = await removeRegularMember(teamConfig, email, currentUser);
    } else {
      removed = await removeRegularMember(teamConfig, email, currentUser);
    }
    
    if (removed) {
      await loadTeamConfig();
    }
  };
  
  const setSharedSpreadsheet = async () => {
    if (!spreadsheetId) {
      alert('Please enter a spreadsheet ID');
      return;
    }
    
    const confirmed = confirm(
      `Set this as the shared spreadsheet?\n\n` +
      `ID: ${spreadsheetId}\n\n` +
      `All team members will use this spreadsheet.\n\n` +
      `Continue?`
    );
    
    if (!confirmed) return;
    
    teamConfig.sharedSpreadsheetId = spreadsheetId;
    teamConfig.updatedBy = currentUser;
    
    const saved = await saveSharedConfig(teamConfig);
    if (saved) {
      setTeamConfig({...teamConfig});
      alert('‚úÖ Shared spreadsheet set! Team members will use this on next sign-in.');
    }
  };
  
  if (userRole !== 'owner') {
    return (
      <div className="bg-zinc-900 border-2 border-zinc-700 p-6 mt-6">
        <h3 className="text-xl font-black text-teal-400 mb-4">üë• TEAM INFORMATION</h3>
        <p className="text-zinc-400">Team management is only available to owners.</p>
      </div>
    );
  }
  
  if (loading) {
    return (
      <div className="bg-zinc-900 border-2 border-zinc-700 p-6 mt-6">
        <h3 className="text-xl font-black text-teal-400 mb-4">üë• TEAM MANAGEMENT</h3>
        <p className="text-zinc-400">Loading team configuration...</p>
      </div>
    );
  }
  
  const ownerCount = teamConfig.teamMembers.filter(m => m.role === 'owner').length;
  const pendingCount = teamConfig.pendingRemovals?.filter(p => p.status === 'pending').length || 0;
  
  return (
    <div className="bg-zinc-900 border-2 border-zinc-700 p-6 mt-6">
      <h3 className="text-xl font-black text-teal-400 mb-4">üë• TEAM MANAGEMENT</h3>
      
      {pendingCount > 0 && (
        <div className="bg-yellow-900/30 border-2 border-yellow-600 p-4 mb-6">
          <div className="text-yellow-400 font-bold mb-2">
            ‚è≥ {pendingCount} Pending Removal{pendingCount > 1 ? 's' : ''}
          </div>
          {teamConfig.pendingRemovals
            .filter(p => p.status === 'pending')
            .map(pending => (
              <div key={pending.targetEmail} className="text-zinc-300 text-sm mt-2">
                <div>üìß {pending.targetEmail}</div>
                <div>‚è∞ Time remaining: {getTimeRemaining(pending)}</div>
                <button
                  onClick={async () => {
                    await cancelRemovalWaitingPeriod(teamConfig, pending.targetEmail);
                    await loadTeamConfig();
                  }}
                  className="bg-yellow-600 hover:bg-yellow-500 text-white px-3 py-1 text-sm mt-2"
                >
                  Cancel Removal
                </button>
              </div>
            ))}
        </div>
      )}
      
      <div className="mb-6">
        <h4 className="text-lg font-bold text-zinc-300 mb-3">
          Current Team ({teamConfig.teamMembers.length} members, {ownerCount} owner{ownerCount > 1 ? 's' : ''})
        </h4>
        <div className="space-y-2">
          {teamConfig.teamMembers.map(member => (
            <div key={member.email} className="bg-zinc-800 border border-zinc-700 p-3 flex items-center justify-between">
              <div className="flex-1">
                <div className="text-zinc-200">
                  {member.email}
                  {member.isFounder && <span className="ml-2 text-xs bg-teal-600 px-2 py-1">FOUNDER</span>}
                  {member.email === currentUser && <span className="ml-2 text-xs bg-zinc-600 px-2 py-1">YOU</span>}
                </div>
                <div className="text-xs text-zinc-500 mt-1">
                  Added: {new Date(member.addedDate).toLocaleDateString()}
                </div>
              </div>
              
              <div className="flex items-center gap-3">
                <select
                  value={member.role}
                  onChange={(e) => changeRole(member.email, e.target.value)}
                  disabled={member.email === currentUser}
                  className="bg-zinc-700 text-zinc-200 px-3 py-1 text-sm"
                >
                  <option value="owner">Owner</option>
                  <option value="manager">Manager</option>
                  <option value="technician">Technician</option>
                  <option value="attendant">Attendant</option>
                  <option value="viewer">Viewer</option>
                </select>
                
                {member.email !== currentUser && (
                  <button
                    onClick={() => removeMember(member.email)}
                    className="bg-red-600 hover:bg-red-500 text-white px-3 py-1 text-sm"
                  >
                    ‚ùå Remove
                  </button>
                )}
              </div>
            </div>
          ))}
        </div>
      </div>
      
      <div className="mb-6">
        <h4 className="text-lg font-bold text-zinc-300 mb-3">Add Team Member</h4>
        <div className="flex gap-3">
          <input
            type="email"
            value={newEmail}
            onChange={(e) => setNewEmail(e.target.value)}
            placeholder="email@example.com"
            className="flex-1 bg-zinc-800 border border-zinc-700 text-zinc-200 px-3 py-2"
          />
          <select
            value={newRole}
            onChange={(e) => setNewRole(e.target.value)}
            className="bg-zinc-800 border border-zinc-700 text-zinc-200 px-3 py-2"
          >
            <option value="technician">Technician</option>
            <option value="manager">Manager</option>
            <option value="attendant">Attendant</option>
            <option value="viewer">Viewer</option>
            <option value="owner">Owner</option>
          </select>
          <button
            onClick={addTeamMember}
            className="bg-teal-600 hover:bg-teal-500 text-white px-4 py-2 font-bold"
          >
            ‚ûï ADD
          </button>
        </div>
        <p className="text-xs text-zinc-500 mt-2">
          After adding, share the spreadsheet with them in Google Drive (Editor permission).
        </p>
      </div>
      
      <div>
        <h4 className="text-lg font-bold text-zinc-300 mb-3">Shared Spreadsheet</h4>
        <div className="flex gap-3">
          <input
            type="text"
            value={spreadsheetId}
            onChange={(e) => setSpreadsheetIdLocal(e.target.value)}
            placeholder="Spreadsheet ID (from URL)"
            className="flex-1 bg-zinc-800 border border-zinc-700 text-zinc-200 px-3 py-2 font-mono text-sm"
          />
          <button
            onClick={setSharedSpreadsheet}
            className="bg-teal-600 hover:bg-teal-500 text-white px-4 py-2 font-bold"
          >
            üìã SET AS SHARED
          </button>
        </div>
        <p className="text-xs text-zinc-500 mt-2">
          This is the spreadsheet all team members will access. Get the ID from the spreadsheet URL.
        </p>
        {teamConfig.sharedSpreadsheetId && (
          <div className="text-xs text-teal-400 mt-2">
            ‚úÖ Current shared spreadsheet: {teamConfig.sharedSpreadsheetId}
          </div>
        )}
      </div>
      
      <div className="mt-6 p-4 bg-zinc-800 border border-zinc-700">
        <div className="text-sm text-zinc-400">
          <div className="font-bold text-zinc-300 mb-2">üîí Security Features Active:</div>
          <div>‚úì Minimum {REMOVAL_CONFIG.minimumOwners} owner{REMOVAL_CONFIG.minimumOwners > 1 ? 's' : ''} required</div>
          {REMOVAL_CONFIG.requireEmailVerification && <div>‚úì Email verification for founding owner removal</div>}
          {REMOVAL_CONFIG.waitingPeriodHours > 0 && <div>‚úì {REMOVAL_CONFIG.waitingPeriodHours}-hour waiting period for founding owner removal</div>}
          <div>‚úì Full audit log maintained</div>
        </div>
      </div>
    </div>
  );
};

// Dashboard Component (from Sprint 1 - enhanced)
const Dashboard = ({ alerts, machines, equipmentLogs, buildingLogs, parts, year, maintenanceRequests = [], permissions, onSubmitRequest, onViewRequest }) => {
  // DEBUG: Log what props Dashboard is receiving
  console.log('üìä Dashboard: Rendering with', machines?.length || 0, 'machines');
  console.log('üìä Dashboard: equipmentLogs:', equipmentLogs?.length || 0);
  console.log('üìä Dashboard: buildingLogs:', buildingLogs?.length || 0);
  console.log('üìä Dashboard: parts:', parts?.length || 0);
  
  // ATTENDANT VIEW - Dashboard only access
if (permissions.dashboardOnly) {
  const openRequests = maintenanceRequests.filter(r => r.status === 'Pending');
  const outOfOrderMachines = machines.filter(m => m.status === 'Out of Order' && !m.archived);
  
  return (
    <div className="p-6">
      <h2 className="text-3xl font-black text-teal-400 mb-6">üìä DASHBOARD - ATTENDANT VIEW</h2>
      
      <div className="bg-orange-900/30 border-2 border-orange-600 p-6 mb-6">
        <div className="flex items-center justify-between">
          <div>
            <div className="text-xl font-black text-orange-300 mb-2">üîß NEED MAINTENANCE?</div>
            <div className="text-zinc-300">Submit a request or mark a machine out of order</div>
          </div>
          <button
            onClick={onSubmitRequest}
            className="bg-orange-600 hover:bg-orange-500 text-white px-6 py-3 font-black border-2 border-orange-700"
          >
            + SUBMIT REQUEST
          </button>
        </div>
      </div>
      
      <div className="grid grid-cols-2 gap-6 mb-6">
        <div className="bg-zinc-800 border-2 border-zinc-700 p-6">
          <div className="text-zinc-400 text-sm font-bold mb-2">OPEN REQUESTS</div>
          <div className="text-3xl font-black text-teal-400">{openRequests.length}</div>
          <div className="text-xs text-zinc-500 mt-2">Pending maintenance</div>
        </div>
        
        <div className="bg-zinc-800 border-2 border-zinc-700 p-6">
          <div className="text-zinc-400 text-sm font-bold mb-2">OUT OF ORDER</div>
          <div className="text-3xl font-black text-red-400">{outOfOrderMachines.length}</div>
          <div className="text-xs text-zinc-500 mt-2">Machines down</div>
        </div>
      </div>
      
      {outOfOrderMachines.length > 0 && (
        <div className="bg-red-900/20 border-2 border-red-600 p-6 mb-6">
          <h3 className="text-xl font-black text-red-400 mb-4">üö´ OUT OF ORDER MACHINES</h3>
          <div className="space-y-2">
            {outOfOrderMachines.map(machine => (
              <div key={machine.id} className="bg-zinc-800 border border-red-600 p-3">
                <div className="font-bold text-zinc-200">{machine.name}</div>
                <div className="text-sm text-zinc-400">{machine.model}</div>
                {machine.outOfOrderReason && (
                  <div className="text-sm text-red-400 mt-1">Reason: {machine.outOfOrderReason}</div>
                )}
              </div>
            ))}
          </div>
        </div>
      )}
      
      <div className="bg-zinc-900 border-2 border-zinc-700 p-6">
        <h3 className="text-xl font-black text-teal-400 mb-4">
          üìã OPEN MAINTENANCE REQUESTS ({openRequests.length})
        </h3>
        
        {openRequests.length === 0 ? (
          <p className="text-zinc-500">No open requests</p>
        ) : (
          <div className="space-y-3">
            {openRequests
              .sort((a, b) => {
                const urgencyOrder = { 'High': 0, 'Medium': 1, 'Low': 2 };
                return urgencyOrder[a.urgency] - urgencyOrder[b.urgency];
              })
              .map(request => {
                const machine = machines.find(m => m.id === request.machineId);
                const urgencyColor = {
                  'High': 'bg-red-900/30 border-red-600',
                  'Medium': 'bg-yellow-900/30 border-yellow-600',
                  'Low': 'bg-zinc-800 border-zinc-600'
                }[request.urgency];
                
                return (
                  <div key={request.id} className={`border-2 p-4 ${urgencyColor}`}>
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="font-bold text-zinc-200">
                          {machine ? machine.name : 'Unknown Machine'}
                          {request.machineType && ` - ${request.machineType}`}
                          {request.dryerLocation && ` (${request.dryerLocation})`}
                        </div>
                        <div className="text-sm text-zinc-400 mt-1">
                          <span className="font-bold">{request.problemType}</span>
                          {request.problemType !== request.issue && ` - ${request.issue}`}
                        </div>
                        <div className="text-xs text-zinc-500 mt-2">
                          Submitted: {new Date(request.submittedDate).toLocaleDateString()}
                          {' by ' + request.submittedBy}
                        </div>
                      </div>
                      <div className={`px-3 py-1 text-sm font-bold ${
                        request.urgency === 'High' ? 'bg-red-600 text-white' :
                        request.urgency === 'Medium' ? 'bg-yellow-600 text-black' :
                        'bg-zinc-600 text-white'
                      }`}>
                        {request.urgency.toUpperCase()}
                      </div>
                    </div>
                  </div>
                );
              })}
          </div>
        )}
      </div>
    </div>
  );
}

// Regular dashboard for other roles continues below...
  
  const today = new Date();
  const activeMachines = machines.filter(m => !m.archived);
  
  console.log('üìä Dashboard: activeMachines after filter:', activeMachines.length);
  
  const thisMonth = equipmentLogs.filter(l => {
    const d = new Date(l.date);
    return d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear();
  }).reduce((s, l) => s + parseFloat(l.cost || 0), 0);
  
  const lastMonth = equipmentLogs.filter(l => {
    const d = new Date(l.date);
    const lastM = new Date(today);
    lastM.setMonth(lastM.getMonth() - 1);
    return d.getMonth() === lastM.getMonth() && d.getFullYear() === lastM.getFullYear();
  }).reduce((s, l) => s + parseFloat(l.cost || 0), 0);

  const avgAge = activeMachines.filter(m => m.purchaseDate).reduce((acc, m) => {
    const age = (today - new Date(m.purchaseDate)) / (1000 * 60 * 60 * 24 * 365);
    return acc + age;
  }, 0) / activeMachines.filter(m => m.purchaseDate).length || 0;

  // Sprint 5: Request and out-of-order calculations
  const pendingRequests = maintenanceRequests.filter(r => r.status === 'Pending');
  const highPriorityRequests = pendingRequests.filter(r => r.urgency === 'High');
  const outOfOrderMachines = machines.filter(m => !m.archived && m.status === 'Out of Order');

  return (
    <div className="space-y-6">
      {/* Sprint 5: Technician Quick Actions */}
      {permissions.canSubmitRequests && !permissions.canEdit && (
        <div className="bg-gradient-to-r from-orange-900 to-orange-800 border-4 border-orange-600 p-6">
          <div className="flex items-center justify-between">
            <div>
              <h2 className="text-2xl font-black text-white mb-2">üîß NEED MAINTENANCE?</h2>
              <p className="text-orange-200">Submit a request or mark a machine out of order</p>
            </div>
            <button
              onClick={onSubmitRequest}
              className="bg-white hover:bg-orange-100 text-orange-900 px-8 py-4 font-black border-4 border-orange-700 text-lg flex items-center gap-2"
            >
              <Icon name="plus" size={24} />
              SUBMIT REQUEST
            </button>
          </div>
        </div>
      )}

      {/* Sprint 5: Owner/Manager - Pending Requests Widget */}
      {permissions.canEdit && pendingRequests.length > 0 && (
        <div className="bg-zinc-800 border-2 border-orange-600 p-6">
          <h2 className="text-2xl font-black text-orange-400 mb-4 flex items-center gap-2">
            <Icon name="alert" size={24} />
            PENDING MAINTENANCE REQUESTS ({pendingRequests.length})
          </h2>
          <div className="space-y-2">
            {pendingRequests.slice(0, 5).map((request) => {
              const machine = machines.find(m => m.id === request.machineId);
              const urgencyColor = request.urgency === 'High' ? 'red' : request.urgency === 'Medium' ? 'yellow' : 'green';
              return (
                <div 
                  key={request.id} 
                  onClick={() => onViewRequest && onViewRequest(request)}
                  className={`p-3 border-2 bg-zinc-900 border-${urgencyColor}-600 hover:bg-zinc-700 cursor-pointer flex justify-between items-start`}
                >
                  <div className="flex-1">
                    <p className="text-white font-bold">
                      {machine?.name || 'Unknown Machine'}
                      <span className={`ml-2 text-xs px-2 py-1 bg-${urgencyColor}-900 border border-${urgencyColor}-600 text-${urgencyColor}-400`}>
                        {request.urgency}
                      </span>
                    </p>
                    <p className="text-sm text-zinc-400 mt-1">{request.issue.substring(0, 100)}{request.issue.length > 100 ? '...' : ''}</p>
                    <p className="text-xs text-zinc-500 mt-1">
                      Submitted by {request.submittedBy} ‚Ä¢ {formatDateSlash(request.submittedDate.split('T')[0])}
                    </p>
                  </div>
                </div>
              );
            })}
            {pendingRequests.length > 5 && (
              <div className="text-center text-zinc-500 text-sm pt-2">
                +{pendingRequests.length - 5} more pending requests
              </div>
            )}
          </div>
        </div>
      )}

      {/* Sprint 5: Out of Order Machines Widget */}
      {outOfOrderMachines.length > 0 && (
        <div className="bg-zinc-800 border-2 border-red-600 p-6">
          <h2 className="text-2xl font-black text-red-400 mb-4 flex items-center gap-2">
            <Icon name="alert" size={24} />
            MACHINES OUT OF ORDER ({outOfOrderMachines.length})
          </h2>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            {outOfOrderMachines.map((machine) => (
              <div key={machine.id} className="p-3 border-2 bg-red-900/20 border-red-800">
                <p className="text-white font-bold">{machine.name}</p>
                <p className="text-sm text-zinc-400">{machine.model}</p>
                {machine.outOfOrderReason && (
                  <p className="text-sm text-red-400 mt-1">‚ö†Ô∏è {machine.outOfOrderReason}</p>
                )}
              </div>
            ))}
          </div>
        </div>
      )}

      {alerts.length > 0 && (
        <div className="bg-zinc-800 border-2 border-red-600 p-6">
          <h2 className="text-2xl font-black text-red-400 mb-4 flex items-center gap-2">
            <Icon name="alert" size={24} />
            ALERTS ({alerts.length})
          </h2>
          <div className="space-y-2">
            {alerts.slice(0, 5).map((alert, i) => (
              <div key={i} className={`p-3 border-2 flex justify-between items-start ${alert.type === 'error' ? 'bg-red-900 border-red-600' : 'bg-yellow-900 border-yellow-600'}`}>
                <p className="text-white font-bold flex-1">{alert.message}</p>
                {alert.partId && (
                  <button
                    onClick={() => window.snoozePart && window.snoozePart(alert.partId)}
                    className="ml-3 px-3 py-1 text-xs bg-zinc-800 hover:bg-zinc-700 text-white border-2 border-zinc-600 font-bold whitespace-nowrap"
                    title="Ignore this alert"
                  >
                    IGNORE
                  </button>
                )}
              </div>
            ))}
          </div>
        </div>
      )}

      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        {/* Sprint 5: Hide cost card from technicians */}
        {permissions.canSeeCosts && (
          <div className="bg-zinc-800 border-2 border-zinc-700 p-6">
            <div className="text-zinc-400 text-sm font-bold mb-2">THIS MONTH</div>
            <div className="text-3xl font-black text-teal-400">${thisMonth.toFixed(0)}</div>
            <div className="text-xs text-zinc-500 mt-2">
              {lastMonth > 0 && (
                <span className={thisMonth > lastMonth ? 'text-red-400' : 'text-green-400'}>
                  {thisMonth > lastMonth ? '‚Üë' : '‚Üì'} {Math.abs(((thisMonth - lastMonth) / lastMonth) * 100).toFixed(0)}% vs last
                </span>
              )}
            </div>
          </div>
        )}

        <div className="bg-zinc-800 border-2 border-zinc-700 p-6">
          <div className="text-zinc-400 text-sm font-bold mb-2">ACTIVE EQUIPMENT</div>
          <div className="text-3xl font-black text-teal-400">{activeMachines.length}</div>
          <div className="text-xs text-zinc-500 mt-2">Avg age: {avgAge.toFixed(1)} years</div>
        </div>

        <div className="bg-zinc-800 border-2 border-zinc-700 p-6">
          <div className="text-zinc-400 text-sm font-bold mb-2">LOW STOCK ITEMS</div>
          <div className="text-3xl font-black text-teal-400">
            {parts.filter(p => parseInt(p.stock) <= parseInt(p.minStock)).length}
          </div>
          <div className="text-xs text-zinc-500 mt-2">Check inventory</div>
        </div>

        {/* Sprint 5: Show archived count to all users */}
        <div className="bg-zinc-800 border-2 border-zinc-700 p-6">
          <div className="text-zinc-400 text-sm font-bold mb-2">ARCHIVED</div>
          <div className="text-3xl font-black text-zinc-400">{machines.filter(m => m.archived).length}</div>
          <div className="text-xs text-zinc-500 mt-2">Hidden machines</div>
        </div>
      </div>

      <div className="bg-zinc-800 border-2 border-zinc-700 p-6">
        <h2 className="text-xl font-black text-teal-400 mb-4">RECENT ACTIVITY</h2>
        <div className="space-y-2">
          {[...equipmentLogs, ...buildingLogs]
            .sort((a, b) => new Date(b.date) - new Date(a.date))
            .slice(0, 8)
            .map(log => {
              const machine = machines.find(m => m.id === log.machineId);
              return (
                <div key={log.id} className="flex justify-between items-center p-3 bg-zinc-900 border border-zinc-700">
                  <div>
                    <p className="text-white font-bold">{log.issue}</p>
                    <p className="text-zinc-400 text-sm">{machine?.name || log.category || 'Building'} ‚Ä¢ {log.tech}</p>
                  </div>
                  <div className="text-right">
                    <div className="text-teal-400 font-bold">${parseFloat(log.cost || 0).toFixed(2)}</div>
                    <div className="text-zinc-500 text-xs">{formatDateSlash(log.date)}</div>
                  </div>
                </div>
              );
            })}
        </div>
      </div>
    </div>
  );
};

// Maintenance Request Modal - Sprint 5 Step 3
const MaintenanceRequestModal = ({ machines, currentUser, onClose, onSubmit }) => {
  const [machineType, setMachineType] = useState('');
  const [dryerLocation, setDryerLocation] = useState('');
  const [machineId, setMachineId] = useState('');
  const [problemType, setProblemType] = useState('');
  const [issue, setIssue] = useState('');
  const [urgency, setUrgency] = useState('Medium');
  const [requestSettings, setRequestSettings] = useState(null);
  
  useEffect(() => {
    loadRequestSettings();
  }, []);
  
  const loadRequestSettings = async () => {
    const config = await loadSharedConfig();
    if (config?.requestSettings) {
      setRequestSettings(config.requestSettings);
    } else {
      setRequestSettings(DEFAULT_REQUEST_SETTINGS);
    }
  };
  
  const filteredMachines = machineType 
    ? machines.filter(m => {
        if (machineType === 'Other') {
          return !requestSettings?.machineTypes.slice(0, -1).includes(m.type);
        }
        return m.type === machineType;
      })
    : machines;
  
  const handleSubmit = async () => {
    if (!machineType) {
      alert('Please select a machine type');
      return;
    }
    
    if (!machineId) {
      alert('Please select a machine');
      return;
    }
    
    if (machineType === 'Dryer' && !dryerLocation) {
      alert('Please select dryer location (Top, Bottom, or Both)');
      return;
    }
    
    if (!problemType) {
      alert('Please select a problem type');
      return;
    }
    
    if (!issue.trim()) {
      alert('Please describe the issue');
      return;
    }
    
    const request = {
      machineId,
      machineType,
      dryerLocation: machineType === 'Dryer' ? dryerLocation : null,
      problemType,
      issue: issue.trim(),
      urgency,
      submittedBy: currentUser,
      submittedDate: new Date().toISOString(),
      status: 'Pending'
    };
    
    await onSubmit(request);
    
    const machine = machines.find(m => m.id === machineId);
    const machineName = machine ? machine.name : 'Unknown Machine';
    await sendMaintenanceRequestEmail(request, machineName);
    
    onClose();
  };
  
  if (!requestSettings) {
    return (
      <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
        <div className="bg-zinc-800 border-2 border-teal-500 p-6 max-w-2xl w-full">
          <p className="text-zinc-400">Loading...</p>
        </div>
      </div>
    );
  }
  
  return (
    <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
      <div className="bg-zinc-800 border-2 border-teal-500 p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
        <h2 className="text-2xl font-black text-teal-400 mb-4">üîß SUBMIT MAINTENANCE REQUEST</h2>
        
        <div className="mb-4">
          <label className="block text-zinc-300 font-bold mb-2">Machine Type *</label>
          <select
            value={machineType}
            onChange={(e) => {
              setMachineType(e.target.value);
              setMachineId('');
              setDryerLocation('');
            }}
            className="w-full bg-zinc-700 text-zinc-200 px-3 py-2 border-2 border-zinc-600"
          >
            <option value="">-- Select Type --</option>
            {requestSettings.machineTypes.map(type => (
              <option key={type} value={type}>{type}</option>
            ))}
          </select>
        </div>
        
        {machineType === 'Dryer' && (
          <div className="mb-4">
            <label className="block text-zinc-300 font-bold mb-2">Dryer Location *</label>
            <select
              value={dryerLocation}
              onChange={(e) => setDryerLocation(e.target.value)}
              className="w-full bg-zinc-700 text-zinc-200 px-3 py-2 border-2 border-zinc-600"
            >
              <option value="">-- Select Location --</option>
              {requestSettings.dryerLocations.map(loc => (
                <option key={loc} value={loc}>{loc}</option>
              ))}
            </select>
            <p className="text-xs text-zinc-500 mt-1">Which dryer in the stack?</p>
          </div>
        )}
        
        <div className="mb-4">
          <label className="block text-zinc-300 font-bold mb-2">
            Machine * {machineType && `(${filteredMachines.length} ${machineType}${filteredMachines.length !== 1 ? 's' : ''})`}
          </label>
          <select
            value={machineId}
            onChange={(e) => setMachineId(e.target.value)}
            className="w-full bg-zinc-700 text-zinc-200 px-3 py-2 border-2 border-zinc-600"
            disabled={!machineType}
          >
            <option value="">-- Select Machine --</option>
            {filteredMachines.filter(m => !m.archived).map(m => (
              <option key={m.id} value={m.id}>
                {m.name} - {m.model}
                {m.status === 'Out of Order' ? ' (OUT OF ORDER)' : ''}
              </option>
            ))}
          </select>
          {!machineType && (
            <p className="text-xs text-zinc-500 mt-1">Select a machine type first</p>
          )}
        </div>
        
        <div className="mb-4">
          <label className="block text-zinc-300 font-bold mb-2">Problem Type *</label>
          <select
            value={problemType}
            onChange={(e) => setProblemType(e.target.value)}
            className="w-full bg-zinc-700 text-zinc-200 px-3 py-2 border-2 border-zinc-600"
          >
            <option value="">-- Select Problem --</option>
            {requestSettings.problemTypes.map(type => (
              <option key={type} value={type}>{type}</option>
            ))}
          </select>
        </div>
        
        <div className="mb-4">
          <label className="block text-zinc-300 font-bold mb-2">
            Issue Details * 
            {problemType === 'Other' && ' (Please be specific)'}
          </label>
          <textarea
            value={issue}
            onChange={(e) => setIssue(e.target.value)}
            rows={4}
            placeholder="Describe the problem in detail..."
            className="w-full bg-zinc-700 text-zinc-200 px-3 py-2 border-2 border-zinc-600"
          />
        </div>
        
        <div className="mb-6">
          <label className="block text-zinc-300 font-bold mb-2">Urgency</label>
          <select
            value={urgency}
            onChange={(e) => setUrgency(e.target.value)}
            className="w-full bg-zinc-700 text-zinc-200 px-3 py-2 border-2 border-zinc-600"
          >
            <option value="Low">Low - Can wait</option>
            <option value="Medium">Medium - Should fix soon</option>
            <option value="High">High - Fix ASAP</option>
          </select>
        </div>
        
        <div className="flex gap-3">
          <button
            onClick={handleSubmit}
            className="flex-1 bg-teal-600 hover:bg-teal-500 text-white px-6 py-3 font-black border-2 border-teal-700"
          >
            ‚úì SUBMIT REQUEST
          </button>
          <button
            onClick={onClose}
            className="px-6 py-3 bg-zinc-700 hover:bg-zinc-600 text-zinc-300 border-2 border-zinc-600"
          >
            CANCEL
          </button>
        </div>
      </div>
    </div>
  );
};

// Out of Order Modal - Sprint 5 Step 4
const OutOfOrderModal = ({ machine, onClose, onSave }) => {
  const [form, setForm] = useState({
    reason: 'Broken',
    notes: ''
  });
  const [submitting, setSubmitting] = useState(false);
  
  const handleSubmit = async (e) => {
    e.preventDefault();
    setSubmitting(true);
    const success = await onSave(machine.id, form.reason, form.notes);
    if (success) {
      onClose();
    }
    setSubmitting(false);
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
      <div className="bg-zinc-800 border-4 border-red-600 max-w-xl w-full p-6">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-red-400">‚ö†Ô∏è MARK OUT OF ORDER</h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        
        <div className="mb-6 bg-zinc-900 border-2 border-zinc-700 p-4">
          <p className="text-white font-bold">{machine.name}</p>
          <p className="text-sm text-zinc-400">{machine.model} - Serial: {machine.serial}</p>
          <p className="text-sm text-zinc-500 mt-2">
            Current Status: <span className="text-teal-400">{machine.status}</span>
          </p>
        </div>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-xs font-black text-red-400 mb-2">REASON</label>
            <select 
              value={form.reason} 
              onChange={e => setForm({...form, reason: e.target.value})} 
              className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-red-500"
            >
              <option value="Broken">üîß Broken / Needs Repair</option>
              <option value="No Supplies">üì¶ No Supplies (detergent, coins, etc.)</option>
              <option value="Under Maintenance">üõ†Ô∏è Under Maintenance</option>
              <option value="Safety Issue">‚ö†Ô∏è Safety Issue</option>
              <option value="Power Outage">‚ö° Power/Electrical Issue</option>
              <option value="Water Issue">üíß Water/Plumbing Issue</option>
              <option value="Other">‚ùì Other</option>
            </select>
          </div>
          
          <div>
            <label className="block text-xs font-black text-red-400 mb-2">NOTES (Optional)</label>
            <textarea 
              value={form.notes} 
              onChange={e => setForm({...form, notes: e.target.value})} 
              placeholder="Additional details about why this machine is out of order..."
              className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-red-500 h-24"
            />
          </div>
          
          <div className="bg-red-900/20 border-2 border-red-800 p-4">
            <p className="text-sm text-red-300 leading-relaxed">
              <strong>‚ö†Ô∏è This will:</strong><br />
              ‚Ä¢ Mark the machine as "Out of Order"<br />
              ‚Ä¢ Prevent it from being selected for new repairs<br />
              ‚Ä¢ Alert management to take action
            </p>
          </div>
          
          <div className="flex gap-4">
            <button 
              type="submit"
              disabled={submitting}
              className="flex-1 bg-red-600 hover:bg-red-500 disabled:bg-zinc-700 disabled:cursor-not-allowed text-white px-6 py-3 font-black border-2 border-red-700"
            >
              {submitting ? 'MARKING...' : '‚ö†Ô∏è MARK OUT OF ORDER'}
            </button>
            <button 
              type="button"
              onClick={onClose}
              className="px-6 py-3 bg-zinc-700 hover:bg-zinc-600 text-white font-black border-2 border-zinc-600"
            >
              CANCEL
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// Machine Notes Modal - Sprint 4.1
const MachineNotesModal = ({ machine, notes, onClose, onAddNote, onDeleteNote }) => {
  const [noteText, setNoteText] = useState('');
  const [submitting, setSubmitting] = useState(false);
  
  const machineNotes = notes.filter(n => n.machineId === machine.id).sort((a, b) => new Date(b.date) - new Date(a.date));
  
  const handleSubmit = async (e) => {
    e.preventDefault();
    if (!noteText.trim()) return;
    
    setSubmitting(true);
    const success = await onAddNote(machine.id, noteText);
    if (success) {
      setNoteText('');
    }
    setSubmitting(false);
  };
  
  const formatDateTime = (isoString) => {
    const date = new Date(isoString);
    return date.toLocaleString('en-US', { 
      month: 'short', 
      day: 'numeric', 
      year: 'numeric', 
      hour: 'numeric', 
      minute: '2-digit',
      hour12: true 
    });
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
      <div className="bg-zinc-800 border-4 border-yellow-600 max-w-2xl w-full p-6 max-h-[80vh] flex flex-col">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-yellow-400">üìù MACHINE NOTES - {machine.name}</h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        
        {/* Add Note Form */}
        <form onSubmit={handleSubmit} className="mb-6">
          <label className="block text-xs font-black text-yellow-400 mb-2">ADD NEW NOTE</label>
          <textarea 
            value={noteText}
            onChange={e => setNoteText(e.target.value)}
            placeholder="e.g., Makes grinding noise on spin cycle. Monitor closely."
            className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-yellow-500 h-24 mb-3"
            disabled={submitting}
          />
          <button 
            type="submit" 
            disabled={submitting || !noteText.trim()}
            className="bg-yellow-600 hover:bg-yellow-500 disabled:bg-zinc-700 disabled:cursor-not-allowed text-white px-6 py-2 font-black border-2 border-yellow-700 flex items-center gap-2"
          >
            <Icon name="plus" size={16} />
            {submitting ? 'SAVING...' : 'ADD NOTE'}
          </button>
        </form>
        
        {/* Notes List */}
        <div className="flex-1 overflow-y-auto space-y-3">
          <label className="block text-xs font-black text-yellow-400 mb-2">HISTORY ({machineNotes.length} notes)</label>
          
          {machineNotes.length === 0 && (
            <div className="text-center text-zinc-500 py-8 italic">
              No notes yet. Add one above to start tracking observations.
            </div>
          )}
          
          {machineNotes.map(note => (
            <div key={note.id} className="bg-zinc-900 border-2 border-zinc-700 p-4">
              <div className="flex justify-between items-start mb-2">
                <div className="text-xs text-yellow-400 font-bold">{formatDateTime(note.date)}</div>
                <button 
                  onClick={() => onDeleteNote(note.id)}
                  className="text-red-400 hover:text-red-300 text-xs"
                  title="Delete note"
                >
                  <Icon name="trash-2" size={14} />
                </button>
              </div>
              <div className="text-white font-bold leading-relaxed">{note.note}</div>
              <div className="text-xs text-zinc-500 mt-2">‚Äî {note.user}</div>
            </div>
          ))}
        </div>
        
        <div className="mt-6">
          <button onClick={onClose} className="w-full bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">
            CLOSE
          </button>
        </div>
      </div>
    </div>
  );
};

// Equipment Tab with ARCHIVE feature and NESTED GROUPING
const EquipmentTab = ({ machines, logs, year, showArchived, setShowArchived, onAdd, onEdit, onDelete, onArchive, onUnarchive, machineNotes, onAddNote, onDeleteNote, permissions, onMarkOutOfOrder }) => {
  // DEBUG: Log what props we're receiving
  console.log('üîß EquipmentTab: Rendering with', machines?.length || 0, 'machines');
  console.log('üîß EquipmentTab: showArchived:', showArchived);
  console.log('üîß EquipmentTab: year:', year);
  
  const [search, setSearch] = useState('');
  const [expandedTypes, setExpandedTypes] = useState({});
  const [expandedModels, setExpandedModels] = useState({});
  const [notesModal, setNotesModal] = useState(null); // {machine}
  
  const filtered = machines.filter(m => 
    m.name?.toLowerCase().includes(search.toLowerCase()) ||
    m.model?.toLowerCase().includes(search.toLowerCase())
  );
  
  console.log('üîß EquipmentTab: After search filter:', filtered.length, 'machines');

  // Group equipment by Type ‚Üí Model
  const groupedEquipment = filtered.reduce((groups, machine) => {
    const type = machine.type || 'Other';
    if (!groups[type]) groups[type] = {};
    const model = machine.model || 'Unknown Model';
    if (!groups[type][model]) groups[type][model] = [];
    groups[type][model].push(machine);
    return groups;
  }, {});

  const toggleType = (type) => {
    setExpandedTypes({...expandedTypes, [type]: !expandedTypes[type]});
  };

  const toggleModel = (typeModel) => {
    setExpandedModels({...expandedModels, [typeModel]: !expandedModels[typeModel]});
  };

  const getCost = (id) => logs.filter(l => l.machineId === id && !l.warranty && new Date(l.date).getFullYear() === year).reduce((s, l) => s + parseFloat(l.cost || 0), 0);
  const getCount = (id) => logs.filter(l => l.machineId === id && new Date(l.date).getFullYear() === year).length;

  return (
    <div>
      <div className="flex justify-between mb-4 flex-wrap gap-4">
        <div className="flex items-center gap-4">
          <h2 className="text-2xl font-black text-teal-400 flex items-center gap-2">
            <Icon name="wrench" size={24} /> EQUIPMENT ROSTER
          </h2>
          <label className="flex items-center gap-2 text-zinc-300 cursor-pointer">
            <input type="checkbox" checked={showArchived} onChange={e => setShowArchived(e.target.checked)} className="w-4 h-4" />
            <span className="text-sm font-bold">Show Archived</span>
          </label>
        </div>
        <div className="flex gap-3">
          <div className="relative">
            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500">
              <Icon name="search" size={16} />
            </div>
            <input type="text" placeholder="SEARCH..." value={search} onChange={e => setSearch(e.target.value)} className="bg-zinc-800 border-2 border-zinc-700 text-white pl-10 pr-4 py-2 font-bold focus:border-teal-500 outline-none" />
          </div>
          <button onClick={onAdd} className="bg-teal-600 hover:bg-teal-500 text-white px-4 sm:px-6 py-2 font-black border-2 border-teal-700 flex items-center justify-center gap-2 text-sm sm:text-base">
            <Icon name="plus" /> ADD MACHINE
          </button>
        </div>
      </div>
      
      <div className="space-y-4">
        {Object.entries(groupedEquipment).map(([type, models]) => {
          const typeTotal = Object.values(models).flat().length;
          const isTypeExpanded = expandedTypes[type];
          
          return (
            <div key={type} className="bg-zinc-900 border-2 border-zinc-700">
              <button 
                onClick={() => toggleType(type)}
                className="w-full flex items-center justify-between p-4 hover:bg-zinc-800 transition"
              >
                <div className="flex items-center gap-3">
                  <Icon name={isTypeExpanded ? "chevron-down" : "chevron-right"} size={20} className="text-teal-400" />
                  <h3 className="text-xl font-black text-white">{type}</h3>
                  <span className="text-zinc-500 font-bold">({typeTotal})</span>
                </div>
              </button>
              
              {isTypeExpanded && (
                <div className="px-4 pb-4 space-y-3">
                  {Object.entries(models).map(([model, machinesList]) => {
                    const isModelExpanded = expandedModels[`${type}-${model}`];
                    
                    return (
                      <div key={model} className="ml-6 bg-zinc-800 border border-zinc-700">
                        <button
                          onClick={() => toggleModel(`${type}-${model}`)}
                          className="w-full flex items-center justify-between p-3 hover:bg-zinc-700 transition"
                        >
                          <div className="flex items-center gap-3">
                            <Icon name={isModelExpanded ? "chevron-down" : "chevron-right"} size={16} className="text-zinc-500" />
                            <h4 className="text-lg font-bold text-zinc-300">{model}</h4>
                            <span className="text-zinc-600 text-sm">({machinesList.length})</span>
                          </div>
                        </button>
                        
                        {isModelExpanded && (
                          <div className="p-3 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            {machinesList.map(m => {
                              const roi = calculateROI(m, logs);
                              const age = calculateAge(m.purchaseDate);
                              const isArchived = m.archived;
                              
                              return (
                                <div key={m.id} className={`bg-zinc-900 border-2 p-4 hover:border-teal-500 transition relative ${isArchived ? 'border-zinc-600 opacity-60' : 'border-zinc-700'}`}>
                                  {isArchived && (
                                    <div className="bg-zinc-700 border border-zinc-600 px-2 py-1 text-xs font-black text-zinc-400 mb-2 inline-block">
                                      ARCHIVED
                                    </div>
                                  )}
                                  {/* Sprint 5: Out of Order Badge */}
                                  {m.status !== 'In Service' && !isArchived && (
                                    <div className="absolute top-2 right-2 bg-red-900 border-2 border-red-600 px-2 py-1 text-xs font-black text-red-400">
                                      {m.status.toUpperCase()}
                                    </div>
                                  )}
                                  <div className="flex justify-between mb-3">
                                    <div>
                                      <h3 className="text-lg font-black text-white">{m.name}</h3>
                                      <p className="text-xs text-zinc-400 font-bold">SN: {m.serial}</p>
                                      {/* Sprint 5: Show out of order reason */}
                                      {m.status !== 'In Service' && m.outOfOrderReason && (
                                        <p className="text-xs text-red-400 mt-1">‚ö†Ô∏è {m.outOfOrderReason}</p>
                                      )}
                                    </div>
                                    <div className="flex gap-2">
                                      {/* Sprint 5: Mark Out of Order button (techs + managers) */}
                                      {permissions.canMarkOutOfOrder && !isArchived && m.status === 'In Service' && (
                                        <button onClick={(e) => { e.stopPropagation(); onMarkOutOfOrder(m); }} className="text-red-400 hover:text-red-300" title="Mark Out of Order">
                                          <Icon name="alert" size={16} />
                                        </button>
                                      )}
                                      <button onClick={(e) => { e.stopPropagation(); setNotesModal(m); }} className="text-yellow-400 hover:text-yellow-300" title="View/Add Notes">
                                        <Icon name="file-text" size={16} />
                                      </button>
                                      {/* Sprint 5: Hide edit/archive/delete from viewers and technicians */}
                                      {permissions.canEdit && (
                                        <button onClick={(e) => { e.stopPropagation(); onEdit(m); }} className="text-teal-400 hover:text-teal-300">
                                          <Icon name="edit" size={16} />
                                        </button>
                                      )}
                                      {!isArchived && permissions.canEdit && (
                                        <button onClick={(e) => { e.stopPropagation(); onArchive(m.id); }} className="text-yellow-400 hover:text-yellow-300" title="Archive">
                                          <Icon name="archive" size={16} />
                                        </button>
                                      )}
                                      {isArchived && permissions.canEdit && (
                                        <button onClick={(e) => { e.stopPropagation(); onUnarchive(m.id); }} className="text-green-400 hover:text-green-300" title="Unarchive">
                                          <Icon name="wrench" size={16} />
                                        </button>
                                      )}
                                      {permissions.canDelete && (
                                        <button onClick={(e) => { e.stopPropagation(); onDelete(m.id); }} className="text-red-400 hover:text-red-300">
                                          <Icon name="trash" size={16} />
                                        </button>
                                      )}
                                    </div>
                                  </div>
                                  <div className="space-y-1 text-sm mb-3">
                                    {age && <p className="text-zinc-400"><span className="font-bold">AGE:</span> {age.toFixed(1)} years</p>}
                                    {/* Sprint 5: Hide ROI from technicians */}
                                    {roi && !isArchived && permissions.canSeeCosts && (
                                      <div>
                                        <p className={`font-bold ${roi.recommendation === 'REPLACE' ? 'text-red-400' : 'text-green-400'}`}>
                                          {roi.recommendation} (${roi.annualCost.toFixed(0)}/yr)
                                        </p>
                                        <p className="text-xs text-zinc-500">
                                          Replacement: ${roi.replacementCost.toFixed(0)}
                                        </p>
                                      </div>
                                    )}
                                  </div>
                                  <div className="border-t-2 border-zinc-700 pt-3 flex justify-between">
                                    <div>
                                      <div className="text-xs text-zinc-500 font-bold">REPAIRS</div>
                                      <div className="text-xl font-black text-teal-400">{getCount(m.id)}</div>
                                    </div>
                                    {/* Sprint 5: Hide cost from technicians */}
                                    {permissions.canSeeCosts && (
                                      <div className="text-right">
                                        <div className="text-xs text-zinc-500 font-bold">COST</div>
                                        <div className="text-xl font-black text-teal-400">${getCost(m.id).toFixed(2)}</div>
                                      </div>
                                    )}
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          );
        })}
      </div>
      
      {Object.keys(groupedEquipment).length === 0 && (
        <div className="text-center py-12 bg-zinc-800 border-2 border-zinc-700">
          <p className="text-zinc-500 font-bold">NO MACHINES FOUND</p>
        </div>
      )}
      
      {/* Machine Notes Modal */}
      {notesModal && (
        <MachineNotesModal 
          machine={notesModal} 
          notes={machineNotes}
          onClose={() => setNotesModal(null)}
          onAddNote={onAddNote}
          onDeleteNote={onDeleteNote}
        />
      )}
    </div>
  );
};

// Calendar Tab - Month Grid View
const CalendarTab = ({ equipmentLogs, buildingLogs, scheduledTasks, machines, year, onViewRepair, onViewBuilding, onViewTask }) => {
  const [currentMonth, setCurrentMonth] = useState(new Date().getMonth());
  const [currentYear, setCurrentYear] = useState(new Date().getFullYear());
  const [selectedDate, setSelectedDate] = useState(null);
  
  // Get days in month
  const getDaysInMonth = (month, year) => {
    return new Date(year, month + 1, 0).getDate();
  };
  
  // Get first day of month (0 = Sunday)
  const getFirstDayOfMonth = (month, year) => {
    return new Date(year, month, 1).getDay();
  };
  
  // Get events for a specific date
  const getEventsForDate = (date) => {
    const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
    
    const repairs = equipmentLogs.filter(log => log.date === dateStr).map(log => ({
      type: 'repair',
      data: log,
      machine: machines.find(m => m.id === log.machineId)
    }));
    
    const building = buildingLogs.filter(log => log.date === dateStr).map(log => ({
      type: 'building',
      data: log
    }));
    
    const scheduled = scheduledTasks.filter(task => {
      if (!task.nextDue) return false;
      return task.nextDue === dateStr;
    }).map(task => ({
      type: 'scheduled',
      data: task,
      machine: machines.find(m => m.id === task.machineId)
    }));
    
    return [...repairs, ...building, ...scheduled];
  };
  
  // Navigate months
  const prevMonth = () => {
    if (currentMonth === 0) {
      setCurrentMonth(11);
      setCurrentYear(currentYear - 1);
    } else {
      setCurrentMonth(currentMonth - 1);
    }
  };
  
  const nextMonth = () => {
    if (currentMonth === 11) {
      setCurrentMonth(0);
      setCurrentYear(currentYear + 1);
    } else {
      setCurrentMonth(currentMonth + 1);
    }
  };
  
  const today = new Date();
  const isToday = (date) => {
    return date === today.getDate() && 
           currentMonth === today.getMonth() && 
           currentYear === today.getFullYear();
  };
  
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                      'July', 'August', 'September', 'October', 'November', 'December'];
  
  const daysInMonth = getDaysInMonth(currentMonth, currentYear);
  const firstDay = getFirstDayOfMonth(currentMonth, currentYear);
  
  // Build calendar grid
  const calendarDays = [];
  
  // Empty cells for days before month starts
  for (let i = 0; i < firstDay; i++) {
    calendarDays.push(null);
  }
  
  // Days of month
  for (let day = 1; day <= daysInMonth; day++) {
    calendarDays.push(day);
  }
  
  // Get events selected date
  const selectedEvents = selectedDate ? getEventsForDate(selectedDate) : [];
  
  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h2 className="text-2xl font-black text-teal-400 flex items-center gap-2">
          <Icon name="calendar" size={24} />
          MAINTENANCE CALENDAR
        </h2>
        
        <div className="flex items-center gap-3">
          <button onClick={prevMonth} className="bg-zinc-800 hover:bg-zinc-700 text-white px-4 py-2 font-bold border-2 border-zinc-700">
            ‚Üê PREV
          </button>
          <div className="text-xl font-black text-white px-4">
            {monthNames[currentMonth]} {currentYear}
          </div>
          <button onClick={nextMonth} className="bg-zinc-800 hover:bg-zinc-700 text-white px-4 py-2 font-bold border-2 border-zinc-700">
            NEXT ‚Üí
          </button>
        </div>
      </div>
      
      <div className="bg-zinc-800 border-2 border-zinc-700 p-4">
        {/* Day headers */}
        <div className="grid grid-cols-7 gap-2 mb-2">
          {['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'].map(day => (
            <div key={day} className="text-center text-xs font-black text-teal-400 py-3 bg-zinc-900">
              {day}
            </div>
          ))}
        </div>
        
        {/* Calendar grid */}
        <div className="grid grid-cols-7 gap-2">
          {calendarDays.map((day, index) => {
            if (day === null) {
              return <div key={`empty-${index}`} className="h-16" />;
            }
            
            const events = getEventsForDate(day);
            const hasRepairs = events.some(e => e.type === 'repair');
            const hasBuilding = events.some(e => e.type === 'building');
            const hasScheduled = events.some(e => e.type === 'scheduled');
            
            return (
              <button
                key={day}
                onClick={() => setSelectedDate(day)}
                className={`h-16 border-2 p-2 hover:border-teal-500 transition ${
                  isToday(day) ? 'bg-teal-900 border-teal-500' : 
                  selectedDate === day ? 'bg-zinc-700 border-teal-400' :
                  'bg-zinc-900 border-zinc-700'
                }`}
              >
                <div className="text-sm font-bold text-white mb-1">{day}</div>
                <div className="flex gap-1 justify-center">
                  {hasRepairs && <div className="w-2 h-2 rounded-full bg-red-500" title="Repair" />}
                  {hasBuilding && <div className="w-2 h-2 rounded-full bg-blue-500" title="Building" />}
                  {hasScheduled && <div className="w-2 h-2 rounded-full bg-green-500" title="Scheduled" />}
                </div>
              </button>
            );
          })}
        </div>
      </div>
      
      {/* Legend */}
      <div className="mt-4 flex gap-6 text-sm">
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 rounded-full bg-red-500" />
          <span className="text-zinc-300">Equipment Repair</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 rounded-full bg-blue-500" />
          <span className="text-zinc-300">Building Maintenance</span>
        </div>
        <div className="flex items-center gap-2">
          <div className="w-3 h-3 rounded-full bg-green-500" />
          <span className="text-zinc-300">Scheduled Maintenance</span>
        </div>
      </div>
      
      {/* Event details popup */}
      {selectedDate && selectedEvents.length > 0 && (
        <div className="mt-6 bg-zinc-800 border-2 border-teal-600 p-4">
          <div className="flex justify-between mb-4">
            <h3 className="text-xl font-black text-teal-400">
              {monthNames[currentMonth]} {selectedDate}, {currentYear} - {selectedEvents.length} Event{selectedEvents.length !== 1 ? 's' : ''}
            </h3>
            <button onClick={() => setSelectedDate(null)} className="text-zinc-400 hover:text-white">
              <Icon name="x" size={20} />
            </button>
          </div>
          
          <div className="space-y-3 max-h-96 overflow-y-auto">
            {selectedEvents.map((event, i) => (
              <button
                key={i}
                onClick={() => {
                  if (event.type === 'repair' && onViewRepair) {
                    onViewRepair(event.data);
                  } else if (event.type === 'building' && onViewBuilding) {
                    onViewBuilding(event.data);
                  } else if (event.type === 'scheduled' && onViewTask) {
                    onViewTask(event.data);
                  }
                }}
                className="w-full bg-zinc-900 border-2 border-zinc-700 p-3 hover:border-teal-500 transition text-left"
              >
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-1">
                      {event.type === 'repair' && <div className="w-3 h-3 rounded-full bg-red-500" />}
                      {event.type === 'building' && <div className="w-3 h-3 rounded-full bg-blue-500" />}
                      {event.type === 'scheduled' && <div className="w-3 h-3 rounded-full bg-green-500" />}
                      <span className="text-xs font-bold text-zinc-500 uppercase">
                        {event.type === 'repair' ? 'Equipment Repair' : 
                         event.type === 'building' ? 'Building Maintenance' : 
                         'Scheduled Maintenance'}
                      </span>
                    </div>
                    
                    <p className="text-white font-bold">
                      {event.type === 'scheduled' && event.data.equipmentType
                        ? `All ${event.data.equipmentType}s`
                        : event.machine?.name || event.data.category || 'Building'}
                    </p>
                    <p className="text-zinc-300 text-sm">
                      {event.type === 'scheduled' 
                        ? event.data.description 
                        : event.data.issue}
                    </p>
                    
                    {event.type === 'repair' && (
                      <div className="mt-2 flex gap-4 text-xs text-zinc-400">
                        <span>Tech: {event.data.tech}</span>
                        <span>Cost: ${parseFloat(event.data.cost || 0).toFixed(2)}</span>
                        <span>Hours: {event.data.hours}</span>
                      </div>
                    )}
                    
                    {event.type === 'building' && (
                      <div className="mt-2 flex gap-4 text-xs text-zinc-400">
                        <span>Tech: {event.data.tech}</span>
                        <span>Cost: ${parseFloat(event.data.cost || 0).toFixed(2)}</span>
                      </div>
                    )}
                    
                    {event.type === 'scheduled' && (
                      <div className="mt-2 flex gap-4 text-xs text-zinc-400">
                        <span>Frequency: {event.data.frequency}</span>
                        {event.data.lastCompleted && <span>Last: {formatDateSlash(event.data.lastCompleted)}</span>}
                      </div>
                    )}
                  </div>
                  
                  {(event.type === 'repair' || event.type === 'building' || event.type === 'scheduled') && (
                    <div className="ml-3">
                      <Icon name="chevron-right" size={16} className="text-zinc-500" />
                    </div>
                  )}
                </div>
              </button>
            ))}
          </div>
        </div>
      )}
      
      {selectedDate && selectedEvents.length === 0 && (
        <div className="mt-6 bg-zinc-800 border-2 border-zinc-700 p-4 text-center">
          <p className="text-zinc-500">No events on {monthNames[currentMonth]} {selectedDate}, {currentYear}</p>
          <button onClick={() => setSelectedDate(null)} className="mt-2 text-teal-400 hover:text-teal-300 text-sm">
            Close
          </button>
        </div>
      )}
    </div>
  );
};

// Repairs Tab (Updated for Sprint 3 - clickable with lock icons)
const RepairsTab = ({ logs, machines, parts, partsUsage, onAdd, onView, permissions }) => {
  const getPartsCost = (logId) => {
    if (!partsUsage) return 0;
    return partsUsage
      .filter(u => u.logId === logId)
      .reduce((sum, u) => sum + parseFloat(u.cost || 0), 0);
  };

  return (
    <div>
      <div className="flex flex-col sm:flex-row justify-between mb-4 gap-4">
        <h2 className="text-2xl font-black text-teal-400 flex items-center gap-2">
          <Icon name="calendar" size={24} /> REPAIR LOGS
        </h2>
        {permissions.canEdit && (
          <button onClick={onAdd} disabled={machines.filter(m => !m.archived).length === 0} className="bg-teal-600 hover:bg-teal-500 disabled:bg-zinc-700 text-white px-4 sm:px-6 py-2 font-black border-2 border-teal-700 flex items-center justify-center gap-2 text-sm sm:text-base">
            <Icon name="plus" /> ADD REPAIR
          </button>
        )}
      </div>
      <div className="bg-zinc-800 border-2 border-zinc-700 overflow-x-auto">
        <table className="w-full">
          <thead className="bg-zinc-900 border-b-2 border-teal-600">
            <tr>
              <th className="px-4 py-3 text-left text-teal-400 font-black text-sm">DATE</th>
              <th className="px-4 py-3 text-left text-teal-400 font-black text-sm">MACHINE</th>
              <th className="px-4 py-3 text-left text-teal-400 font-black text-sm">ISSUE</th>
              <th className="px-4 py-3 text-left text-teal-400 font-black text-sm">TECH</th>
              <th className="px-4 py-3 text-right text-teal-400 font-black text-sm">HOURS</th>
              {permissions.canSeeCosts && <th className="px-4 py-3 text-right text-teal-400 font-black text-sm">PARTS $</th>}
              {permissions.canSeeCosts && <th className="px-4 py-3 text-right text-teal-400 font-black text-sm">TOTAL $</th>}
              <th className="px-4 py-3 text-center text-teal-400 font-black text-sm">STATUS</th>
            </tr>
          </thead>
          <tbody>
            {logs.sort((a,b) => new Date(b.date) - new Date(a.date)).map(l => {
              const machine = machines.find(m => m.id === l.machineId);
              const partsCost = getPartsCost(l.id);
              const usedParts = l.partsUsed ? l.partsUsed.split(',').filter(Boolean) : [];
              return (
                <tr key={l.id} onClick={() => onView(l)} className="border-b border-zinc-700 hover:bg-zinc-700 cursor-pointer transition">
                  <td className="px-4 py-3 text-white font-bold">{formatDateSlash(l.date)}</td>
                  <td className="px-4 py-3 text-zinc-300">
                    {machine?.name || 'Unknown'}
                    {machine?.archived && <span className="ml-2 text-xs text-zinc-500">(ARCHIVED)</span>}
                  </td>
                  <td className="px-4 py-3 text-zinc-300">{l.issue}</td>
                  <td className="px-4 py-3 text-zinc-300">{l.tech}</td>
                  <td className="px-4 py-3 text-right text-zinc-300">{l.hours}</td>
                  {permissions.canSeeCosts && <td className="px-4 py-3 text-right text-yellow-400 font-bold">${l.warranty ? '0.00' : partsCost.toFixed(2)}</td>}
                  {permissions.canSeeCosts && <td className="px-4 py-3 text-right text-teal-400 font-bold">${l.warranty ? '0.00' : parseFloat(l.cost || 0).toFixed(2)}</td>}
                  <td className="px-4 py-3 text-center">{l.locked ? (
                      <Icon name="lock" size={16} className="inline text-red-400" title="Locked" />
                    ) : (
                      <Icon name="unlock" size={16} className="inline text-green-400" title="Unlocked" />
                    )}
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
        {logs.length === 0 && (
          <div className="text-center py-8 text-zinc-500 font-bold">NO REPAIR RECORDS</div>
        )}
      </div>
    </div>
  );
};

// Building Tab (Updated for Sprint 3 - clickable with lock icons)
const BuildingTab = ({ logs, onAdd, onView, permissions }) => (
  <div>
    <div className="flex flex-col sm:flex-row justify-between mb-4 gap-4">
      <h2 className="text-2xl font-black text-teal-400 flex items-center gap-2">
        <Icon name="home" size={24} /> BUILDING MAINTENANCE
      </h2>
      {permissions.canEdit && (
        <button onClick={onAdd} className="bg-teal-600 hover:bg-teal-500 text-white px-4 sm:px-6 py-2 font-black border-2 border-teal-700 flex items-center justify-center gap-2 text-sm sm:text-base">
          <Icon name="plus" /> ADD ENTRY
        </button>
      )}
    </div>
    <div className="bg-zinc-800 border-2 border-zinc-700 overflow-x-auto">
      <table className="w-full">
        <thead className="bg-zinc-900 border-b-2 border-teal-600">
          <tr>
            <th className="px-4 py-3 text-left text-teal-400 font-black text-sm">DATE</th>
            <th className="px-4 py-3 text-left text-teal-400 font-black text-sm">CATEGORY</th>
            <th className="px-4 py-3 text-left text-teal-400 font-black text-sm">ISSUE</th>
            <th className="px-4 py-3 text-left text-teal-400 font-black text-sm">TECH</th>
            <th className="px-4 py-3 text-right text-teal-400 font-black text-sm">HOURS</th>
            {permissions.canSeeCosts && <th className="px-4 py-3 text-right text-teal-400 font-black text-sm">COST</th>}
            <th className="px-4 py-3 text-center text-teal-400 font-black text-sm">STATUS</th>
          </tr>
        </thead>
        <tbody>
          {logs.sort((a,b) => new Date(b.date) - new Date(a.date)).map(l => (
            <tr key={l.id} onClick={() => onView(l)} className="border-b border-zinc-700 hover:bg-zinc-700 cursor-pointer transition">
              <td className="px-4 py-3 text-white font-bold">{formatDateSlash(l.date)}</td>
              <td className="px-4 py-3 text-zinc-300">{l.category}</td>
              <td className="px-4 py-3 text-zinc-300">{l.issue}</td>
              <td className="px-4 py-3 text-zinc-300">{l.tech}</td>
              <td className="px-4 py-3 text-right text-zinc-300">{l.hours}</td>
              {permissions.canSeeCosts && <td className="px-4 py-3 text-right text-teal-400 font-bold">${parseFloat(l.cost || 0).toFixed(2)}</td>}
              <td className="px-4 py-3 text-center">{l.locked ? (
                  <Icon name="lock" size={16} className="inline text-red-400" title="Locked" />
                ) : (
                  <Icon name="unlock" size={16} className="inline text-green-400" title="Unlocked" />
                )}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
      {logs.length === 0 && (
        <div className="text-center py-8 text-zinc-500 font-bold">NO BUILDING RECORDS</div>
      )}
    </div>
  </div>
);


// Vendors Tab - NEW IN SPRINT 2
const VendorsTab = ({ vendors, equipmentLogs, buildingLogs, onAdd, onEdit, onDelete }) => {
  const [search, setSearch] = useState('');
  
  const filtered = vendors.filter(v => 
    v.name?.toLowerCase().includes(search.toLowerCase()) ||
    v.specialties?.toLowerCase().includes(search.toLowerCase())
  );

  const getJobs = (vendorName) => {
    return [...equipmentLogs, ...buildingLogs].filter(l => l.tech?.toLowerCase().includes(vendorName.toLowerCase())).length;
  };

  const getTotalCost = (vendorName) => {
    return [...equipmentLogs, ...buildingLogs]
      .filter(l => l.tech?.toLowerCase().includes(vendorName.toLowerCase()))
      .reduce((sum, l) => sum + parseFloat(l.cost || 0), 0);
  };

  return (
    <div>
      <div className="flex justify-between mb-4 flex-wrap gap-4">
        <h2 className="text-2xl font-black text-teal-400 flex items-center gap-2">
          <Icon name="users" size={24} /> VENDORS DATABASE
        </h2>
        <div className="flex gap-3">
          <div className="relative">
            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500">
              <Icon name="search" size={16} />
            </div>
            <input type="text" placeholder="SEARCH..." value={search} onChange={e => setSearch(e.target.value)} className="bg-zinc-800 border-2 border-zinc-700 text-white pl-10 pr-4 py-2 font-bold focus:border-teal-500 outline-none" />
          </div>
          <button onClick={onAdd} className="bg-teal-600 hover:bg-teal-500 text-white px-4 sm:px-6 py-2 font-black border-2 border-teal-700 flex items-center justify-center gap-2 text-sm sm:text-base">
            <Icon name="plus" /> ADD VENDOR
          </button>
        </div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {filtered.map(v => (
          <div key={v.id} className="bg-zinc-800 border-2 border-zinc-700 p-4 hover:border-teal-500 transition">
            <div className="flex justify-between mb-3">
              <div>
                <h3 className="text-lg font-black text-white">{v.name}</h3>
                <p className="text-xs text-zinc-400 font-bold">{v.contact}</p>
              </div>
              <div className="flex gap-2">
                <button onClick={() => onEdit(v)} className="text-teal-400 hover:text-teal-300">
                  <Icon name="edit" size={16} />
                </button>
                <button onClick={() => onDelete(v.id)} className="text-red-400 hover:text-red-300">
                  <Icon name="trash" size={16} />
                </button>
              </div>
            </div>
            <div className="space-y-1 text-sm mb-3">
              {v.phone && <p className="text-zinc-400"><span className="font-bold">PHONE:</span> {v.phone}</p>}
              {v.email && <p className="text-zinc-400"><span className="font-bold">EMAIL:</span> {v.email}</p>}
              {v.specialties && <p className="text-zinc-400"><span className="font-bold">SPECIALTIES:</span> {v.specialties}</p>}
              {v.rate && <p className="text-zinc-400"><span className="font-bold">RATE:</span> ${v.rate}/hr</p>}
            </div>
            <div className="border-t-2 border-zinc-700 pt-3 flex justify-between">
              <div>
                <div className="text-xs text-zinc-500 font-bold">JOBS</div>
                <div className="text-xl font-black text-teal-400">{getJobs(v.name)}</div>
              </div>
              <div className="text-right">
                <div className="text-xs text-zinc-500 font-bold">TOTAL COST</div>
                <div className="text-xl font-black text-teal-400">${getTotalCost(v.name).toFixed(2)}</div>
              </div>
            </div>
          </div>
        ))}
      </div>
      {filtered.length === 0 && (
        <div className="text-center py-12 bg-zinc-800 border-2 border-zinc-700">
          <p className="text-zinc-500 font-bold">NO VENDORS FOUND</p>
        </div>
      )}
    </div>
  );
};

// Inventory Tab - NEW IN SPRINT 2
const InventoryTab = ({ parts, partsUsage, vendors, onAdd, onEdit, onDelete, onImport, permissions }) => {
  const [search, setSearch] = useState('');
  
  const filtered = parts.filter(p => 
    p.name?.toLowerCase().includes(search.toLowerCase()) ||
    p.sku?.toLowerCase().includes(search.toLowerCase())
  );

  const getUsageCount = (partId) => {
    return partsUsage.filter(u => u.partId === partId).reduce((sum, u) => sum + parseInt(u.qty || 0), 0);
  };

  const getStockStatus = (stock, minStock) => {
    const s = parseInt(stock);
    const m = parseInt(minStock);
    if (s === 0) return { color: 'red', label: 'OUT' };
    if (s <= m) return { color: 'yellow', label: 'LOW' };
    return { color: 'green', label: 'OK' };
  };

  return (
    <div>
      <div className="flex justify-between mb-4 flex-wrap gap-4">
        <h2 className="text-2xl font-black text-teal-400 flex items-center gap-2">
          <Icon name="package" size={24} /> PARTS INVENTORY
        </h2>
        <div className="flex gap-3 flex-wrap">
          <div className="relative">
            <div className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500">
              <Icon name="search" size={16} />
            </div>
            <input type="text" placeholder="SEARCH..." value={search} onChange={e => setSearch(e.target.value)} className="bg-zinc-800 border-2 border-zinc-700 text-white pl-10 pr-4 py-2 font-bold focus:border-teal-500 outline-none" />
          </div>
          {permissions.canEdit && (
            <>
              <button onClick={onImport} className="bg-yellow-600 hover:bg-yellow-500 text-white px-4 sm:px-6 py-2 font-black border-2 border-yellow-700 flex items-center justify-center gap-2 text-sm sm:text-base">
                <Icon name="file" /> IMPORT RECEIPT
              </button>
              <button onClick={onAdd} className="bg-teal-600 hover:bg-teal-500 text-white px-4 sm:px-6 py-2 font-black border-2 border-teal-700 flex items-center justify-center gap-2 text-sm sm:text-base">
                <Icon name="plus" /> ADD PART
              </button>
            </>
          )}
        </div>
      </div>
      <div className="bg-zinc-800 border-2 border-zinc-700 overflow-x-auto">
        <table className="w-full">
          <thead className="bg-zinc-900 border-b-2 border-teal-600">
            <tr>
              <th className="px-4 py-3 text-left text-teal-400 font-black text-sm">PART NAME</th>
              <th className="px-4 py-3 text-left text-teal-400 font-black text-sm">SKU</th>
              <th className="px-4 py-3 text-left text-teal-400 font-black text-sm">BIN</th>
              <th className="px-4 py-3 text-center text-teal-400 font-black text-sm">STOCK</th>
              <th className="px-4 py-3 text-center text-teal-400 font-black text-sm">MIN</th>
              {permissions.canSeeCosts && <th className="px-4 py-3 text-right text-teal-400 font-black text-sm">COST</th>}
              <th className="px-4 py-3 text-center text-teal-400 font-black text-sm">USED</th>
              <th className="px-4 py-3 text-center text-teal-400 font-black text-sm">STATUS</th>
              {permissions.canEdit && <th className="px-4 py-3 text-center text-teal-400 font-black text-sm">ACTIONS</th>}
            </tr>
          </thead>
          <tbody>
            {filtered.sort((a,b) => parseInt(a.stock) - parseInt(b.stock)).map(p => {
              const status = getStockStatus(p.stock, p.minStock);
              const vendor = vendors.find(v => v.id === p.vendorId);
              return (
                <tr key={p.id} className="border-b border-zinc-700 hover:bg-zinc-750">
                  <td className="px-4 py-3">
                    <div className="text-white font-bold">{p.name}</div>
                    {vendor && <div className="text-xs text-zinc-500">{vendor.name}</div>}
                  </td>
                  <td className="px-4 py-3 text-zinc-300">{p.sku}</td>
                  <td className="px-4 py-3">
                    {p.binLocation ? (
                      <span className="px-2 py-1 text-xs font-black bg-zinc-700 text-zinc-300">{p.binLocation}</span>
                    ) : (
                      <span className="text-xs text-zinc-600">-</span>
                    )}
                  </td>
                  <td className="px-4 py-3 text-center text-white font-bold">{p.stock}</td>
                  <td className="px-4 py-3 text-center text-zinc-400">{p.minStock}</td>
                  {permissions.canSeeCosts && <td className="px-4 py-3 text-right text-teal-400 font-bold">${parseFloat(p.cost || 0).toFixed(2)}</td>}
                  <td className="px-4 py-3 text-center text-zinc-400">{getUsageCount(p.id)}</td>
                  <td className="px-4 py-3 text-center">
                    {p.snoozed ? (
                      <span className="px-2 py-1 text-xs font-black bg-gray-800 text-gray-400 border border-gray-600">
                        IGNORED
                      </span>
                    ) : (
                      <span className={`px-2 py-1 text-xs font-black ${status.color === 'red' ? 'bg-red-900 text-red-400' : status.color === 'yellow' ? 'bg-yellow-900 text-yellow-400' : 'bg-green-900 text-green-400'}`}>
                        {status.label}
                      </span>
                    )}
                  </td>
                  {permissions.canEdit && (
                    <td className="px-4 py-3 text-center">
                      <div className="flex justify-center gap-2">
                        {p.snoozed && (
                          <button 
                            onClick={() => window.snoozePart && window.snoozePart(p.id)} 
                            className="text-yellow-400 hover:text-yellow-300" 
                            title="Un-ignore alerts for this part"
                          >
                            <Icon name="bell" size={16} />
                          </button>
                        )}
                        <button onClick={() => onEdit(p)} className="text-teal-400 hover:text-teal-300" title="Edit">
                          <Icon name="edit" size={16} />
                        </button>
                        {permissions.canDelete && (
                          <button onClick={() => onDelete(p.id)} className="text-red-400 hover:text-red-300" title="Delete">
                            <Icon name="trash" size={16} />
                          </button>
                        )}
                      </div>
                    </td>
                  )}
                </tr>
              );
            })}
          </tbody>
        </table>
        {filtered.length === 0 && (
          <div className="text-center py-8 text-zinc-500 font-bold">NO PARTS IN INVENTORY</div>
        )}
      </div>
    </div>
  );
};

// Request Management Tab - Sprint 5 Step 7
const RequestManagementTab = ({ requests, machines, onResolve, onConvert, permissions }) => {
  const [filter, setFilter] = useState('Pending');
  
  const filtered = requests.filter(r => filter === 'All' || r.status === filter);
  const sortedRequests = filtered.sort((a, b) => {
    // Sort by urgency first (High > Medium > Low), then by date (newest first)
    const urgencyOrder = { 'High': 3, 'Medium': 2, 'Low': 1 };
    const urgencyDiff = (urgencyOrder[b.urgency] || 0) - (urgencyOrder[a.urgency] || 0);
    if (urgencyDiff !== 0) return urgencyDiff;
    return new Date(b.submittedDate) - new Date(a.submittedDate);
  });
  
  return (
    <div>
      <div className="flex justify-between mb-4 flex-wrap gap-4">
        <h2 className="text-2xl font-black text-orange-400 flex items-center gap-2">
          <Icon name="alert" size={24} /> MAINTENANCE REQUESTS
        </h2>
        <div className="flex gap-2 flex-wrap">
          {['All', 'Pending', 'In Progress', 'Resolved'].map(f => (
            <button 
              key={f}
              onClick={() => setFilter(f)}
              className={`px-4 py-2 font-bold border-2 ${filter === f ? 'bg-orange-600 text-white border-orange-700' : 'bg-zinc-800 text-orange-400 border-zinc-700 hover:bg-zinc-700'}`}
            >
              {f} ({requests.filter(r => f === 'All' || r.status === f).length})
            </button>
          ))}
        </div>
      </div>
      
      {sortedRequests.length === 0 ? (
        <div className="bg-zinc-800 border-2 border-zinc-700 p-12 text-center">
          <Icon name="check" size={48} className="inline-block text-green-400 mb-4" />
          <p className="text-zinc-400 font-bold text-lg">NO {filter.toUpperCase()} REQUESTS</p>
          <p className="text-zinc-500 text-sm mt-2">
            {filter === 'Pending' ? 'All caught up! No pending maintenance requests.' : `No requests with status "${filter}"`}
          </p>
        </div>
      ) : (
        <div className="bg-zinc-800 border-2 border-zinc-700 overflow-x-auto">
          <table className="w-full">
            <thead className="bg-zinc-900 border-b-2 border-orange-600">
              <tr>
                <th className="px-4 py-3 text-left text-orange-400 font-black text-sm">DATE</th>
                <th className="px-4 py-3 text-left text-orange-400 font-black text-sm">MACHINE</th>
                <th className="px-4 py-3 text-left text-orange-400 font-black text-sm">ISSUE</th>
                <th className="px-4 py-3 text-left text-orange-400 font-black text-sm">SUBMITTED BY</th>
                <th className="px-4 py-3 text-center text-orange-400 font-black text-sm">URGENCY</th>
                <th className="px-4 py-3 text-center text-orange-400 font-black text-sm">STATUS</th>
                {permissions.canEdit && <th className="px-4 py-3 text-center text-orange-400 font-black text-sm">ACTIONS</th>}
              </tr>
            </thead>
            <tbody>
              {sortedRequests.map(r => {
                const machine = machines.find(m => m.id === r.machineId);
                const urgencyColors = {
                  'High': { bg: 'bg-red-900', text: 'text-red-400', border: 'border-red-600' },
                  'Medium': { bg: 'bg-yellow-900', text: 'text-yellow-400', border: 'border-yellow-600' },
                  'Low': { bg: 'bg-green-900', text: 'text-green-400', border: 'border-green-600' }
                };
                const statusColors = {
                  'Resolved': { bg: 'bg-green-900', text: 'text-green-400' },
                  'In Progress': { bg: 'bg-blue-900', text: 'text-blue-400' },
                  'Pending': { bg: 'bg-orange-900', text: 'text-orange-400' }
                };
                const urgency = urgencyColors[r.urgency] || urgencyColors['Medium'];
                const status = statusColors[r.status] || statusColors['Pending'];
                
                return (
                  <tr key={r.id} className="border-b border-zinc-700 hover:bg-zinc-700">
                    <td className="px-4 py-3 text-white font-bold">{formatDateSlash(r.submittedDate.split('T')[0])}</td>
                    <td className="px-4 py-3">
                      <div className="text-white font-bold">{machine?.name || 'Unknown'}</div>
                      <div className="text-xs text-zinc-500">{machine?.model || ''}</div>
                    </td>
                    <td className="px-4 py-3">
                      <div className="text-zinc-300">{r.issue.substring(0, 80)}{r.issue.length > 80 ? '...' : ''}</div>
                      {r.notes && <div className="text-xs text-zinc-500 mt-1">Notes: {r.notes.substring(0, 50)}{r.notes.length > 50 ? '...' : ''}</div>}
                    </td>
                    <td className="px-4 py-3 text-zinc-300">{r.submittedBy}</td>
                    <td className="px-4 py-3 text-center">
                      <span className={`px-2 py-1 text-xs font-bold ${urgency.bg} ${urgency.text} border ${urgency.border}`}>
                        {r.urgency}
                      </span>
                    </td>
                    <td className="px-4 py-3 text-center">
                      <span className={`px-2 py-1 text-xs font-bold ${status.bg} ${status.text}`}>
                        {r.status}
                      </span>
                      {r.resolvedDate && (
                        <div className="text-xs text-zinc-500 mt-1">
                          {formatDateSlash(r.resolvedDate.split('T')[0])}
                        </div>
                      )}
                    </td>
                    {permissions.canEdit && (
                      <td className="px-4 py-3 text-center">
                        <div className="flex gap-2 justify-center flex-wrap">
                          {r.status === 'Pending' && (
                            <>
                              <button 
                                onClick={() => onConvert(r)} 
                                className="px-2 py-1 bg-teal-600 hover:bg-teal-500 text-white text-xs font-bold whitespace-nowrap"
                                title="Create repair from this request"
                              >
                                CREATE REPAIR
                              </button>
                              <button 
                                onClick={() => onResolve(r.id)} 
                                className="px-2 py-1 bg-green-600 hover:bg-green-500 text-white text-xs font-bold"
                                title="Mark as resolved"
                              >
                                RESOLVE
                              </button>
                            </>
                          )}
                          {r.status === 'In Progress' && (
                            <button 
                              onClick={() => onResolve(r.id)} 
                              className="px-2 py-1 bg-green-600 hover:bg-green-500 text-white text-xs font-bold"
                            >
                              RESOLVE
                            </button>
                          )}
                          {r.status === 'Resolved' && (
                            <span className="text-xs text-zinc-500 italic">Completed</span>
                          )}
                        </div>
                      </td>
                    )}
                  </tr>
                );
              })}
            </tbody>
          </table>
        </div>
      )}
      
      {sortedRequests.length > 0 && (
        <div className="mt-4 bg-zinc-900 border-2 border-zinc-700 p-4">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
            <div>
              <div className="text-zinc-500 text-sm font-bold">TOTAL REQUESTS</div>
              <div className="text-2xl font-black text-white">{requests.length}</div>
            </div>
            <div>
              <div className="text-zinc-500 text-sm font-bold">PENDING</div>
              <div className="text-2xl font-black text-orange-400">{requests.filter(r => r.status === 'Pending').length}</div>
            </div>
            <div>
              <div className="text-zinc-500 text-sm font-bold">IN PROGRESS</div>
              <div className="text-2xl font-black text-blue-400">{requests.filter(r => r.status === 'In Progress').length}</div>
            </div>
            <div>
              <div className="text-zinc-500 text-sm font-bold">RESOLVED</div>
              <div className="text-2xl font-black text-green-400">{requests.filter(r => r.status === 'Resolved').length}</div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

// Reports Tab - NEW IN SPRINT 2
const ReportsTab = ({ machines, equipmentLogs, buildingLogs, parts, partsUsage, year }) => {
  const canvasRef1 = useRef(null);
  const canvasRef2 = useRef(null);
  const canvasRef3 = useRef(null);
  const chart1 = useRef(null);
  const chart2 = useRef(null);
  const chart3 = useRef(null);

  useEffect(() => {
    // Monthly Expenses Chart
    if (canvasRef1.current) {
      if (chart1.current) chart1.current.destroy();
      
      const monthlyData = Array(12).fill(0).map((_, i) => {
        const equipCost = equipmentLogs.filter(l => {
          const d = new Date(l.date);
          return d.getMonth() === i && d.getFullYear() === year;
        }).reduce((s, l) => s + parseFloat(l.cost || 0), 0);
        
        const bldgCost = buildingLogs.filter(l => {
          const d = new Date(l.date);
          return d.getMonth() === i && d.getFullYear() === year;
        }).reduce((s, l) => s + parseFloat(l.cost || 0), 0);
        
        return { equip: equipCost, bldg: bldgCost };
      });

      chart1.current = new Chart(canvasRef1.current, {
        type: 'bar',
        data: {
          labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
          datasets: [
            {
              label: 'Equipment',
              data: monthlyData.map(d => d.equip),
              backgroundColor: 'rgba(20, 184, 166, 0.8)',
            },
            {
              label: 'Building',
              data: monthlyData.map(d => d.bldg),
              backgroundColor: 'rgba(100, 116, 139, 0.8)',
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#fff', font: { weight: 'bold' } } },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': $' + context.parsed.y.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                }
              }
            }
          },
          scales: {
            y: { 
              ticks: { 
                color: '#94a3b8',
                callback: function(value) {
                  return '$' + value.toLocaleString('en-US', {minimumFractionDigits: 0});
                }
              }, 
              grid: { color: '#3f3f46' } 
            },
            x: { ticks: { color: '#94a3b8' }, grid: { color: '#3f3f46' } }
          }
        }
      });
    }

    // Equipment Breakdown Pie
    if (canvasRef2.current) {
      if (chart2.current) chart2.current.destroy();
      
      const machineData = machines.filter(m => !m.archived).map(m => ({
        name: m.name,
        cost: equipmentLogs.filter(l => l.machineId === m.id && new Date(l.date).getFullYear() === year)
          .reduce((s, l) => s + parseFloat(l.cost || 0), 0)
      })).filter(m => m.cost > 0).sort((a, b) => b.cost - a.cost).slice(0, 5);

      if (machineData.length > 0) {
        chart2.current = new Chart(canvasRef2.current, {
          type: 'pie',
          data: {
            labels: machineData.map(m => m.name),
            datasets: [{
              data: machineData.map(m => m.cost),
              backgroundColor: [
                'rgba(20, 184, 166, 0.8)',
                'rgba(34, 211, 238, 0.8)',
                'rgba(147, 51, 234, 0.8)',
                'rgba(236, 72, 153, 0.8)',
                'rgba(251, 146, 60, 0.8)',
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#fff', font: { weight: 'bold' } } },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.label + ': $' + context.parsed.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                  }
                }
              }
            }
          }
        });
      }
    }

    // Parts Usage Chart
    if (canvasRef3.current) {
      if (chart3.current) chart3.current.destroy();
      
      const partsData = parts.map(p => ({
        name: p.name,
        qty: partsUsage.filter(u => u.partId === p.id && new Date(u.date).getFullYear() === year)
          .reduce((s, u) => s + parseInt(u.qty || 0), 0)
      })).filter(p => p.qty > 0).sort((a, b) => b.qty - a.qty).slice(0, 10);

      if (partsData.length > 0) {
        chart3.current = new Chart(canvasRef3.current, {
          type: 'bar',
          data: {
            labels: partsData.map(p => p.name),
            datasets: [{
              label: 'Quantity Used',
              data: partsData.map(p => p.qty),
              backgroundColor: 'rgba(20, 184, 166, 0.8)',
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
              legend: { display: false }
            },
            scales: {
              x: { 
                ticks: { 
                  color: '#94a3b8',
                  stepSize: 1,
                  callback: function(value) {
                    if (Math.floor(value) === value) {
                      return value;
                    }
                  }
                }, 
                grid: { color: '#3f3f46' } 
              },
              y: { ticks: { color: '#94a3b8' }, grid: { color: '#3f3f46' } }
            }
          }
        });
      }
    }

    return () => {
      if (chart1.current) chart1.current.destroy();
      if (chart2.current) chart2.current.destroy();
      if (chart3.current) chart3.current.destroy();
    };
  }, [machines, equipmentLogs, buildingLogs, parts, partsUsage, year]);

  const exportEquipmentCSV = () => {
    const data = machines.map(m => ({
      Name: m.name,
      Model: m.model,
      Serial: m.serial,
      Type: m.type,
      PurchaseDate: m.purchaseDate,
      Archived: m.archived ? 'Yes' : 'No'
    }));
    exportToCSV(data, `equipment-${year}.csv`);
  };

  const exportRepairsCSV = () => {
    const data = equipmentLogs.filter(l => new Date(l.date).getFullYear() === year).map(l => ({
      Date: l.date,
      Machine: machines.find(m => m.id === l.machineId)?.name || 'Unknown',
      Issue: l.issue,
      Tech: l.tech,
      Cost: l.cost,
      Hours: l.hours,
      Notes: l.notes
    }));
    exportToCSV(data, `repairs-${year}.csv`);
  };

  const exportPartsCSV = () => {
    const data = parts.map(p => ({
      Name: p.name,
      SKU: p.sku,
      Stock: p.stock,
      MinStock: p.minStock,
      Cost: p.cost,
      Notes: p.notes
    }));
    exportToCSV(data, `parts-inventory-${year}.csv`);
  };

  return (
    <div className="space-y-6">
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <h2 className="text-2xl font-black text-teal-400 flex items-center gap-2">
          <Icon name="chart" size={24} /> REPORTS & ANALYTICS
        </h2>
        <div className="flex gap-2 flex-wrap">
          <button onClick={exportEquipmentCSV} className="bg-zinc-800 hover:bg-zinc-700 border-2 border-teal-500 text-teal-400 px-3 sm:px-4 py-2 font-bold flex items-center gap-2 text-xs sm:text-sm">
            <Icon name="download" size={16} /> EQUIPMENT
          </button>
          <button onClick={exportRepairsCSV} className="bg-zinc-800 hover:bg-zinc-700 border-2 border-teal-500 text-teal-400 px-3 sm:px-4 py-2 font-bold flex items-center gap-2 text-xs sm:text-sm">
            <Icon name="download" size={16} /> REPAIRS
          </button>
          <button onClick={exportPartsCSV} className="bg-zinc-800 hover:bg-zinc-700 border-2 border-teal-500 text-teal-400 px-3 sm:px-4 py-2 font-bold flex items-center gap-2 text-xs sm:text-sm">
            <Icon name="download" size={16} /> PARTS
          </button>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
        <div className="bg-zinc-800 border-2 border-zinc-700 p-4">
          <h3 className="text-lg font-black text-white mb-4">MONTHLY EXPENSES ({year})</h3>
          <div style={{ height: '300px' }}>
            <canvas ref={canvasRef1}></canvas>
          </div>
        </div>

        <div className="bg-zinc-800 border-2 border-zinc-700 p-4">
          <h3 className="text-lg font-black text-white mb-4">TOP 5 EQUIPMENT COSTS ({year})</h3>
          <div style={{ height: '300px' }}>
            <canvas ref={canvasRef2}></canvas>
          </div>
        </div>
      </div>

      <div className="bg-zinc-800 border-2 border-zinc-700 p-4">
        <h3 className="text-lg font-black text-white mb-4">TOP 10 PARTS USED ({year})</h3>
        <div style={{ height: '400px' }}>
          <canvas ref={canvasRef3}></canvas>
        </div>
      </div>
    </div>
  );
};


// Machine Modal (from Sprint 1)
const MachineModal = ({ machine, onClose, onSave }) => {
  const [form, setForm] = useState(machine || { 
    name: '', 
    model: '', 
    serial: '', 
    type: 'Washer', 
    purchaseDate: '',
    purchasePrice: ''
  });

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(form);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
      <div className="bg-zinc-800 border-4 border-teal-600 max-w-md w-full p-6">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-teal-400">{machine ? 'EDIT' : 'ADD'} MACHINE</h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">MACHINE NAME</label>
            <input type="text" required value={form.name} onChange={e => setForm({...form, name: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" placeholder="e.g., Washer #1" />
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">TYPE</label>
            <select value={form.type} onChange={e => setForm({...form, type: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500">
              <option>Washer</option>
              <option>Dryer</option>
              <option>Folding Table</option>
              <option>Vending Machine</option>
              <option>Other</option>
            </select>
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">MODEL</label>
            <input type="text" required value={form.model} onChange={e => setForm({...form, model: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" placeholder="e.g., Speed Queen" />
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">SERIAL NUMBER</label>
            <input type="text" required value={form.serial} onChange={e => setForm({...form, serial: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" placeholder="e.g., SQ123" />
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">PURCHASE DATE (optional)</label>
            <input type="date" value={form.purchaseDate} onChange={e => setForm({...form, purchaseDate: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">PURCHASE PRICE (optional)</label>
            <div className="relative">
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500 font-bold">$</span>
              <input 
                type="number" 
                step="0.01"
                value={form.purchasePrice} 
                onChange={e => setForm({...form, purchasePrice: e.target.value})} 
                className="w-full bg-zinc-900 border-2 border-zinc-700 text-white pl-8 pr-3 py-2 font-bold outline-none focus:border-teal-500" 
                placeholder="e.g., 1500.00"
              />
            </div>
            <p className="text-xs text-zinc-500 mt-1">Used for accurate ROI calculations</p>
          </div>
          <div className="flex gap-3 pt-4">
            <button type="button" onClick={onClose} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">CANCEL</button>
            <button type="submit" className="flex-1 bg-teal-600 hover:bg-teal-500 text-white px-4 py-3 font-black border-2 border-teal-700 flex items-center justify-center gap-2">
              <Icon name="save" size={16} /> SAVE
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// Repair Modal (from Sprint 1 - with active machines filter)
const RepairModal = ({ machines, parts, onClose, onSave, prefill }) => {
  const [form, setForm] = useState({
    machineId: prefill?.machineId || machines.filter(m => !m.archived)[0]?.id || '',
    date: getTodayLocal(),
    issue: prefill?.issue || '',
    tech: '',
    laborCost: '',
    hours: '0',
    notes: prefill?.notes || '',
    warranty: false,
  });
  const [selectedParts, setSelectedParts] = useState([]);
  const [photoFiles, setPhotoFiles] = useState([]);
  const [previews, setPreviews] = useState([]);
  const fileRef = useRef(null);

  const activeMachines = machines.filter(m => !m.archived);
  
  // Calculate costs (needed by validateForm)
  const partsCost = selectedParts.reduce((sum, p) => sum + (parseFloat(p.qty || 0) * parseFloat(p.cost || 0)), 0);
  const totalCost = partsCost + parseFloat(form.laborCost || 0);

  // Simple validation - only check if required fields exist
  const validateForm = () => {
    if (!form.machineId) {
      alert('Please select a machine');
      return false;
    }
    if (!form.issue || form.issue.trim() === '') {
      alert('Please enter an issue description');
      return false;
    }
    if (!form.tech || form.tech.trim() === '') {
      alert('Please enter a technician name');
      return false;
    }
    
    // Warn about high costs
    if (totalCost > 1000) {
      if (!window.confirm(`This is a high-cost repair ($${totalCost.toFixed(2)}). Continue?`)) {
        return false;
      }
    }
    
    return true;
  };

  const addPart = () => {
    setSelectedParts([...selectedParts, { id: parts[0]?.id || '', qty: '1', cost: parts[0]?.cost || '0' }]);
  };

  const updatePart = (index, field, value) => {
    const updated = [...selectedParts];
    if (field === 'id') {
      const part = parts.find(p => p.id === value);
      updated[index] = { ...updated[index], id: value, cost: part?.cost || '0' };
    } else {
      updated[index][field] = value;
    }
    setSelectedParts(updated);
  };

  const removePart = (index) => {
    setSelectedParts(selectedParts.filter((_, i) => i !== index));
  };

  const handlePhotoSelect = (e) => {
    const files = Array.from(e.target.files);
    setPhotoFiles([...photoFiles, ...files]);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = () => setPreviews(prev => [...prev, reader.result]);
      reader.readAsDataURL(file);
    });
  };

  const removePhoto = (index) => {
    setPhotoFiles(photoFiles.filter((_, i) => i !== index));
    setPreviews(previews.filter((_, i) => i !== index));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    
    // Simple validation
    if (!validateForm()) {
      return;
    }

    onSave(form, selectedParts, photoFiles);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
      <div className="bg-zinc-800 border-4 border-teal-600 max-w-2xl w-full p-6 my-8">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-teal-400">ADD REPAIR LOG</h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">MACHINE</label>
              <select required value={form.machineId} onChange={e => setForm({...form, machineId: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500">
                {activeMachines.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
              </select>
            </div>
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">DATE</label>
              <input type="date" required value={form.date} onChange={e => setForm({...form, date: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">ISSUE / REPAIR</label>
            <textarea required value={form.issue} onChange={e => setForm({...form, issue: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500 h-20" placeholder="Describe problem..." />
          </div>
          
          <div className="border-2 border-teal-600 p-4">
            <div className="flex justify-between items-center mb-3">
              <label className="text-xs font-black text-teal-400">PARTS USED (AUTO-DEDUCTED)</label>
              <button type="button" onClick={addPart} disabled={parts.length === 0} className="bg-teal-600 hover:bg-teal-500 disabled:bg-zinc-700 text-white px-3 py-1 text-sm font-bold">
                + ADD PART
              </button>
            </div>
            {selectedParts.length === 0 && <p className="text-zinc-500 text-sm italic">No parts selected</p>}
            {selectedParts.map((part, i) => {
              const partData = parts.find(p => p.id === part.id);
              const stock = parseInt(partData?.stock || 0);
              const lowStock = stock <= parseInt(partData?.minStock || 0);
              return (
                <div key={i} className="grid grid-cols-12 gap-2 mb-2 items-center">
                  <select value={part.id} onChange={e => updatePart(i, 'id', e.target.value)} className="col-span-5 bg-zinc-900 border-2 border-zinc-700 text-white px-2 py-1 text-sm font-bold">
                    {parts.map(p => (
                      <option key={p.id} value={p.id}>{p.name} (Stock: {p.stock})</option>
                    ))}
                  </select>
                  <input type="number" min="1" value={part.qty} onChange={e => updatePart(i, 'qty', e.target.value)} className="col-span-2 bg-zinc-900 border-2 border-zinc-700 text-white px-2 py-1 text-sm font-bold text-center" placeholder="Qty" />
                  <div className="col-span-2 text-white text-sm font-bold text-right">
                    ${(parseFloat(part.qty) * parseFloat(part.cost)).toFixed(2)}
                  </div>
                  <div className="col-span-2 text-xs">
                    {lowStock && <span className="text-red-400 font-bold">‚ö†Ô∏è LOW</span>}
                    {stock === 0 && <span className="text-red-400 font-bold">OUT!</span>}
                  </div>
                  <button type="button" onClick={() => removePart(i)} className="col-span-1 text-red-400 hover:text-red-300">
                    <Icon name="trash" size={16} />
                  </button>
                </div>
              );
            })}
            {selectedParts.length > 0 && (
              <div className="mt-3 pt-3 border-t border-zinc-700 text-right">
                <span className="text-teal-400 font-bold">Parts Subtotal: ${partsCost.toFixed(2)}</span>
              </div>
            )}
          </div>

          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">NOTES (Part Numbers, Details)</label>
            <textarea value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500 h-20" placeholder="P/N, additional details..." />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">TECHNICIAN</label>
              <input type="text" required value={form.tech} onChange={e => setForm({...form, tech: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">LABOR HOURS</label>
              <input type="number" step="0.5" required value={form.hours} onChange={e => setForm({...form, hours: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">LABOR COST</label>
            <div className="relative">
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-teal-400 font-bold">$</span>
              <input type="number" step="0.01" required value={form.laborCost} onChange={e => setForm({...form, laborCost: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white pl-8 pr-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
          </div>
          
          <div className="bg-zinc-900 border-2 border-zinc-700 p-3">
            <label className="flex items-center gap-3 cursor-pointer">
              <input 
                type="checkbox" 
                checked={form.warranty} 
                onChange={e => setForm({...form, warranty: e.target.checked})} 
                className="w-5 h-5 accent-teal-500"
              />
              <div>
                <span className="text-white font-bold">Warranty Repair</span>
                <p className="text-xs text-zinc-400">Exclude total repair cost from equipment cost reports</p>
              </div>
            </label>
          </div>
          
          <div className="bg-zinc-900 border-2 border-teal-600 p-3">
            <div className="text-sm text-zinc-400 mb-1">TOTAL REPAIR COST:</div>
            <div className="text-2xl font-black text-teal-400">${totalCost.toFixed(2)}</div>
            <div className="text-xs text-zinc-500">Parts: ${partsCost.toFixed(2)} + Labor: ${parseFloat(form.laborCost || 0).toFixed(2)}</div>
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">PHOTOS / DOCUMENTS</label>
            <input ref={fileRef} type="file" accept="image/*,.eml,.pdf,.doc,.docx" multiple onChange={handlePhotoSelect} className="hidden" />
            <button type="button" onClick={() => fileRef.current?.click()} className="bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-2 font-bold border-2 border-zinc-600 flex items-center gap-2">
              <Icon name="image" /> ADD FILES
            </button>
            {previews.length > 0 && (
              <div className="mt-3 grid grid-cols-4 gap-2">
                {previews.map((src, i) => (
                  <div key={i} className="relative group">
                    <img src={src} className="w-full h-20 object-cover border-2 border-zinc-700" />
                    <button type="button" onClick={() => removePhoto(i)} className="absolute top-1 right-1 bg-red-600 text-white p-1 opacity-0 group-hover:opacity-100">
                      <Icon name="x" size={16} />
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
          <div className="flex gap-3 pt-4">
            <button type="button" onClick={onClose} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">CANCEL</button>
            <button type="submit" className="flex-1 bg-teal-600 hover:bg-teal-500 text-white px-4 py-3 font-black border-2 border-teal-700 flex items-center justify-center gap-2">
              <Icon name="save" size={16} /> SAVE & DEDUCT
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// Building Modal (from Sprint 1)
const BuildingModal = ({ onClose, onSave }) => {
  const [form, setForm] = useState({
    date: getTodayLocal(),
    category: 'HVAC',
    issue: '',
    tech: '',
    cost: '',
    hours: '0',
    notes: '',
  });
  const [photoFiles, setPhotoFiles] = useState([]);
  const [previews, setPreviews] = useState([]);
  const fileRef = useRef(null);

  const handlePhotoSelect = (e) => {
    const files = Array.from(e.target.files);
    setPhotoFiles([...photoFiles, ...files]);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = () => setPreviews(prev => [...prev, reader.result]);
      reader.readAsDataURL(file);
    });
  };

  const removePhoto = (index) => {
    setPhotoFiles(photoFiles.filter((_, i) => i !== index));
    setPreviews(previews.filter((_, i) => i !== index));
  };

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(form, photoFiles);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
      <div className="bg-zinc-800 border-4 border-teal-600 max-w-2xl w-full p-6 my-8">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-teal-400">ADD BUILDING LOG</h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">CATEGORY</label>
              <select required value={form.category} onChange={e => setForm({...form, category: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500">
                <option>HVAC</option>
                <option>Plumbing</option>
                <option>Electrical</option>
                <option>Roof</option>
                <option>Flooring</option>
                <option>Walls/Paint</option>
                <option>Windows/Doors</option>
                <option>Parking Lot</option>
                <option>Landscaping</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">DATE</label>
              <input type="date" required value={form.date} onChange={e => setForm({...form, date: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">ISSUE / REPAIR</label>
            <textarea required value={form.issue} onChange={e => setForm({...form, issue: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500 h-20" placeholder="Describe problem..." />
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">NOTES</label>
            <textarea value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500 h-20" placeholder="Additional details..." />
          </div>
          <div className="grid grid-cols-3 gap-4">
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">TECHNICIAN</label>
              <input type="text" required value={form.tech} onChange={e => setForm({...form, tech: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">LABOR HOURS</label>
              <input type="number" step="0.5" required value={form.hours} onChange={e => setForm({...form, hours: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">COST</label>
              <div className="relative">
                <span className="absolute left-3 top-1/2 -translate-y-1/2 text-teal-400 font-bold">$</span>
                <input type="number" step="0.01" required value={form.cost} onChange={e => setForm({...form, cost: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white pl-8 pr-3 py-2 font-bold outline-none focus:border-teal-500" />
              </div>
            </div>
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">PHOTOS / DOCUMENTS</label>
            <input ref={fileRef} type="file" accept="image/*,.eml,.pdf,.doc,.docx" multiple onChange={handlePhotoSelect} className="hidden" />
            <button type="button" onClick={() => fileRef.current?.click()} className="bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-2 font-bold border-2 border-zinc-600 flex items-center gap-2">
              <Icon name="image" /> ADD FILES
            </button>
            {previews.length > 0 && (
              <div className="mt-3 grid grid-cols-4 gap-2">
                {previews.map((src, i) => (
                  <div key={i} className="relative group">
                    <img src={src} className="w-full h-20 object-cover border-2 border-zinc-700" />
                    <button type="button" onClick={() => removePhoto(i)} className="absolute top-1 right-1 bg-red-600 text-white p-1 opacity-0 group-hover:opacity-100">
                      <Icon name="x" size={16} />
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>
          <div className="flex gap-3 pt-4">
            <button type="button" onClick={onClose} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">CANCEL</button>
            <button type="submit" className="flex-1 bg-teal-600 hover:bg-teal-500 text-white px-4 py-3 font-black border-2 border-teal-700 flex items-center justify-center gap-2">
              <Icon name="save" size={16} /> SAVE
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};


// Vendor Modal - NEW IN SPRINT 2
const VendorModal = ({ vendor, onClose, onSave }) => {
  const [form, setForm] = useState(vendor || { name: '', contact: '', phone: '', email: '', specialties: '', rate: '', notes: '' });

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(form);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
      <div className="bg-zinc-800 border-4 border-teal-600 max-w-md w-full p-6">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-teal-400">{vendor ? 'EDIT' : 'ADD'} VENDOR</h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">COMPANY NAME</label>
            <input type="text" required value={form.name} onChange={e => setForm({...form, name: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" placeholder="e.g., ABC HVAC" />
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">CONTACT PERSON</label>
            <input type="text" value={form.contact} onChange={e => setForm({...form, contact: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" placeholder="e.g., John Smith" />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">PHONE</label>
              <input type="tel" value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" placeholder="555-1234" />
            </div>
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">EMAIL</label>
              <input type="email" value={form.email} onChange={e => setForm({...form, email: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" placeholder="email@..." />
            </div>
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">SPECIALTIES</label>
            <input type="text" value={form.specialties} onChange={e => setForm({...form, specialties: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" placeholder="e.g., HVAC, Plumbing" />
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">HOURLY RATE</label>
            <div className="relative">
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-teal-400 font-bold">$</span>
              <input type="number" step="0.01" value={form.rate} onChange={e => setForm({...form, rate: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white pl-8 pr-3 py-2 font-bold outline-none focus:border-teal-500" placeholder="0.00" />
            </div>
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">NOTES</label>
            <textarea value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500 h-20" placeholder="Additional info..." />
          </div>
          <div className="flex gap-3 pt-4">
            <button type="button" onClick={onClose} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">CANCEL</button>
            <button type="submit" className="flex-1 bg-teal-600 hover:bg-teal-500 text-white px-4 py-3 font-black border-2 border-teal-700 flex items-center justify-center gap-2">
              <Icon name="save" size={16} /> SAVE
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// Part Modal - NEW IN SPRINT 2
const PartModal = ({ part, vendors, onClose, onSave }) => {
  const [form, setForm] = useState(part || { name: '', sku: '', stock: '0', minStock: '0', cost: '0', vendorId: '', binLocation: '', notes: '' });

  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(form);
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
      <div className="bg-zinc-800 border-4 border-teal-600 max-w-md w-full p-6">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-teal-400">{part ? 'EDIT' : 'ADD'} PART</h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">PART NAME</label>
            <input type="text" required value={form.name} onChange={e => setForm({...form, name: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" placeholder="e.g., Belt V-123" />
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">SKU / PART NUMBER</label>
            <input type="text" required value={form.sku} onChange={e => setForm({...form, sku: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" placeholder="e.g., V123" />
          </div>
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">CURRENT STOCK</label>
              <input type="number" required min="0" value={form.stock} onChange={e => setForm({...form, stock: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">MIN STOCK</label>
              <input type="number" required min="0" value={form.minStock} onChange={e => setForm({...form, minStock: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">UNIT COST</label>
            <div className="relative">
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-teal-400 font-bold">$</span>
              <input type="number" step="0.01" required value={form.cost} onChange={e => setForm({...form, cost: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white pl-8 pr-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">VENDOR (optional)</label>
            <select value={form.vendorId} onChange={e => setForm({...form, vendorId: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500">
              <option value="">-- No Vendor --</option>
              {vendors.map(v => <option key={v.id} value={v.id}>{v.name}</option>)}
            </select>
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">BIN LOCATION (optional)</label>
            <input type="text" value={form.binLocation} onChange={e => setForm({...form, binLocation: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" placeholder="e.g., Shelf A2, Bin 5" />
          </div>
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">NOTES</label>
            <textarea value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500 h-20" placeholder="Additional info..." />
          </div>
          <div className="flex gap-3 pt-4">
            <button type="button" onClick={onClose} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">CANCEL</button>
            <button type="submit" className="flex-1 bg-teal-600 hover:bg-teal-500 text-white px-4 py-3 font-black border-2 border-teal-700 flex items-center justify-center gap-2">
              <Icon name="save" size={16} /> SAVE
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// Scheduled Maintenance Tab - NEW IN SPRINT 3
const ScheduledMaintenanceTab = ({ tasks, machines, onAdd, onEdit, onComplete, onDelete, onAddBulk, onShowHistory }) => {
  const today = new Date();
  const [filter, setFilter] = useState('dueSoon'); // 'overdue', 'dueSoon', 'all'
  const [expandedBulk, setExpandedBulk] = useState({});
  
  // Filter tasks based on due date
  const getFilteredTasks = (tasksList) => {
    return tasksList.filter(t => {
      if (!t.active) return false;
      const dueDate = new Date(t.nextDue);
      const daysTilDue = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
      
      if (filter === 'overdue') return daysTilDue < 0;
      if (filter === 'dueSoon') return daysTilDue >= 0 && daysTilDue <= 14;
      return true; // 'all'
    });
  };
  
  // Split tasks by type
  const equipmentTasks = tasks.filter(t => t.type === 'Equipment' || (!t.type && t.machineId));
  const buildingTasks = tasks.filter(t => t.type === 'Building' || (!t.type && !t.machineId));
  const bulkTasks = tasks.filter(t => t.type === 'Bulk');
  
  const filteredEquipment = getFilteredTasks(equipmentTasks);
  const filteredBuilding = getFilteredTasks(buildingTasks);
  const filteredBulk = getFilteredTasks(bulkTasks);
  
  const toggleBulkExpand = (taskId) => {
    setExpandedBulk({ ...expandedBulk, [taskId]: !expandedBulk[taskId] });
  };
  
  const renderTask = (task, isBulk = false) => {
    const machine = machines.find(m => m.id === task.machineId);
    const dueDate = new Date(task.nextDue);
    const isOverdue = dueDate < today;
    const daysTilDue = Math.floor((dueDate - today) / (1000 * 60 * 60 * 24));
    
    if (isBulk) {
      // Render bulk parent task
      const completed = task.children?.filter(c => c.completed).length || 0;
      const total = task.children?.length || 0;
      const isExpanded = expandedBulk[task.id];
      
      console.log('Bulk task:', task.id, 'equipmentType:', task.equipmentType, 'Children:', task.children, 'isExpanded:', isExpanded); // DEBUG
      
      return (
        <div key={task.id} className={`bg-zinc-800 border-2 ${isOverdue ? 'border-red-600' : daysTilDue <= 14 ? 'border-yellow-600' : 'border-zinc-700'}`}>
          <div className="p-4">
            <div className="flex justify-between items-start mb-3">
              <div className="flex-1">
                <div className="flex items-center gap-2">
                  <button onClick={() => toggleBulkExpand(task.id)} className="text-teal-400 hover:text-teal-300">
                    <Icon name={isExpanded ? "chevron-down" : "chevron-right"} size={20} />
                  </button>
                  <div>
                    <h3 className="text-lg font-black text-white">
                      {task.task} {task.equipmentType ? `(All ${task.equipmentType}s)` : '(Bulk Task)'}
                    </h3>
                    <p className="text-xs text-zinc-400 font-bold">Progress: {completed}/{total} complete</p>
                  </div>
                </div>
              </div>
              <div className="flex gap-2">
                <button onClick={() => onEdit(task)} className="text-teal-400 hover:text-teal-300">
                  <Icon name="edit" size={16} />
                </button>
                <button onClick={() => onDelete(task.id)} className="text-red-400 hover:text-red-300">
                  <Icon name="trash" size={16} />
                </button>
              </div>
            </div>
            <div className="space-y-1 text-sm mb-3">
              <p className="text-zinc-400"><span className="font-bold">FREQUENCY:</span> {task.frequency}</p>
              <p className={`font-bold ${isOverdue ? 'text-red-400' : daysTilDue <= 14 ? 'text-yellow-400' : 'text-green-400'}`}>
                NEXT DUE: {task.nextDue} {isOverdue && '(OVERDUE!)'}
              </p>
            </div>
            {isExpanded && task.children && task.children.length > 0 ? (
              <div className="bg-zinc-900 border border-zinc-700 p-3 mb-3 space-y-2">
                {task.children.map(child => (
                  <div key={child.id} className="flex items-center justify-between bg-zinc-800 p-2 rounded">
                    <div className="flex items-center gap-3">
                      {child.completed ? (
                        <Icon name="check-circle" size={20} className="text-green-400" />
                      ) : (
                        <Icon name="circle" size={20} className="text-zinc-600" />
                      )}
                      <span className={`text-sm ${child.completed ? 'text-zinc-500 line-through' : 'text-white font-bold'}`}>
                        {child.machineName}
                      </span>
                    </div>
                    {child.completed ? (
                      <span className="text-xs text-zinc-500">{child.completedDate}</span>
                    ) : (
                      <button 
                        onClick={() => onComplete(task.id, child.id)} 
                        className="bg-teal-600 hover:bg-teal-500 text-white px-3 py-1 text-xs font-bold border border-teal-700"
                      >
                        COMPLETE
                      </button>
                    )}
                  </div>
                ))}
              </div>
            ) : (
              <div className="bg-zinc-900 border border-zinc-700 p-3 mb-3 text-zinc-500 text-sm">
                {!isExpanded && 'Click arrow to expand'}
                {isExpanded && (!task.children || task.children.length === 0) && 'No children found'}
              </div>
            )}
            <button 
              onClick={() => onComplete(task.id)} 
              className="w-full bg-teal-600 hover:bg-teal-500 text-white px-4 py-2 font-bold border-2 border-teal-700 flex items-center justify-center gap-2"
            >
              <Icon name="check" size={16} /> COMPLETE ALL ({total - completed} remaining)
            </button>
          </div>
        </div>
      );
    }
    
    // Regular task (Equipment or Building)
    return (
      <div key={task.id} className={`bg-zinc-800 border-2 p-4 ${isOverdue ? 'border-red-600' : daysTilDue <= 14 ? 'border-yellow-600' : 'border-zinc-700'}`}>
        <div className="flex justify-between mb-3">
          <div>
            <h3 className="text-lg font-black text-white">{task.task}</h3>
            <p className="text-xs text-zinc-400 font-bold">{machine?.name || task.location || 'Building-wide'}</p>
          </div>
          <div className="flex gap-2">
            <button onClick={() => onEdit(task)} className="text-teal-400 hover:text-teal-300">
              <Icon name="edit" size={16} />
            </button>
            <button onClick={() => onDelete(task.id)} className="text-red-400 hover:text-red-300">
              <Icon name="trash" size={16} />
            </button>
          </div>
        </div>
        <div className="space-y-1 text-sm mb-3">
          <p className="text-zinc-400"><span className="font-bold">FREQUENCY:</span> {task.frequency}</p>
          <p className="text-zinc-400"><span className="font-bold">LAST DONE:</span> {task.lastCompleted || 'Never'}</p>
          <p className={`font-bold ${isOverdue ? 'text-red-400' : daysTilDue <= 14 ? 'text-yellow-400' : 'text-green-400'}`}>
            NEXT DUE: {task.nextDue} {isOverdue && '(OVERDUE!)'}
          </p>
        </div>
        <button onClick={() => onComplete(task.id)} className="w-full bg-teal-600 hover:bg-teal-500 text-white px-4 py-2 font-bold border-2 border-teal-700 flex items-center justify-center gap-2">
          <Icon name="check" size={16} /> COMPLETE TASK
        </button>
      </div>
    );
  };
  
  const overdueCount = tasks.filter(t => {
    if (!t.active) return false;
    const daysTilDue = Math.floor((new Date(t.nextDue) - today) / (1000 * 60 * 60 * 24));
    return daysTilDue < 0;
  }).length;
  
  const dueSoonCount = tasks.filter(t => {
    if (!t.active) return false;
    const daysTilDue = Math.floor((new Date(t.nextDue) - today) / (1000 * 60 * 60 * 24));
    return daysTilDue >= 0 && daysTilDue <= 14;
  }).length;
  
  return (
    <div className="space-y-6">
      <div className="flex flex-col sm:flex-row justify-between mb-4 gap-4">
        <h2 className="text-2xl font-black text-teal-400 flex items-center gap-2">
          <Icon name="clock" size={24} /> SCHEDULED MAINTENANCE
        </h2>
        <div className="flex gap-2 flex-wrap">
          {/* <button onClick={onShowHistory} className="bg-zinc-800 hover:bg-zinc-700 border-2 border-yellow-600 text-yellow-400 px-4 py-2 font-bold flex items-center gap-2 text-sm">
            <Icon name="file" size={16} /> HISTORY
          </button> */}
          <button onClick={onAddBulk} className="bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-2 font-bold border-2 border-yellow-700 flex items-center gap-2 text-sm">
            <Icon name="layers" size={16} /> BULK SCHEDULE
          </button>
          <button onClick={onAdd} className="bg-teal-600 hover:bg-teal-500 text-white px-4 sm:px-6 py-2 font-black border-2 border-teal-700 flex items-center justify-center gap-2 text-sm sm:text-base">
            <Icon name="plus" /> ADD TASK
          </button>
        </div>
      </div>
      
      <div className="flex gap-2 flex-wrap">
        <button 
          onClick={() => setFilter('overdue')} 
          className={`px-4 py-2 font-bold border-2 flex items-center gap-2 ${filter === 'overdue' ? 'bg-red-600 border-red-700 text-white' : 'bg-zinc-800 border-red-600 text-red-400'}`}
        >
          OVERDUE ({overdueCount})
        </button>
        <button 
          onClick={() => setFilter('dueSoon')} 
          className={`px-4 py-2 font-bold border-2 flex items-center gap-2 ${filter === 'dueSoon' ? 'bg-yellow-600 border-yellow-700 text-white' : 'bg-zinc-800 border-yellow-600 text-yellow-400'}`}
        >
          DUE SOON ({dueSoonCount})
        </button>
        <button 
          onClick={() => setFilter('all')} 
          className={`px-4 py-2 font-bold border-2 flex items-center gap-2 ${filter === 'all' ? 'bg-teal-600 border-teal-700 text-white' : 'bg-zinc-800 border-teal-600 text-teal-400'}`}
        >
          ALL TASKS ({tasks.filter(t => t.active).length})
        </button>
      </div>
      
      {/* Equipment Maintenance Section */}
      {(filteredEquipment.length > 0 || filteredBulk.length > 0) && (
        <div>
          <h3 className="text-xl font-black text-white mb-3 flex items-center gap-2">
            <Icon name="wrench" size={20} /> EQUIPMENT MAINTENANCE
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            {filteredEquipment.map(task => renderTask(task))}
            {filteredBulk.map(task => renderTask(task, true))}
          </div>
        </div>
      )}
      
      {/* Building Maintenance Section */}
      {filteredBuilding.length > 0 && (
        <div>
          <h3 className="text-xl font-black text-white mb-3 flex items-center gap-2">
            <Icon name="home" size={20} /> BUILDING MAINTENANCE
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {filteredBuilding.map(task => renderTask(task))}
          </div>
        </div>
      )}
      
      {(filteredEquipment.length === 0 && filteredBuilding.length === 0 && filteredBulk.length === 0) && (
        <div className="text-center py-12 bg-zinc-800 border-2 border-zinc-700">
          <p className="text-zinc-500 font-bold">
            {filter === 'overdue' && 'NO OVERDUE TASKS'}
            {filter === 'dueSoon' && 'NO TASKS DUE SOON'}
            {filter === 'all' && 'NO SCHEDULED TASKS'}
          </p>
          <p className="text-zinc-600 text-sm mt-2">
            {filter !== 'all' && 'Try changing the filter to see more tasks'}
          </p>
        </div>
      )}
    </div>
  );
};

// Warranties Tab - NEW IN SPRINT 3
const WarrantiesTab = ({ warranties, machines, onAdd, onEdit, onDelete }) => {
  const today = new Date();
  const [filter, setFilter] = useState('active');
  
  const filtered = warranties.filter(w => {
    const endDate = new Date(w.endDate);
    if (filter === 'active') return endDate >= today;
    if (filter === 'expired') return endDate < today;
    if (filter === 'expiring') {
      const daysUntilExpiry = (endDate - today) / (1000 * 60 * 60 * 24);
      return daysUntilExpiry > 0 && daysUntilExpiry <= 30;
    }
    return true;
  });
  
  return (
    <div>
      <div className="flex justify-between mb-4 flex-wrap gap-4">
        <h2 className="text-2xl font-black text-teal-400 flex items-center gap-2">
          <Icon name="shield" size={24} /> WARRANTIES
        </h2>
        <div className="flex gap-3">
          <select value={filter} onChange={e => setFilter(e.target.value)} className="bg-zinc-800 border-2 border-zinc-700 text-white px-3 py-2 font-bold text-sm">
            <option value="all">All</option>
            <option value="active">Active</option>
            <option value="expiring">Expiring Soon</option>
            <option value="expired">Expired</option>
          </select>
          <button onClick={onAdd} className="bg-teal-600 hover:bg-teal-500 text-white px-4 sm:px-6 py-2 font-black border-2 border-teal-700 flex items-center justify-center gap-2 text-sm sm:text-base">
            <Icon name="plus" /> ADD WARRANTY
          </button>
        </div>
      </div>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {filtered.map(warranty => {
          const machine = machines.find(m => m.id === warranty.machineId);
          const endDate = new Date(warranty.endDate);
          const daysRemaining = Math.floor((endDate - today) / (1000 * 60 * 60 * 24));
          const isExpired = endDate < today;
          const isExpiring = daysRemaining > 0 && daysRemaining <= 30;
          
          return (
            <div key={warranty.id} className={`bg-zinc-800 border-2 p-4 ${isExpired ? 'border-zinc-600 opacity-60' : isExpiring ? 'border-yellow-600' : 'border-zinc-700'}`}>
              <div className="flex justify-between mb-3">
                <div>
                  <h3 className="text-lg font-black text-white">{machine?.name || 'Unknown Machine'}</h3>
                  <p className="text-xs text-zinc-400 font-bold">{warranty.provider}</p>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => onEdit(warranty)} className="text-teal-400 hover:text-teal-300">
                    <Icon name="edit" size={16} />
                  </button>
                  <button onClick={() => onDelete(warranty.id)} className="text-red-400 hover:text-red-300">
                    <Icon name="trash" size={16} />
                  </button>
                </div>
              </div>
              <div className="space-y-1 text-sm mb-3">
                <p className="text-zinc-400"><span className="font-bold">START:</span> {warranty.startDate}</p>
                <p className="text-zinc-400"><span className="font-bold">END:</span> {warranty.endDate}</p>
                {warranty.coverage && <p className="text-zinc-400"><span className="font-bold">COVERAGE:</span> {warranty.coverage}</p>}
                <p className={`font-bold ${isExpired ? 'text-red-400' : isExpiring ? 'text-yellow-400' : 'text-green-400'}`}>
                  {isExpired ? 'EXPIRED' : isExpiring ? `Expires in ${daysRemaining} days` : 'ACTIVE'}
                </p>
              </div>
            </div>
          );
        })}
      </div>
      {filtered.length === 0 && (
        <div className="text-center py-12 bg-zinc-800 border-2 border-zinc-700">
          <p className="text-zinc-500 font-bold">NO WARRANTIES FOUND</p>
        </div>
      )}
    </div>
  );
};

// Settings Tab - Sprint 4.1 Feature #3 & #4
const SettingsTab = ({ currentUser, userRole, backups, lastBackupTime, backupStatus, onBackupNow, onRestore, spreadsheetId, machines, equipmentLogs, buildingLogs, parts, partsUsage, scheduledTasks, warranties, year }) => {
  const [exportStatus, setExportStatus] = useState('');
  
  const formatBackupTime = (isoString) => {
    if (!isoString) return 'Never';
    const date = new Date(isoString);
    return date.toLocaleString('en-US', { 
      month: 'short', 
      day: 'numeric', 
      year: 'numeric', 
      hour: 'numeric', 
      minute: '2-digit',
      hour12: true 
    });
  };
  
  const exportToCSV = (data, filename) => {
    setExportStatus(`Exporting ${filename}...`);
    try {
      const csv = data.map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${filename}_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      setExportStatus(`Exported ${filename}!`);
      setTimeout(() => setExportStatus(''), 3000);
    } catch (err) {
      setExportStatus(`Export failed: ${err.message}`);
      setTimeout(() => setExportStatus(''), 3000);
    }
  };
  
  const exportEquipmentLogs = () => {
    const headers = ['Date', 'Machine', 'Issue', 'Technician', 'Cost', 'Hours', 'Parts Used', 'Notes'];
    const rows = equipmentLogs
      .filter(l => new Date(l.date).getFullYear() === year)
      .map(l => {
        const machine = machines.find(m => m.id === l.machineId);
        return [
          l.date,
          machine?.name || 'Unknown',
          l.issue,
          l.tech,
          l.cost,
          l.hours,
          l.partsUsed || 'None',
          l.notes || ''
        ];
      });
    exportToCSV([headers, ...rows], `Equipment_Repairs_${year}`);
  };
  
  const exportBuildingLogs = () => {
    const headers = ['Date', 'Category', 'Issue', 'Technician', 'Cost', 'Hours', 'Notes'];
    const rows = buildingLogs
      .filter(l => new Date(l.date).getFullYear() === year)
      .map(l => [
        l.date,
        l.category,
        l.issue,
        l.tech,
        l.cost,
        l.hours,
        l.notes || ''
      ]);
    exportToCSV([headers, ...rows], `Building_Maintenance_${year}`);
  };
  
  const exportPartsInventory = () => {
    const headers = ['Part Name', 'SKU', 'Stock', 'Min Stock', 'Cost', 'Bin Location', 'Status'];
    const rows = parts.map(p => [
      p.name,
      p.sku,
      p.stock,
      p.minStock,
      p.cost,
      p.binLocation || '',
      p.snoozed ? 'Ignored' : (parseInt(p.stock) === 0 ? 'Out of Stock' : parseInt(p.stock) <= parseInt(p.minStock) ? 'Low Stock' : 'OK')
    ]);
    exportToCSV([headers, ...rows], 'Parts_Inventory');
  };
  
  const exportMachineHistory = (machineId) => {
    const machine = machines.find(m => m.id === machineId);
    if (!machine) return;
    
    const headers = ['Date', 'Issue', 'Technician', 'Cost', 'Hours', 'Parts Used', 'Notes'];
    const rows = equipmentLogs
      .filter(l => l.machineId === machineId)
      .sort((a, b) => new Date(b.date) - new Date(a.date))
      .map(l => [
        l.date,
        l.issue,
        l.tech,
        l.cost,
        l.hours,
        l.partsUsed || 'None',
        l.notes || ''
      ]);
    exportToCSV([headers, ...rows], `${machine.name.replace(/[^a-z0-9]/gi, '_')}_History`);
  };
  
  const exportMonthlySummary = () => {
    const yearLogs = equipmentLogs.filter(l => new Date(l.date).getFullYear() === year);
    const yearBldg = buildingLogs.filter(l => new Date(l.date).getFullYear() === year);
    
    const headers = ['Month', 'Equipment Repairs', 'Equipment Cost', 'Building Repairs', 'Building Cost', 'Total Cost'];
    const rows = [];
    
    for (let month = 0; month < 12; month++) {
      const monthEq = yearLogs.filter(l => new Date(l.date).getMonth() === month);
      const monthBldg = yearBldg.filter(l => new Date(l.date).getMonth() === month);
      const eqCost = monthEq.reduce((sum, l) => sum + parseFloat(l.cost || 0), 0);
      const bldgCost = monthBldg.reduce((sum, l) => sum + parseFloat(l.cost || 0), 0);
      
      rows.push([
        new Date(year, month, 1).toLocaleString('en', { month: 'long' }),
        monthEq.length,
        eqCost.toFixed(2),
        monthBldg.length,
        bldgCost.toFixed(2),
        (eqCost + bldgCost).toFixed(2)
      ]);
    }
    
    exportToCSV([headers, ...rows], `Monthly_Summary_${year}`);
  };
  
  return (
    <div className="space-y-6">
      <div className="flex items-center gap-3 mb-6">
        <Icon name="settings" size={32} className="text-teal-400" />
        <h2 className="text-3xl font-black text-teal-400">SETTINGS</h2>
      </div>
      
      {/* Team Management & Request Settings */}
      <RequestSettingsSection currentUser={currentUser} userRole={userRole} />
      <TeamManagementSection currentUser={currentUser} userRole={userRole} />
      
      {/* Backup Section */}
      <div className="bg-zinc-800 border-2 border-yellow-600 p-6">
        <h3 className="text-xl font-black text-yellow-400 mb-4 flex items-center gap-2">
          <Icon name="database" size={24} />
          AUTOMATIC BACKUPS
        </h3>
        
        <div className="space-y-4">
          <div className="bg-zinc-900 p-4 border-2 border-zinc-700">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <div className="text-xs text-yellow-400 font-bold mb-1">LAST BACKUP</div>
                <div className="text-white font-bold">{formatBackupTime(lastBackupTime)}</div>
              </div>
              <div>
                <div className="text-xs text-yellow-400 font-bold mb-1">TOTAL BACKUPS</div>
                <div className="text-white font-bold">{backups.length} / 30 (last 30 days kept)</div>
              </div>
            </div>
            
            {backupStatus && (
              <div className="bg-teal-900 border-2 border-teal-600 px-4 py-2 text-white font-bold mb-4">
                {backupStatus}
              </div>
            )}
            
            <button 
              onClick={onBackupNow}
              className="bg-yellow-600 hover:bg-yellow-500 text-white px-6 py-3 font-black border-2 border-yellow-700 flex items-center gap-2"
            >
              <Icon name="save" size={18} />
              BACKUP NOW
            </button>
          </div>
          
          <div className="bg-zinc-900 p-4 border-2 border-zinc-700">
            <h4 className="text-md font-black text-yellow-400 mb-3">AVAILABLE BACKUPS</h4>
            
            {backups.length === 0 && (
              <p className="text-zinc-500 italic">No backups yet. Click "Backup Now" to create your first backup.</p>
            )}
            
            <div className="space-y-2 max-h-64 overflow-y-auto">
              {backups.map(backup => (
                <div key={backup.id} className="flex justify-between items-center bg-zinc-800 p-3 border border-zinc-700">
                  <div>
                    <div className="text-white font-bold">{backup.name}</div>
                    <div className="text-xs text-zinc-500">{formatBackupTime(backup.timestamp)}</div>
                  </div>
                  <button 
                    onClick={() => onRestore(backup.id, backup.name)}
                    className="bg-teal-600 hover:bg-teal-500 text-white px-4 py-2 text-sm font-black border-2 border-teal-700"
                  >
                    RESTORE
                  </button>
                </div>
              ))}
            </div>
          </div>
          
          <div className="bg-zinc-900 p-4 border-2 border-zinc-700">
            <p className="text-sm text-zinc-400 leading-relaxed">
              <strong className="text-yellow-400">Auto-Backup:</strong> A backup is automatically created every 24 hours when you open the app. 
              Backups are copies of your entire spreadsheet. The last 30 backups are kept automatically. 
              <br /><br />
              <strong className="text-yellow-400">Note:</strong> Backups include all spreadsheet data but do NOT include uploaded photos/PDFs. 
              Those are stored separately in Google Drive and are not affected by restore operations.
            </p>
          </div>
        </div>
      </div>
      
      {/* Export Section */}
      <div className="bg-zinc-800 border-2 border-teal-600 p-6">
        <h3 className="text-xl font-black text-teal-400 mb-4 flex items-center gap-2">
          <Icon name="download" size={24} />
          EXPORT DATA (CSV/EXCEL)
        </h3>
        
        {exportStatus && (
          <div className="bg-teal-900 border-2 border-teal-600 px-4 py-2 text-white font-bold mb-4">
            {exportStatus}
          </div>
        )}
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <button 
            onClick={exportEquipmentLogs}
            className="bg-teal-600 hover:bg-teal-500 text-white px-6 py-4 font-black border-2 border-teal-700 flex items-center justify-center gap-2"
          >
            <Icon name="wrench" size={18} />
            EXPORT EQUIPMENT REPAIRS ({year})
          </button>
          
          <button 
            onClick={exportBuildingLogs}
            className="bg-teal-600 hover:bg-teal-500 text-white px-6 py-4 font-black border-2 border-teal-700 flex items-center justify-center gap-2"
          >
            <Icon name="home" size={18} />
            EXPORT BUILDING MAINTENANCE ({year})
          </button>
          
          <button 
            onClick={exportPartsInventory}
            className="bg-teal-600 hover:bg-teal-500 text-white px-6 py-4 font-black border-2 border-teal-700 flex items-center justify-center gap-2"
          >
            <Icon name="package" size={18} />
            EXPORT PARTS INVENTORY
          </button>
          
          <button 
            onClick={exportMonthlySummary}
            className="bg-teal-600 hover:bg-teal-500 text-white px-6 py-4 font-black border-2 border-teal-700 flex items-center justify-center gap-2"
          >
            <Icon name="chart" size={18} />
            EXPORT MONTHLY SUMMARY ({year})
          </button>
        </div>
        
        <div className="mt-6 bg-zinc-900 p-4 border-2 border-zinc-700">
          <h4 className="text-md font-black text-teal-400 mb-3">EXPORT SPECIFIC MACHINE HISTORY</h4>
          <select 
            onChange={(e) => e.target.value && exportMachineHistory(e.target.value)}
            className="w-full bg-zinc-800 border-2 border-zinc-700 text-white px-3 py-2 font-bold"
          >
            <option value="">-- Select a machine --</option>
            {machines.filter(m => !m.archived).map(m => (
              <option key={m.id} value={m.id}>{m.name} ({m.model})</option>
            ))}
          </select>
          <p className="text-xs text-zinc-500 mt-2 italic">
            Select a machine to export its complete repair history
          </p>
        </div>
        
        <div className="mt-6 bg-zinc-900 p-4 border-2 border-zinc-700">
          <p className="text-sm text-zinc-400 leading-relaxed">
            <strong className="text-teal-400">CSV Format:</strong> Exports are compatible with Excel, Google Sheets, and QuickBooks. 
            Files are named with the current date for easy organization.
            <br /><br />
            <strong className="text-teal-400">For Tax Purposes:</strong> Export monthly summaries and individual repair logs. 
            Keep these files for your records and share with your accountant.
          </p>
        </div>
      </div>
      
      {/* Spreadsheet Info */}
      <div className="bg-zinc-800 border-2 border-zinc-600 p-6">
        <h3 className="text-xl font-black text-zinc-400 mb-4 flex items-center gap-2">
          <Icon name="info" size={24} />
          SYSTEM INFORMATION
        </h3>
        
        <div className="space-y-2 text-sm">
          <div className="flex justify-between">
            <span className="text-zinc-500">Spreadsheet ID:</span>
            <span className="text-white font-mono text-xs">{spreadsheetId}</span>
          </div>
          <div className="flex justify-between">
            <span className="text-zinc-500">Active Year:</span>
            <span className="text-white font-bold">{year}</span>
          </div>
          <div className="flex justify-between">
            <span className="text-zinc-500">Total Machines:</span>
            <span className="text-white font-bold">{machines.length}</span>
          </div>
          <div className="flex justify-between">
            <span className="text-zinc-500">Total Repairs ({year}):</span>
            <span className="text-white font-bold">{equipmentLogs.filter(l => new Date(l.date).getFullYear() === year).length}</span>
          </div>
          <div className="flex justify-between">
            <span className="text-zinc-500">Total Parts:</span>
            <span className="text-white font-bold">{parts.length}</span>
          </div>
        </div>
      </div>
    </div>
  );
};

// Repair Detail Modal - NEW IN SPRINT 3
const RepairDetailModal = ({ log, machines, parts, onClose, onEdit }) => {
  const [photoIndex, setPhotoIndex] = useState(0);
  const machine = machines.find(m => m.id === log.machineId);
  const usedParts = log.partsUsed ? log.partsUsed.split(',').filter(Boolean).map(p => {
    const [id, qty] = p.split(':');
    const part = parts.find(pt => pt.id === id);
    return { ...part, qty, subtotal: (parseFloat(part?.cost || 0) * parseFloat(qty)).toFixed(2) };
  }) : [];
  
  const fileIds = log.files ? log.files.split(',').filter(Boolean) : [];
  const photos = fileIds; // In production, would filter by type
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
      <div className="bg-zinc-800 border-4 border-teal-600 max-w-3xl w-full p-6 my-8">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-teal-400 flex items-center gap-2">
            REPAIR DETAILS
            {log.locked && <Icon name="lock" size={20} className="text-red-400" title="Locked" />}
            {log.warranty && <span className="px-2 py-1 bg-green-900 text-green-300 text-xs font-bold rounded">WARRANTY</span>}
          </h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        
        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="text-xs font-black text-teal-400">MACHINE</label>
              <p className="text-white font-bold">{machine?.name || 'Unknown'}</p>
            </div>
            <div>
              <label className="text-xs font-black text-teal-400">DATE</label>
              <p className="text-white font-bold">{formatDateSlash(log.date)}</p>
            </div>
          </div>
          
          <div>
            <label className="text-xs font-black text-teal-400">ISSUE</label>
            <p className="text-white">{log.issue}</p>
          </div>
          
          {log.notes && (
            <div>
              <label className="text-xs font-black text-teal-400">NOTES</label>
              <p className="text-white">{log.notes}</p>
            </div>
          )}
          
          <div className="grid grid-cols-3 gap-4">
            <div>
              <label className="text-xs font-black text-teal-400">TECHNICIAN</label>
              <p className="text-white">{log.tech}</p>
            </div>
            <div>
              <label className="text-xs font-black text-teal-400">LABOR HOURS</label>
              <p className="text-white">{log.hours}</p>
            </div>
            <div>
              <label className="text-xs font-black text-teal-400">TOTAL COST</label>
              <p className="text-teal-400 font-bold text-xl">${parseFloat(log.cost || 0).toFixed(2)}</p>
            </div>
          </div>
          
          {usedParts.length > 0 && (
            <div>
              <label className="text-xs font-black text-teal-400 mb-2 block">PARTS USED</label>
              <div className="bg-zinc-900 border border-zinc-700 p-3">
                {usedParts.map((p, i) => (
                  <div key={i} className="flex justify-between py-1">
                    <span className="text-white">{p.name} (x{p.qty})</span>
                    <span className="text-teal-400 font-bold">${p.subtotal}</span>
                  </div>
                ))}
              </div>
            </div>
          )}
          
          {photos.length > 0 && (
            <div>
              <label className="text-xs font-black text-teal-400 mb-2 block">PHOTOS ({photos.length})</label>
              <div className="bg-zinc-900 border border-zinc-700 p-4">
                <div className="flex items-center gap-4 mb-3">
                  <button onClick={() => setPhotoIndex(Math.max(0, photoIndex - 1))} disabled={photoIndex === 0} className="bg-zinc-700 hover:bg-zinc-600 disabled:opacity-30 px-3 py-2 font-bold">
                    PREV
                  </button>
                  <span className="text-white font-bold">Photo {photoIndex + 1} of {photos.length}</span>
                  <button onClick={() => setPhotoIndex(Math.min(photos.length - 1, photoIndex + 1))} disabled={photoIndex === photos.length - 1} className="bg-zinc-700 hover:bg-zinc-600 disabled:opacity-30 px-3 py-2 font-bold">
                    NEXT
                  </button>
                  <a href={`https://drive.google.com/file/d/${photos[photoIndex]}/view`} target="_blank" rel="noopener noreferrer" className="bg-teal-600 hover:bg-teal-500 text-white px-3 py-2 font-bold flex items-center gap-2">
                    <Icon name="file" size={16} /> OPEN IN NEW WINDOW
                  </a>
                </div>
                <div className="bg-black aspect-video flex items-center justify-center">
                  <img src={`https://drive.google.com/thumbnail?id=${photos[photoIndex]}&sz=w800`} className="max-w-full max-h-full" alt="Repair photo" />
                </div>
              </div>
            </div>
          )}
          
          <div className="flex flex-col sm:flex-row gap-3 pt-4">
            <button onClick={onClose} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">CLOSE</button>
            {!log.locked && (
              <>
                <button onClick={() => onEdit(log)} className="flex-1 bg-teal-600 hover:bg-teal-500 text-white px-4 py-3 font-black border-2 border-teal-700 flex items-center justify-center gap-2">
                  <Icon name="edit" size={16} /> EDIT
                </button>
                <button onClick={() => onEdit({ ...log, addParts: true })} className="flex-1 bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-3 font-black border-2 border-yellow-700 flex items-center justify-center gap-2">
                  <Icon name="plus" size={16} /> ADD PARTS
                </button>
              </>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

// Building Detail Modal - NEW IN SPRINT 3
// Scheduled Task Detail Modal
const ScheduledTaskDetailModal = ({ task, machines, onClose, onEdit }) => {
  const machine = machines.find(m => m.id === task.machineId);
  
  // Format frequency display
  let frequencyDisplay = task.frequency;
  if (task.frequency === 'Custom' && task.customValue && task.customUnit) {
    frequencyDisplay = `Every ${task.customValue} ${task.customUnit}`;
  }
  
  // Get equipment type display
  const equipmentDisplay = task.equipmentType 
    ? `All ${task.equipmentType}s` 
    : machine?.name || 'N/A';
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
      <div className="bg-zinc-800 border-4 border-green-600 max-w-3xl w-full p-6 my-8">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-green-400 flex items-center gap-2">
            <Icon name="clock" size={24} />
            SCHEDULED MAINTENANCE DETAILS
            {!task.active && <span className="px-2 py-1 bg-red-900 text-red-300 text-xs font-bold rounded">INACTIVE</span>}
          </h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        
        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="text-xs font-black text-green-400">EQUIPMENT</label>
              <p className="text-white font-bold">{equipmentDisplay}</p>
            </div>
            <div>
              <label className="text-xs font-black text-green-400">FREQUENCY</label>
              <p className="text-white font-bold">{frequencyDisplay}</p>
            </div>
          </div>
          
          <div>
            <label className="text-xs font-black text-green-400">TASK DESCRIPTION</label>
            <p className="text-white font-bold">{task.task}</p>
          </div>
          
          {task.notes && (
            <div>
              <label className="text-xs font-black text-green-400">NOTES</label>
              <p className="text-white">{task.notes}</p>
            </div>
          )}
          
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="text-xs font-black text-green-400">LAST COMPLETED</label>
              <p className="text-white">{task.lastCompleted ? formatDateSlash(task.lastCompleted) : 'Never'}</p>
            </div>
            <div>
              <label className="text-xs font-black text-green-400">NEXT DUE</label>
              <p className="text-white font-bold">{formatDateSlash(task.nextDue)}</p>
            </div>
          </div>
          
          {task.type && (
            <div>
              <label className="text-xs font-black text-green-400">TYPE</label>
              <p className="text-white">{task.type}</p>
            </div>
          )}
          
          {task.children && task.children.length > 0 && (
            <div>
              <label className="text-xs font-black text-green-400 mb-2 block">CHILD TASKS ({task.children.length})</label>
              <div className="bg-zinc-900 border border-zinc-700 p-3 space-y-2">
                {task.children.map((child, i) => {
                  const childMachine = machines.find(m => m.id === child.machineId);
                  return (
                    <div key={i} className="flex justify-between items-center">
                      <span className="text-white">{childMachine?.name || 'Unknown Machine'}</span>
                      <span className={`px-2 py-1 text-xs font-bold ${child.completed ? 'bg-green-900 text-green-400' : 'bg-zinc-800 text-zinc-400'}`}>
                        {child.completed ? 'COMPLETED' : 'PENDING'}
                      </span>
                    </div>
                  );
                })}
              </div>
            </div>
          )}
          
          <div className="flex gap-3 pt-4">
            <button onClick={onClose} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">CLOSE</button>
            {!task.locked && (
              <button onClick={() => onEdit(task)} className="flex-1 bg-green-600 hover:bg-green-500 text-white px-4 py-3 font-black border-2 border-green-700 flex items-center justify-center gap-2">
                <Icon name="edit" size={18} /> EDIT
              </button>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

const BuildingDetailModal = ({ log, onClose, onEdit }) => {
  const [photoIndex, setPhotoIndex] = useState(0);
  const fileIds = log.files ? log.files.split(',').filter(Boolean) : [];
  const photos = fileIds;
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
      <div className="bg-zinc-800 border-4 border-teal-600 max-w-3xl w-full p-6 my-8">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-teal-400 flex items-center gap-2">
            BUILDING MAINTENANCE DETAILS
            {log.locked && <Icon name="lock" size={20} className="text-red-400" title="Locked" />}
            {log.warranty && <span className="px-2 py-1 bg-green-900 text-green-300 text-xs font-bold rounded">WARRANTY</span>}
          </h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        
        <div className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="text-xs font-black text-teal-400">CATEGORY</label>
              <p className="text-white font-bold">{log.category}</p>
            </div>
            <div>
              <label className="text-xs font-black text-teal-400">DATE</label>
              <p className="text-white font-bold">{formatDateSlash(log.date)}</p>
            </div>
          </div>
          
          <div>
            <label className="text-xs font-black text-teal-400">ISSUE</label>
            <p className="text-white">{log.issue}</p>
          </div>
          
          {log.notes && (
            <div>
              <label className="text-xs font-black text-teal-400">NOTES</label>
              <p className="text-white">{log.notes}</p>
            </div>
          )}
          
          <div className="grid grid-cols-3 gap-4">
            <div>
              <label className="text-xs font-black text-teal-400">TECHNICIAN</label>
              <p className="text-white">{log.tech}</p>
            </div>
            <div>
              <label className="text-xs font-black text-teal-400">LABOR HOURS</label>
              <p className="text-white">{log.hours}</p>
            </div>
            <div>
              <label className="text-xs font-black text-teal-400">COST</label>
              <p className="text-teal-400 font-bold text-xl">${parseFloat(log.cost || 0).toFixed(2)}</p>
            </div>
          </div>
          
          {photos.length > 0 && (
            <div>
              <label className="text-xs font-black text-teal-400 mb-2 block">PHOTOS ({photos.length})</label>
              <div className="bg-zinc-900 border border-zinc-700 p-4">
                <div className="flex items-center gap-4 mb-3">
                  <button onClick={() => setPhotoIndex(Math.max(0, photoIndex - 1))} disabled={photoIndex === 0} className="bg-zinc-700 hover:bg-zinc-600 disabled:opacity-30 px-3 py-2 font-bold">
                    PREV
                  </button>
                  <span className="text-white font-bold">Photo {photoIndex + 1} of {photos.length}</span>
                  <button onClick={() => setPhotoIndex(Math.min(photos.length - 1, photoIndex + 1))} disabled={photoIndex === photos.length - 1} className="bg-zinc-700 hover:bg-zinc-600 disabled:opacity-30 px-3 py-2 font-bold">
                    NEXT
                  </button>
                  <a href={`https://drive.google.com/file/d/${photos[photoIndex]}/view`} target="_blank" rel="noopener noreferrer" className="bg-teal-600 hover:bg-teal-500 text-white px-3 py-2 font-bold flex items-center gap-2">
                    <Icon name="file" size={16} /> OPEN IN NEW WINDOW
                  </a>
                </div>
                <div className="bg-black aspect-video flex items-center justify-center">
                  <img src={`https://drive.google.com/thumbnail?id=${photos[photoIndex]}&sz=w800`} className="max-w-full max-h-full" alt="Building photo" />
                </div>
              </div>
            </div>
          )}
          
          <div className="flex gap-3 pt-4">
            <button onClick={onClose} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">CLOSE</button>
            {!log.locked && (
              <button onClick={() => onEdit(log)} className="flex-1 bg-teal-600 hover:bg-teal-500 text-white px-4 py-3 font-black border-2 border-teal-700 flex items-center justify-center gap-2">
                <Icon name="edit" size={16} /> EDIT
              </button>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};

// Edit Repair Modal - NEW IN SPRINT 3
const EditRepairModal = ({ log, machines, onClose, onSave, onAddParts }) => {
  const [form, setForm] = useState({
    date: log.date,
    issue: log.issue,
    tech: log.tech,
    hours: log.hours,
    cost: log.cost,
    notes: log.notes || ''
  });
  const [lockOnSave, setLockOnSave] = useState(false);
  
  const handleSubmit = (e) => {
    e.preventDefault();
    onSave({ ...form, locked: lockOnSave });
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
      <div className="bg-zinc-800 border-4 border-yellow-600 max-w-2xl w-full p-6 my-8">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-yellow-400">EDIT REPAIR LOG</h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        
        <div className="bg-yellow-900 border-2 border-yellow-600 p-3 mb-4 text-yellow-200 text-sm">
          <strong>NOTE:</strong> Parts used cannot be edited (inventory already deducted)
        </div>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">DATE</label>
            <input type="date" required value={form.date} onChange={e => setForm({...form, date: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
          </div>
          
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">ISSUE / REPAIR</label>
            <textarea required value={form.issue} onChange={e => setForm({...form, issue: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500 h-20" />
          </div>
          
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">NOTES</label>
            <textarea value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500 h-20" />
          </div>
          
          <div className="grid grid-cols-3 gap-4">
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">TECHNICIAN</label>
              <input type="text" required value={form.tech} onChange={e => setForm({...form, tech: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">HOURS</label>
              <input type="number" step="0.5" required value={form.hours} onChange={e => setForm({...form, hours: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">TOTAL COST</label>
              <input type="number" step="0.01" required value={form.cost} onChange={e => setForm({...form, cost: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
          </div>
          
          <div className="bg-zinc-900 border-2 border-zinc-700 p-4">
            <label className="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" checked={lockOnSave} onChange={e => setLockOnSave(e.target.checked)} className="w-5 h-5" />
              <div>
                <div className="text-white font-black">Lock this repair after saving</div>
                <div className="text-zinc-400 text-sm">Locked repairs cannot be edited again</div>
              </div>
            </label>
          </div>
          
          <div className="flex flex-col sm:flex-row gap-3 pt-4">
            <button type="button" onClick={onClose} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">CANCEL</button>
            {onAddParts && (
              <button type="button" onClick={onAddParts} className="flex-1 bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-3 font-black border-2 border-yellow-700 flex items-center justify-center gap-2">
                <Icon name="plus" size={16} /> ADD PARTS
              </button>
            )}
            <button type="submit" className="flex-1 bg-teal-600 hover:bg-teal-500 text-white px-4 py-3 font-black border-2 border-teal-700 flex items-center justify-center gap-2">
              <Icon name="save" size={16} /> {lockOnSave ? 'SAVE & LOCK' : 'SAVE'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// Edit Building Modal - NEW IN SPRINT 3
const EditBuildingModal = ({ log, onClose, onSave }) => {
  const [form, setForm] = useState({
    date: log.date,
    category: log.category,
    issue: log.issue,
    tech: log.tech,
    hours: log.hours,
    cost: log.cost,
    notes: log.notes || ''
  });
  const [lockOnSave, setLockOnSave] = useState(false);
  
  const handleSubmit = (e) => {
    e.preventDefault();
    onSave({ ...form, locked: lockOnSave });
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
      <div className="bg-zinc-800 border-4 border-yellow-600 max-w-2xl w-full p-6 my-8">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-yellow-400">EDIT BUILDING LOG</h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">CATEGORY</label>
              <select required value={form.category} onChange={e => setForm({...form, category: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500">
                <option>HVAC</option>
                <option>Plumbing</option>
                <option>Electrical</option>
                <option>Roof</option>
                <option>Flooring</option>
                <option>Walls/Paint</option>
                <option>Windows/Doors</option>
                <option>Parking Lot</option>
                <option>Landscaping</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">DATE</label>
              <input type="date" required value={form.date} onChange={e => setForm({...form, date: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
          </div>
          
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">ISSUE / REPAIR</label>
            <textarea required value={form.issue} onChange={e => setForm({...form, issue: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500 h-20" />
          </div>
          
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">NOTES</label>
            <textarea value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500 h-20" />
          </div>
          
          <div className="grid grid-cols-3 gap-4">
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">TECHNICIAN</label>
              <input type="text" required value={form.tech} onChange={e => setForm({...form, tech: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">HOURS</label>
              <input type="number" step="0.5" required value={form.hours} onChange={e => setForm({...form, hours: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">COST</label>
              <input type="number" step="0.01" required value={form.cost} onChange={e => setForm({...form, cost: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
          </div>
          
          <div className="bg-zinc-900 border-2 border-zinc-700 p-4">
            <label className="flex items-center gap-3 cursor-pointer">
              <input type="checkbox" checked={lockOnSave} onChange={e => setLockOnSave(e.target.checked)} className="w-5 h-5" />
              <div>
                <div className="text-white font-black">Lock this entry after saving</div>
                <div className="text-zinc-400 text-sm">Locked entries cannot be edited again</div>
              </div>
            </label>
          </div>
          
          <div className="flex gap-3 pt-4">
            <button type="button" onClick={onClose} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">CANCEL</button>
            <button type="submit" className="flex-1 bg-teal-600 hover:bg-teal-500 text-white px-4 py-3 font-black border-2 border-teal-700 flex items-center justify-center gap-2">
              <Icon name="save" size={16} /> {lockOnSave ? 'SAVE & LOCK' : 'SAVE'}
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// Scheduled Task Modal - UPDATED FOR SPRINT 3.1
const ScheduledTaskModal = ({ task, machines, onClose, onSave }) => {
  const [form, setForm] = useState(task || {
    type: 'Equipment',
    machineId: machines.filter(m => !m.archived)[0]?.id || '',
    location: '',
    task: '',
    frequency: 'Monthly',
    nextDue: getTodayLocal(),
    notes: ''
  });
  
  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(form);
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
      <div className="bg-zinc-800 border-4 border-teal-600 max-w-md w-full p-6">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-teal-400">{task ? 'EDIT' : 'ADD'} TASK</h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">TASK TYPE</label>
            <select 
              value={form.type || 'Equipment'} 
              onChange={e => setForm({...form, type: e.target.value})} 
              className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500"
            >
              <option value="Equipment">Equipment Maintenance</option>
              <option value="Building">Building Maintenance</option>
            </select>
          </div>
          
          {form.type === 'Equipment' ? (
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">MACHINE *</label>
              <select 
                required 
                value={form.machineId} 
                onChange={e => setForm({...form, machineId: e.target.value})} 
                className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500"
              >
                {machines.filter(m => !m.archived).map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
              </select>
            </div>
          ) : (
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">LOCATION/AREA</label>
              <input 
                type="text" 
                value={form.location || ''} 
                onChange={e => setForm({...form, location: e.target.value})} 
                className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" 
                placeholder="e.g., Roof, HVAC, Front Entrance"
              />
            </div>
          )}
          
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">TASK DESCRIPTION *</label>
            <input 
              type="text" 
              required 
              value={form.task} 
              onChange={e => setForm({...form, task: e.target.value})} 
              className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" 
              placeholder={form.type === 'Equipment' ? "e.g., Change filter" : "e.g., HVAC filter replacement"}
            />
          </div>
          
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">FREQUENCY *</label>
            <select 
              required 
              value={form.frequency || 'Monthly'} 
              onChange={e => setForm({...form, frequency: e.target.value})} 
              className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500"
            >
              <option>Weekly</option>
              <option>Monthly</option>
              <option>Quarterly</option>
              <option>Semi-Annual</option>
              <option>Annual</option>
              <option>Custom</option>
            </select>
          </div>
          
          {form.frequency === 'Custom' && (
            <div className="bg-zinc-900 border-2 border-zinc-700 p-3">
              <label className="block text-xs font-black text-teal-400 mb-2">CUSTOM FREQUENCY</label>
              <div className="flex gap-2">
                <input 
                  type="number" 
                  min="1"
                  value={form.customValue || ''}
                  onChange={e => setForm({...form, customValue: e.target.value})}
                  placeholder="Number"
                  className="flex-1 bg-zinc-800 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500"
                />
                <select
                  value={form.customUnit || 'days'}
                  onChange={e => setForm({...form, customUnit: e.target.value})}
                  className="bg-zinc-800 border-2 border-zinc-700 text-white px-3 py-2 font-bold"
                >
                  <option value="days">Days</option>
                  <option value="weeks">Weeks</option>
                </select>
              </div>
              <p className="text-xs text-zinc-500 mt-1">Example: 10 days or 3 weeks</p>
            </div>
          )}
          
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">NEXT DUE *</label>
            <input 
              type="date" 
              required 
              value={form.nextDue} 
              onChange={e => setForm({...form, nextDue: e.target.value})} 
              className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500"
            />
          </div>
          
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">NOTES</label>
            <textarea 
              value={form.notes || ''} 
              onChange={e => setForm({...form, notes: e.target.value})} 
              className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500 h-20"
            />
          </div>
          
          <div className="flex gap-3 pt-4">
            <button type="button" onClick={onClose} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">CANCEL</button>
            <button type="submit" className="flex-1 bg-teal-600 hover:bg-teal-500 text-white px-4 py-3 font-black border-2 border-teal-700 flex items-center justify-center gap-2">
              <Icon name="save" size={16} /> SAVE
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// Warranty Modal
const WarrantyModal = ({ warranty, machines, onClose, onSave }) => {
  const [form, setForm] = useState(warranty || {
    machineId: machines.filter(m => !m.archived)[0]?.id || '',
    startDate: getTodayLocal(),
    endDate: '',
    provider: '',
    coverage: '',
    notes: ''
  });
  
  const handleSubmit = (e) => {
    e.preventDefault();
    onSave(form);
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
      <div className="bg-zinc-800 border-4 border-teal-600 max-w-md w-full p-6">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-teal-400">{warranty ? 'EDIT' : 'ADD'} WARRANTY</h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">MACHINE</label>
            <select required value={form.machineId} onChange={e => setForm({...form, machineId: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500">
              {machines.filter(m => !m.archived).map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
            </select>
          </div>
          
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">PROVIDER</label>
            <input type="text" required value={form.provider} onChange={e => setForm({...form, provider: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" placeholder="e.g., Speed Queen" />
          </div>
          
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">START DATE</label>
              <input type="date" required value={form.startDate} onChange={e => setForm({...form, startDate: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">END DATE</label>
              <input type="date" required value={form.endDate} onChange={e => setForm({...form, endDate: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" />
            </div>
          </div>
          
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">COVERAGE</label>
            <input type="text" value={form.coverage} onChange={e => setForm({...form, coverage: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" placeholder="e.g., Parts & Labor" />
          </div>
          
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">NOTES</label>
            <textarea value={form.notes} onChange={e => setForm({...form, notes: e.target.value})} className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500 h-20" />
          </div>
          
          <div className="flex gap-3 pt-4">
            <button type="button" onClick={onClose} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">CANCEL</button>
            <button type="submit" className="flex-1 bg-teal-600 hover:bg-teal-500 text-white px-4 py-3 font-black border-2 border-teal-700 flex items-center justify-center gap-2">
              <Icon name="save" size={16} /> SAVE
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// Add Parts to Existing Repair Modal - NEW FEATURE
const AddPartsToRepairModal = ({ log, parts, partsUsage, onClose, onSave }) => {
  const [selectedParts, setSelectedParts] = useState([]);
  const [search, setSearch] = useState('');
  
  const availableParts = parts.filter(p => 
    p.name.toLowerCase().includes(search.toLowerCase()) || 
    p.sku.toLowerCase().includes(search.toLowerCase())
  );
  
  const addPart = (part) => {
    if (selectedParts.find(p => p.id === part.id)) {
      alert('Part already added');
      return;
    }
    setSelectedParts([...selectedParts, { ...part, qty: 1 }]);
  };
  
  const updateQty = (id, qty) => {
    setSelectedParts(selectedParts.map(p => p.id === id ? { ...p, qty: Math.max(1, parseInt(qty) || 1) } : p));
  };
  
  const removePart = (id) => {
    setSelectedParts(selectedParts.filter(p => p.id !== id));
  };
  
  const totalPartsCost = selectedParts.reduce((sum, p) => sum + (parseFloat(p.cost) * parseInt(p.qty)), 0);
  
  const handleSubmit = (e) => {
    e.preventDefault();
    if (selectedParts.length === 0) {
      alert('Please select at least one part');
      return;
    }
    onSave(log, selectedParts);
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
      <div className="bg-zinc-800 border-4 border-yellow-600 max-w-2xl w-full p-6 my-8">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-yellow-400">ADD PARTS TO REPAIR</h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        
        <div className="bg-yellow-900 border-2 border-yellow-600 p-3 mb-4 text-yellow-200 text-sm">
          <strong>Adding parts to existing repair:</strong> This will add parts to the repair and deduct them from inventory. The repair's total cost will be updated.
        </div>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">SEARCH PARTS</label>
            <input 
              type="text" 
              value={search} 
              onChange={e => setSearch(e.target.value)} 
              placeholder="Search by name or SKU..."
              className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500" 
            />
          </div>
          
          <div className="bg-zinc-900 border-2 border-zinc-700 max-h-40 overflow-y-auto">
            {availableParts.map(part => (
              <div key={part.id} onClick={() => addPart(part)} className="px-3 py-2 hover:bg-zinc-700 cursor-pointer border-b border-zinc-800 flex justify-between">
                <div>
                  <span className="text-white font-bold">{part.name}</span>
                  <span className="text-zinc-400 text-sm ml-2">({part.sku})</span>
                </div>
                <span className="text-teal-400 font-bold">${parseFloat(part.cost).toFixed(2)}</span>
              </div>
            ))}
            {availableParts.length === 0 && (
              <div className="px-3 py-4 text-center text-zinc-500">No parts found</div>
            )}
          </div>
          
          {selectedParts.length > 0 && (
            <div>
              <label className="block text-xs font-black text-teal-400 mb-2">SELECTED PARTS</label>
              <div className="bg-zinc-900 border-2 border-zinc-700 p-3 space-y-2">
                {selectedParts.map(part => (
                  <div key={part.id} className="flex items-center gap-3 bg-zinc-800 p-2 rounded">
                    <div className="flex-1">
                      <div className="text-white font-bold">{part.name}</div>
                      <div className="text-xs text-zinc-400">Stock: {part.stock} | ${parseFloat(part.cost).toFixed(2)} each</div>
                    </div>
                    <input 
                      type="number" 
                      min="1" 
                      max={part.stock}
                      value={part.qty} 
                      onChange={e => updateQty(part.id, e.target.value)}
                      className="w-16 bg-zinc-700 border border-zinc-600 text-white px-2 py-1 text-center font-bold"
                    />
                    <div className="text-teal-400 font-bold w-20 text-right">${(parseFloat(part.cost) * parseInt(part.qty)).toFixed(2)}</div>
                    <button type="button" onClick={() => removePart(part.id)} className="text-red-400 hover:text-red-300">
                      <Icon name="x" size={20} />
                    </button>
                  </div>
                ))}
                <div className="flex justify-between pt-2 border-t-2 border-zinc-700">
                  <span className="text-white font-black">TOTAL PARTS COST:</span>
                  <span className="text-teal-400 font-black text-xl">${totalPartsCost.toFixed(2)}</span>
                </div>
              </div>
            </div>
          )}
          
          <div className="flex flex-col sm:flex-row gap-3 pt-4">
            <button type="button" onClick={onClose} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">CANCEL</button>
            <button type="submit" disabled={selectedParts.length === 0} className="flex-1 bg-yellow-600 hover:bg-yellow-500 disabled:bg-zinc-700 disabled:border-zinc-600 text-white px-4 py-3 font-black border-2 border-yellow-700 flex items-center justify-center gap-2">
              <Icon name="plus" size={16} /> ADD PARTS TO REPAIR
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// Maintenance History Modal - NEW IN SPRINT 3.1
const MaintenanceHistoryModal = ({ history, onClose, onExport }) => {
  const [search, setSearch] = useState('');
  const [dateRange, setDateRange] = useState('30'); // days
  
  const filtered = history.filter(h => {
    const matchesSearch = !search || 
      h.taskName?.toLowerCase().includes(search.toLowerCase()) ||
      h.machineName?.toLowerCase().includes(search.toLowerCase());
    
    if (!matchesSearch) return false;
    
    const daysAgo = (new Date() - new Date(h.completedDate)) / (1000 * 60 * 60 * 24);
    if (dateRange === 'all') return true;
    return daysAgo <= parseInt(dateRange);
  });
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
      <div className="bg-zinc-800 border-4 border-teal-600 max-w-4xl w-full p-6 my-8">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-teal-400">MAINTENANCE HISTORY</h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        
        <div className="flex gap-4 mb-4 flex-wrap">
          <div className="flex-1 min-w-[200px]">
            <input 
              type="text" 
              value={search} 
              onChange={e => setSearch(e.target.value)} 
              placeholder="Search task or machine..."
              className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500"
            />
          </div>
          <select 
            value={dateRange} 
            onChange={e => setDateRange(e.target.value)} 
            className="bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold"
          >
            <option value="7">Last 7 days</option>
            <option value="30">Last 30 days</option>
            <option value="90">Last 90 days</option>
            <option value="365">Last year</option>
            <option value="all">All time</option>
          </select>
        </div>
        
        <div className="bg-zinc-900 border-2 border-zinc-700 max-h-96 overflow-y-auto">
          <table className="w-full">
            <thead className="bg-zinc-800 sticky top-0">
              <tr>
                <th className="px-4 py-3 text-left text-teal-400 font-black text-sm">DATE</th>
                <th className="px-4 py-3 text-left text-teal-400 font-black text-sm">TASK</th>
                <th className="px-4 py-3 text-left text-teal-400 font-black text-sm">MACHINE/LOCATION</th>
                <th className="px-4 py-3 text-center text-teal-400 font-black text-sm">TYPE</th>
              </tr>
            </thead>
            <tbody>
              {filtered.sort((a, b) => new Date(b.completedDate) - new Date(a.completedDate)).map((h, idx) => (
                <tr key={idx} className="border-b border-zinc-800 hover:bg-zinc-800">
                  <td className="px-4 py-3 text-white font-bold">{h.completedDate}</td>
                  <td className="px-4 py-3 text-zinc-300">{h.taskName}</td>
                  <td className="px-4 py-3 text-zinc-300">{h.machineName || h.location || 'Building-wide'}</td>
                  <td className="px-4 py-3 text-center">
                    <span className={`px-2 py-1 text-xs font-bold rounded ${h.type === 'Equipment' ? 'bg-teal-900 text-teal-300' : 'bg-orange-900 text-orange-300'}`}>
                      {h.type || 'Equipment'}
                    </span>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          {filtered.length === 0 && (
            <div className="text-center py-8 text-zinc-500 font-bold">NO HISTORY FOUND</div>
          )}
        </div>
        
        <div className="flex gap-3 pt-4">
          <button onClick={onClose} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">
            CLOSE
          </button>
          <button onClick={onExport} className="flex-1 bg-teal-600 hover:bg-teal-500 text-white px-4 py-3 font-black border-2 border-teal-700 flex items-center justify-center gap-2">
            <Icon name="download" size={16} /> EXPORT CSV
          </button>
        </div>
      </div>
    </div>
  );
};

// Bulk Schedule Modal - NEW IN SPRINT 3.1
const BulkScheduleModal = ({ machines, onClose, onSave }) => {
  const [form, setForm] = useState({
    task: '',
    equipmentType: 'Washer',
    frequency: 'Monthly',
    nextDue: getTodayLocal()
  });
  
  const types = [...new Set(machines.filter(m => !m.archived).map(m => m.type))];
  const selectedMachines = machines.filter(m => !m.archived && m.type === form.equipmentType);
  
  const handleSubmit = (e) => {
    e.preventDefault();
    if (!form.task) {
      alert('Please enter a task name');
      return;
    }
    if (selectedMachines.length === 0) {
      alert('No machines found for selected equipment type');
      return;
    }
    onSave(form, selectedMachines);
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
      <div className="bg-zinc-800 border-4 border-yellow-600 max-w-2xl w-full p-6 my-8">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-yellow-400">BULK SCHEDULE BY EQUIPMENT TYPE</h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        
        <div className="bg-yellow-900 border-2 border-yellow-600 p-3 mb-4 text-yellow-200 text-sm">
          <strong>Bulk Scheduling:</strong> This will create one task for each {form.equipmentType} ({selectedMachines.length} machines). 
          You can then complete them individually as you work through each machine.
        </div>
        
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">TASK NAME *</label>
            <input 
              type="text" 
              required
              value={form.task} 
              onChange={e => setForm({...form, task: e.target.value})} 
              placeholder="e.g., Burner Cleaning, Filter Replacement"
              className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500"
            />
          </div>
          
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">EQUIPMENT TYPE *</label>
            <select 
              required
              value={form.equipmentType} 
              onChange={e => setForm({...form, equipmentType: e.target.value})} 
              className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold"
            >
              {types.map(type => (
                <option key={type} value={type}>{type}</option>
              ))}
            </select>
            <p className="text-xs text-zinc-400 mt-1">{selectedMachines.length} {form.equipmentType}(s) found</p>
          </div>
          
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">FREQUENCY *</label>
            <select 
              required
              value={form.frequency} 
              onChange={e => setForm({...form, frequency: e.target.value})} 
              className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold"
            >
              <option value="Weekly">Weekly</option>
              <option value="Monthly">Monthly</option>
              <option value="Quarterly">Quarterly</option>
              <option value="Semi-Annual">Semi-Annual</option>
              <option value="Annual">Annual</option>
              <option value="Custom">Custom</option>
            </select>
          </div>
          
          {form.frequency === 'Custom' && (
            <div className="bg-zinc-900 border-2 border-zinc-700 p-3">
              <label className="block text-xs font-black text-teal-400 mb-2">CUSTOM FREQUENCY</label>
              <div className="flex gap-2">
                <input 
                  type="number" 
                  min="1"
                  value={form.customValue || ''}
                  onChange={e => setForm({...form, customValue: e.target.value})}
                  placeholder="Number"
                  className="flex-1 bg-zinc-800 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500"
                />
                <select
                  value={form.customUnit || 'days'}
                  onChange={e => setForm({...form, customUnit: e.target.value})}
                  className="bg-zinc-800 border-2 border-zinc-700 text-white px-3 py-2 font-bold"
                >
                  <option value="days">Days</option>
                  <option value="weeks">Weeks</option>
                </select>
              </div>
              <p className="text-xs text-zinc-500 mt-1">Example: 10 days or 3 weeks</p>
            </div>
          )}
          
          <div>
            <label className="block text-xs font-black text-teal-400 mb-2">NEXT DUE DATE *</label>
            <input 
              type="date" 
              required
              value={form.nextDue} 
              onChange={e => setForm({...form, nextDue: e.target.value})} 
              className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 font-bold outline-none focus:border-teal-500"
            />
          </div>
          
          <div className="bg-zinc-900 border-2 border-zinc-700 p-3">
            <p className="text-white font-bold mb-2">Preview: Machines to be scheduled</p>
            <div className="max-h-32 overflow-y-auto space-y-1">
              {selectedMachines.map(m => (
                <div key={m.id} className="text-sm text-zinc-400">‚Ä¢ {m.name}</div>
              ))}
            </div>
          </div>
          
          <div className="flex flex-col sm:flex-row gap-3 pt-4">
            <button type="button" onClick={onClose} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">
              CANCEL
            </button>
            <button type="submit" className="flex-1 bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-3 font-black border-2 border-yellow-700 flex items-center justify-center gap-2">
              <Icon name="layers" size={16} /> CREATE {selectedMachines.length} TASKS
            </button>
          </div>
        </form>
      </div>
    </div>
  );
};

// Import Receipt Modal - PDF IMPORT FEATURE
const ImportReceiptModal = ({ parts, vendors, onClose, onImport }) => {
  const [step, setStep] = useState('upload'); // upload, review
  const [pdfFile, setPdfFile] = useState(null);
  const [extractedItems, setExtractedItems] = useState([]);
  const [processing, setProcessing] = useState(false);
  
  const handleFileUpload = async (e) => {
    const file = e.target.files[0];
    if (!file || file.type !== 'application/pdf') {
      alert('Please upload a PDF file');
      return;
    }
    
    setPdfFile(file);
    setProcessing(true);
    
    try {
      // Read PDF using PDF.js
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      
      let fullText = '';
      
      // Extract text from all pages with proper line breaks
      for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
        const page = await pdf.getPage(pageNum);
        const textContent = await page.getTextContent();
        
        // Group text items by Y coordinate to preserve lines
        const lines = {};
        textContent.items.forEach(item => {
          const y = Math.round(item.transform[5]); // Y coordinate
          if (!lines[y]) lines[y] = [];
          lines[y].push(item.str);
        });
        
        // Sort by Y coordinate (top to bottom) and join
        const sortedY = Object.keys(lines).sort((a, b) => b - a); // Higher Y = top of page
        const pageText = sortedY.map(y => lines[y].join(' ')).join('\n');
        
        fullText += pageText + '\n\n';
      }
      
      console.log('Extracted PDF text:', fullText); // DEBUG
      
      // Parse receipt
      const items = parseReceiptText(fullText);
      
      console.log('Parsed items:', items); // DEBUG
      
      if (items.length === 0) {
        // Show more helpful error with text preview
        const preview = fullText.substring(0, 500);
        alert('No items found in PDF. Please check the file format.\n\nExtracted text preview:\n' + preview);
        setProcessing(false);
        return;
      }
      
      // Match to existing parts
      const matched = items.map(item => {
        let bestMatch = null;
        let bestScore = 0;
        
        // Try to match by SKU first
        const skuMatch = parts.find(p => p.sku === item.sku);
        if (skuMatch) {
          return { ...item, matchedPart: skuMatch, matchType: 'sku', action: 'update' };
        }
        
        // Try fuzzy name matching
        parts.forEach(p => {
          const score = fuzzyMatch(item.name, p.name);
          if (score > bestScore && score > 60) {
            bestScore = score;
            bestMatch = p;
          }
        });
        
        if (bestMatch) {
          return { ...item, matchedPart: bestMatch, matchType: 'name', matchScore: bestScore, action: 'update' };
        }
        
        return { ...item, matchedPart: null, action: 'new' };
      });
      
      setExtractedItems(matched);
      setStep('review');
      setProcessing(false);
    } catch (err) {
      alert('Error reading PDF: ' + err.message);
      console.error('PDF error:', err);
      setProcessing(false);
    }
  };
  
  const updateItem = (index, field, value) => {
    setExtractedItems(extractedItems.map((item, i) => 
      i === index ? { ...item, [field]: value } : item
    ));
  };
  
  const toggleItem = (index) => {
    setExtractedItems(extractedItems.map((item, i) => 
      i === index ? { ...item, selected: !item.selected } : item
    ));
  };
  
  const handleImport = () => {
    const selected = extractedItems.filter(item => item.selected !== false);
    if (selected.length === 0) {
      alert('Please select at least one item to import');
      return;
    }
    onImport(selected, pdfFile); // Pass PDF file for archiving
  };
  
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 overflow-y-auto">
      <div className="bg-zinc-800 border-4 border-yellow-600 max-w-5xl w-full p-6 my-8">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-yellow-400">IMPORT FROM RECEIPT (PDF)</h3>
          <button onClick={onClose} className="text-zinc-400 hover:text-white">
            <Icon name="x" size={24} />
          </button>
        </div>
        
        {step === 'upload' && (
          <div className="space-y-4">
            <div className="bg-zinc-900 border-2 border-zinc-700 p-6 text-center">
              <Icon name="file" size={48} className="mx-auto mb-4 text-yellow-400" />
              <p className="text-white font-bold mb-4">Upload your PDF receipt</p>
              <p className="text-zinc-400 text-sm mb-6">Supported: Laundry Owners Warehouse, Gold Coin, and similar receipt formats</p>
              <input 
                type="file" 
                accept=".pdf" 
                onChange={handleFileUpload} 
                className="hidden" 
                id="pdf-upload"
                disabled={processing}
              />
              <label 
                htmlFor="pdf-upload" 
                className="inline-block bg-yellow-600 hover:bg-yellow-500 text-white px-8 py-4 font-black border-2 border-yellow-700 cursor-pointer"
              >
                {processing ? 'PROCESSING...' : 'CHOOSE PDF FILE'}
              </label>
            </div>
            
            <div className="bg-yellow-900 border-2 border-yellow-600 p-4 text-yellow-200 text-sm">
              <strong>How it works:</strong>
              <ol className="list-decimal ml-6 mt-2 space-y-1">
                <li>Upload your PDF receipt</li>
                <li>System extracts SKU, name, quantity, price</li>
                <li>Review and match to existing parts</li>
                <li>Bulk import updates inventory</li>
              </ol>
            </div>
          </div>
        )}
        
        {step === 'review' && (
          <div className="space-y-4">
            <div className="bg-zinc-900 border-2 border-zinc-700 p-4">
              <p className="text-white font-bold">Found {extractedItems.length} items in receipt</p>
              <p className="text-zinc-400 text-sm">Review and select items to import</p>
            </div>
            
            <div className="bg-zinc-900 border-2 border-zinc-700 max-h-96 overflow-y-auto">
              <table className="w-full">
                <thead className="bg-zinc-800 sticky top-0">
                  <tr>
                    <th className="px-3 py-2 text-left text-teal-400 font-black text-xs">‚úì</th>
                    <th className="px-3 py-2 text-left text-teal-400 font-black text-xs">SKU</th>
                    <th className="px-3 py-2 text-left text-teal-400 font-black text-xs">NAME</th>
                    <th className="px-3 py-2 text-center text-teal-400 font-black text-xs">QTY</th>
                    <th className="px-3 py-2 text-right text-teal-400 font-black text-xs">PRICE</th>
                    <th className="px-3 py-2 text-left text-teal-400 font-black text-xs">ACTION</th>
                    <th className="px-3 py-2 text-left text-teal-400 font-black text-xs">MATCH</th>
                  </tr>
                </thead>
                <tbody>
                  {extractedItems.map((item, index) => (
                    <tr key={index} className="border-b border-zinc-800">
                      <td className="px-3 py-2">
                        <input 
                          type="checkbox" 
                          checked={item.selected !== false} 
                          onChange={() => toggleItem(index)}
                          className="w-4 h-4"
                        />
                      </td>
                      <td className="px-3 py-2">
                        <input 
                          type="text" 
                          value={item.sku} 
                          onChange={(e) => updateItem(index, 'sku', e.target.value)}
                          className="bg-zinc-700 border border-zinc-600 text-white px-2 py-1 text-sm w-full"
                        />
                      </td>
                      <td className="px-3 py-2">
                        <input 
                          type="text" 
                          value={item.name} 
                          onChange={(e) => updateItem(index, 'name', e.target.value)}
                          className="bg-zinc-700 border border-zinc-600 text-white px-2 py-1 text-sm w-full"
                        />
                      </td>
                      <td className="px-3 py-2 text-center">
                        <input 
                          type="number" 
                          value={item.qty} 
                          onChange={(e) => updateItem(index, 'qty', parseInt(e.target.value) || 1)}
                          className="bg-zinc-700 border border-zinc-600 text-white px-2 py-1 text-sm w-16 text-center"
                        />
                      </td>
                      <td className="px-3 py-2 text-right">
                        <input 
                          type="number" 
                          step="0.01"
                          value={item.price} 
                          onChange={(e) => updateItem(index, 'price', parseFloat(e.target.value) || 0)}
                          className="bg-zinc-700 border border-zinc-600 text-white px-2 py-1 text-sm w-20 text-right"
                        />
                      </td>
                      <td className="px-3 py-2">
                        <select 
                          value={item.action}
                          onChange={(e) => updateItem(index, 'action', e.target.value)}
                          className="bg-zinc-700 border border-zinc-600 text-white px-2 py-1 text-sm"
                        >
                          <option value="update">Add Stock</option>
                          <option value="new">Create New</option>
                          <option value="skip">Skip</option>
                        </select>
                      </td>
                      <td className="px-3 py-2 text-xs">
                        {item.matchedPart ? (
                          <span className={`${item.matchType === 'sku' ? 'text-green-400' : 'text-yellow-400'}`}>
                            {item.matchedPart.name} ({item.matchType === 'sku' ? 'SKU Match' : `${item.matchScore}% match`})
                          </span>
                        ) : (
                          <span className="text-zinc-500">No match</span>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            
            <div className="flex flex-col sm:flex-row gap-3 pt-4">
              <button onClick={() => setStep('upload')} className="flex-1 bg-zinc-700 hover:bg-zinc-600 text-white px-4 py-3 font-black border-2 border-zinc-600">
                ‚Üê BACK
              </button>
              <button onClick={handleImport} className="flex-2 bg-yellow-600 hover:bg-yellow-500 text-white px-4 py-3 font-black border-2 border-yellow-700 flex items-center justify-center gap-2">
                <Icon name="download" size={16} /> IMPORT {extractedItems.filter(i => i.selected !== false).length} ITEMS
              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

// Render the app
ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
