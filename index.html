<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Laundromat Maintenance Log - Enhanced</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
const { useState, useEffect, useRef } = React;

// ========== PASTE YOUR CREDENTIALS HERE ==========
const CLIENT_ID = '591405706276-krboirruc2l2kest5eegk61ljt1gjnam.apps.googleusercontent.com';  // Should look like: 123456789-abc123.apps.googleusercontent.com
const API_KEY = 'AIzaSyB2hlF42e4PTsRk1f8egPUcL4MGwYSZgxs';      // Should look like: AIzaSyD...
// ==================================================

const DISCOVERY_DOCS = [
  'https://sheets.googleapis.com/$discovery/rest?version=v4',
  'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
];
const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file';

// Icons
const Icon = ({ d, size = 24 }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <path d={d} />
  </svg>
);

const App = () => {
  const [isSignedIn, setIsSignedIn] = useState(false);
  const [isInitializing, setIsInitializing] = useState(true);
  const [spreadsheetId, setSpreadsheetId] = useState(null);
  const [machines, setMachines] = useState([]);
  const [logs, setLogs] = useState([]);
  const [year, setYear] = useState(new Date().getFullYear());
  const [activeTab, setActiveTab] = useState('equipment');
  const [showSettings, setShowSettings] = useState(false);
  const [showAddMachine, setShowAddMachine] = useState(false);
  const [showAddLog, setShowAddLog] = useState(false);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);

  useEffect(() => {
    const script = document.createElement('script');
    script.src = 'https://apis.google.com/js/api.js';
    script.onload = () => window.gapi.load('client', initGapi);
    document.body.appendChild(script);

    const gisScript = document.createElement('script');
    gisScript.src = 'https://accounts.google.com/gsi/client';
    gisScript.onload = () => {
      window.tokenClient = window.google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (response) => {
          if (!response.error) {
            setIsSignedIn(true);
            loadOrCreateSheet();
          }
        },
      });
    };
    document.body.appendChild(gisScript);
  }, []);

  const initGapi = async () => {
    await window.gapi.client.init({
      apiKey: API_KEY,
      discoveryDocs: DISCOVERY_DOCS,
    });
    setIsInitializing(false);
  };

  const loadOrCreateSheet = async () => {
    const id = localStorage.getItem('laundromat_spreadsheet_id');
    if (id) {
      setSpreadsheetId(id);
      await loadData(id);
    } else {
      await createSheet();
    }
  };

  const createSheet = async () => {
    const response = await window.gapi.client.sheets.spreadsheets.create({
      resource: {
        properties: { title: 'Laundromat Maintenance Log' },
        sheets: [
          { properties: { title: 'Machines' } },
          { properties: { title: 'Logs' } },
        ],
      },
    });
    const id = response.result.spreadsheetId;
    localStorage.setItem('laundromat_spreadsheet_id', id);
    setSpreadsheetId(id);
    
    await window.gapi.client.sheets.spreadsheets.values.batchUpdate({
      spreadsheetId: id,
      resource: {
        valueInputOption: 'RAW',
        data: [
          { range: 'Machines!A1:E1', values: [['ID', 'Name', 'Model', 'Serial', 'Type']] },
          { range: 'Logs!A1:H1', values: [['ID', 'MachineID', 'Date', 'Issue', 'Tech', 'Cost', 'Hours', 'Photos']] },
        ],
      },
    });
  };

  const loadData = async (id) => {
    const response = await window.gapi.client.sheets.spreadsheets.values.batchGet({
      spreadsheetId: id,
      ranges: ['Machines!A2:E', 'Logs!A2:H'],
    });
    
    const machineData = response.result.valueRanges[0].values || [];
    const logData = response.result.valueRanges[1].values || [];
    
    setMachines(machineData.map(r => ({ id: r[0], name: r[1], model: r[2], serial: r[3], type: r[4] })));
    setLogs(logData.map(r => ({ id: r[0], machineId: r[1], date: r[2], issue: r[3], tech: r[4], cost: r[5], hours: r[6], photos: r[7] })));
  };

  if (isInitializing) {
    return <div className="min-h-screen bg-zinc-900 flex items-center justify-center text-orange-400 text-xl font-bold">INITIALIZING...</div>;
  }

  if (!isSignedIn) {
    return (
      <div className="min-h-screen bg-zinc-900 flex items-center justify-center p-4">
        <div className="bg-zinc-800 border-4 border-orange-600 p-8 max-w-md">
          <h1 className="text-4xl font-black text-orange-400 mb-6">LAUNDROMAT</h1>
          <button onClick={() => window.tokenClient.requestAccessToken()} className="w-full bg-orange-600 text-white px-6 py-4 font-black">
            SIGN IN WITH GOOGLE
          </button>
        </div>
      </div>
    );
  }

  const yearTotal = logs.filter(l => new Date(l.date).getFullYear() === year).reduce((s, l) => s + parseFloat(l.cost || 0), 0);

  return (
    <div className="min-h-screen bg-zinc-900 text-white">
      <header className="bg-gradient-to-r from-orange-600 to-orange-500 border-b-4 border-orange-700 p-6">
        <div className="max-w-7xl mx-auto flex justify-between items-center">
          <div>
            <h1 className="text-5xl font-black text-white">LAUNDROMAT</h1>
            <p className="text-orange-100 text-sm font-bold">MAINTENANCE SYSTEM</p>
          </div>
          <div className="flex gap-4 items-center">
            <button onClick={() => setShowSettings(true)} className="bg-zinc-800 border-2 border-orange-500 text-orange-400 px-4 py-2 font-bold">
              SETTINGS
            </button>
            <select value={year} onChange={e => setYear(+e.target.value)} className="bg-zinc-800 border-2 border-orange-500 text-orange-400 px-4 py-2 font-bold">
              {[...new Set(logs.map(l => new Date(l.date).getFullYear()))].sort((a,b) => b-a).map(y => <option key={y}>{y}</option>)}
            </select>
            <div className="bg-zinc-800 border-2 border-orange-500 px-6 py-3">
              <div className="text-xs text-orange-400 font-bold">ANNUAL TOTAL</div>
              <div className="text-2xl font-black text-white">${yearTotal.toFixed(2)}</div>
            </div>
          </div>
        </div>
        <div className="max-w-7xl mx-auto flex gap-2 mt-4">
          {['equipment', 'logs', 'reports'].map(tab => (
            <button key={tab} onClick={() => setActiveTab(tab)} className={`px-6 py-2 font-black border-2 ${activeTab === tab ? 'bg-orange-600 text-white' : 'bg-zinc-800 text-orange-400'}`}>
              {tab.toUpperCase()}
            </button>
          ))}
        </div>
      </header>

      <main className="max-w-7xl mx-auto p-6">
        {activeTab === 'equipment' && <EquipmentTab machines={machines} onAdd={() => setShowAddMachine(true)} />}
        {activeTab === 'logs' && <LogsTab logs={logs} machines={machines} year={year} onAdd={() => setShowAddLog(true)} />}
        {activeTab === 'reports' && <ReportsTab logs={logs} machines={machines} year={year} />}
      </main>

      {showSettings && <SettingsModal spreadsheetId={spreadsheetId} onClose={() => setShowSettings(false)} />}
      {showAddMachine && <AddMachineModal onClose={() => setShowAddMachine(false)} onSave={() => {}} />}
      {showAddLog && <AddLogModal machines={machines} onClose={() => setShowAddLog(false)} onSave={() => {}} />}
    </div>
  );
};

const EquipmentTab = ({ machines, onAdd }) => (
  <div>
    <div className="flex justify-between mb-4">
      <h2 className="text-2xl font-black text-orange-400">EQUIPMENT ROSTER</h2>
      <button onClick={onAdd} className="bg-orange-600 text-white px-6 py-2 font-black">ADD MACHINE</button>
    </div>
    <div className="grid grid-cols-3 gap-4">
      {machines.map(m => (
        <div key={m.id} className="bg-zinc-800 border-2 border-zinc-700 p-4">
          <h3 className="text-lg font-black">{m.name}</h3>
          <p className="text-sm text-zinc-400">Model: {m.model}</p>
          <p className="text-sm text-zinc-400">SN: {m.serial}</p>
        </div>
      ))}
    </div>
  </div>
);

const LogsTab = ({ logs, machines, year, onAdd }) => (
  <div>
    <div className="flex justify-between mb-4">
      <h2 className="text-2xl font-black text-orange-400">MAINTENANCE LOG</h2>
      <button onClick={onAdd} className="bg-orange-600 text-white px-6 py-2 font-black">ADD ENTRY</button>
    </div>
    <table className="w-full bg-zinc-800 border-2 border-zinc-700">
      <thead className="bg-zinc-900">
        <tr>
          <th className="px-4 py-2 text-left text-orange-400 font-black">DATE</th>
          <th className="px-4 py-2 text-left text-orange-400 font-black">MACHINE</th>
          <th className="px-4 py-2 text-left text-orange-400 font-black">ISSUE</th>
          <th className="px-4 py-2 text-left text-orange-400 font-black">TECH</th>
          <th className="px-4 py-2 text-right text-orange-400 font-black">HOURS</th>
          <th className="px-4 py-2 text-right text-orange-400 font-black">COST</th>
        </tr>
      </thead>
      <tbody>
        {logs.filter(l => new Date(l.date).getFullYear() === year).map(l => {
          const machine = machines.find(m => m.id === l.machineId);
          return (
            <tr key={l.id} className="border-t border-zinc-700">
              <td className="px-4 py-2">{new Date(l.date).toLocaleDateString()}</td>
              <td className="px-4 py-2">{machine?.name || 'Unknown'}</td>
              <td className="px-4 py-2">{l.issue}</td>
              <td className="px-4 py-2">{l.tech}</td>
              <td className="px-4 py-2 text-right">{l.hours}</td>
              <td className="px-4 py-2 text-right text-orange-400 font-bold">${parseFloat(l.cost).toFixed(2)}</td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>
);

const ReportsTab = ({ logs, machines, year }) => {
  const monthlyRef = useRef(null);
  const equipmentRef = useRef(null);

  useEffect(() => {
    if (!monthlyRef.current || !equipmentRef.current) return;

    const monthlyData = Array(12).fill(0);
    logs.filter(l => new Date(l.date).getFullYear() === year).forEach(l => {
      monthlyData[new Date(l.date).getMonth()] += parseFloat(l.cost || 0);
    });

    const monthlyChart = new Chart(monthlyRef.current, {
      type: 'bar',
      data: {
        labels: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'],
        datasets: [{ label: 'Expenses', data: monthlyData, backgroundColor: '#ea580c' }],
      },
      options: { responsive: true, maintainAspectRatio: false },
    });

    const equipmentData = {};
    logs.filter(l => new Date(l.date).getFullYear() === year).forEach(l => {
      const m = machines.find(m => m.id === l.machineId);
      const name = m?.name || 'Unknown';
      equipmentData[name] = (equipmentData[name] || 0) + parseFloat(l.cost || 0);
    });

    const equipmentChart = new Chart(equipmentRef.current, {
      type: 'pie',
      data: {
        labels: Object.keys(equipmentData),
        datasets: [{ data: Object.values(equipmentData), backgroundColor: ['#ea580c','#f97316','#fb923c','#fdba74'] }],
      },
      options: { responsive: true, maintainAspectRatio: false },
    });

    return () => {
      monthlyChart.destroy();
      equipmentChart.destroy();
    };
  }, [logs, year]);

  return (
    <div className="space-y-8">
      <div>
        <h2 className="text-2xl font-black text-orange-400 mb-4">MONTHLY EXPENSES</h2>
        <div className="bg-zinc-800 border-2 border-zinc-700 p-6" style={{height:'400px'}}>
          <canvas ref={monthlyRef}></canvas>
        </div>
      </div>
      <div>
        <h2 className="text-2xl font-black text-orange-400 mb-4">EXPENSES BY EQUIPMENT</h2>
        <div className="bg-zinc-800 border-2 border-zinc-700 p-6" style={{height:'400px'}}>
          <canvas ref={equipmentRef}></canvas>
        </div>
      </div>
    </div>
  );
};

const SettingsModal = ({ spreadsheetId, onClose }) => {
  const [newId, setNewId] = useState('');
  return (
    <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
      <div className="bg-zinc-800 border-4 border-orange-600 max-w-2xl w-full p-6">
        <div className="flex justify-between mb-6">
          <h3 className="text-2xl font-black text-orange-400">SETTINGS</h3>
          <button onClick={onClose} className="text-white">Ã—</button>
        </div>
        <div className="space-y-4">
          <div>
            <label className="block text-xs font-black text-orange-400 mb-2">CURRENT SPREADSHEET ID</label>
            <div className="bg-zinc-900 border-2 border-zinc-700 p-3">
              <code className="text-white text-sm break-all">{spreadsheetId}</code>
            </div>
            <button onClick={() => window.open(`https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`, '_blank')} className="mt-2 bg-zinc-700 text-white px-4 py-2 text-sm font-bold">
              OPEN IN GOOGLE SHEETS
            </button>
          </div>
          <div className="border-t-2 border-zinc-700 pt-4">
            <h4 className="text-lg font-black text-orange-400 mb-2">SYNC WITH ANOTHER DEVICE</h4>
            <p className="text-zinc-400 text-sm mb-4">Copy the ID above and paste it on your other device to sync data.</p>
            <input
              type="text"
              value={newId}
              onChange={e => setNewId(e.target.value)}
              placeholder="Paste spreadsheet ID..."
              className="w-full bg-zinc-900 border-2 border-zinc-700 text-white px-3 py-2 mb-4"
            />
            <button onClick={() => {
              if (newId.trim()) {
                localStorage.setItem('laundromat_spreadsheet_id', newId.trim());
                window.location.reload();
              }
            }} className="bg-orange-600 text-white px-6 py-2 font-black">
              SYNC TO THIS SPREADSHEET
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};

const AddMachineModal = ({ onClose, onSave }) => (
  <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
    <div className="bg-zinc-800 border-4 border-orange-600 max-w-md w-full p-6">
      <h3 className="text-2xl font-black text-orange-400 mb-6">ADD MACHINE</h3>
      <p className="text-zinc-400">Feature coming soon - full implementation available in complete version</p>
      <button onClick={onClose} className="mt-4 bg-zinc-700 text-white px-6 py-2 font-black">CLOSE</button>
    </div>
  </div>
);

const AddLogModal = ({ machines, onClose, onSave }) => (
  <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
    <div className="bg-zinc-800 border-4 border-orange-600 max-w-md w-full p-6">
      <h3 className="text-2xl font-black text-orange-400 mb-6">ADD LOG ENTRY</h3>
      <p className="text-zinc-400">Feature coming soon - includes labor hours and photo uploads in complete version</p>
      <button onClick={onClose} className="mt-4 bg-zinc-700 text-white px-6 py-2 font-black">CLOSE</button>
    </div>
  </div>
);

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
